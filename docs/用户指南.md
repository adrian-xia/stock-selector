# 用户指南

## 目录

- [环境准备](#环境准备)
- [数据导入](#数据导入)
- [选股策略](#选股策略)
- [执行选股](#执行选股)
- [历史回测](#历史回测)
- [定时任务](#定时任务)
- [API 参考](#api-参考)
- [配置说明](#配置说明)

---

## 环境准备

### 1. 安装依赖

```bash
uv sync
```

### 2. 配置环境变量

```bash
cp .env.example .env
```

编辑 `.env`，至少配置数据库连接：

```bash
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/stock_selector
```

如需 AI 分析功能，配置 Gemini API Key：

```bash
GEMINI_API_KEY=your-gemini-api-key
```

### 3. 创建数据库

```bash
# 创建 PostgreSQL 数据库
createdb stock_selector

# 执行迁移（创建 12 张表）
uv run alembic upgrade head
```

---

## 数据导入

系统提供 CLI 工具进行数据管理，所有命令通过 `python -m app.data.cli` 调用。

### 首次全量导入

```bash
# 1. 导入股票列表
uv run python -m app.data.cli import-stocks

# 2. 导入交易日历
uv run python -m app.data.cli import-calendar --start 2020-01-01

# 3. 全量导入日线行情（建议加 --optimize-indexes 加速）
uv run python -m app.data.cli import-daily --start 2020-01-01 --optimize-indexes

# 或一键全量导入
uv run python -m app.data.cli import-all --start 2020-01-01 --optimize-indexes
```

### 每日增量同步

```bash
# 同步当日日线数据（非交易日自动跳过）
uv run python -m app.data.cli sync-daily
```

### 技术指标计算

```bash
# 全量计算所有股票的技术指标
uv run python -m app.data.cli compute-indicators

# 增量计算指定日期的技术指标
uv run python -m app.data.cli update-indicators --date 2026-02-07
```

---

## 选股策略

系统内置 12 种选股策略，分为技术面和基本面两大类。

### 技术面策略（8 种）

| 策略名 | 中文名 | 说明 |
|--------|--------|------|
| `ma-cross` | 均线金叉 | 短期均线上穿长期均线，成交量放大 |
| `macd-golden` | MACD 金叉 | DIF 上穿 DEA |
| `rsi-oversold` | RSI 超卖反弹 | RSI 从超卖区回升 |
| `kdj-golden` | KDJ 金叉 | K 线上穿 D 线，处于超卖区 |
| `boll-breakthrough` | 布林带突破 | 价格触及下轨后反弹 |
| `volume-breakout` | 放量突破 | 量比放大 + 价格突破 |
| `ma-long-arrange` | 均线多头排列 | MA5 > MA10 > MA20 > MA60 |
| `macd-divergence` | MACD 底背离 | 价格新低但 MACD 不创新低 |

### 基本面策略（4 种）

| 策略名 | 中文名 | 说明 |
|--------|--------|------|
| `low-pe-high-roe` | 低估值高盈利 | PE < 30 且 ROE > 15% 且利润增速 > 20% |
| `high-dividend` | 高股息 | 股息率高于阈值 |
| `growth-stock` | 成长股 | 营收和利润高速增长 |
| `financial-safety` | 财务安全 | 低负债率 + 高流动比率 |

### 策略组合

选股时可以同时选择多个策略。Pipeline 采用 OR 逻辑：通过任一策略的股票都会进入候选池，最终按命中策略数排序。

---

## 执行选股

### 通过 API 执行

启动服务后，调用选股接口：

```bash
curl -X POST http://localhost:8000/api/v1/strategy/run \
  -H "Content-Type: application/json" \
  -d '{
    "strategy_names": ["ma-cross", "low-pe-high-roe"],
    "target_date": "2026-02-07",
    "top_n": 30
  }'
```

响应示例：

```json
{
  "target_date": "2026-02-07",
  "total_picks": 25,
  "elapsed_ms": 3200,
  "ai_enabled": true,
  "layer_stats": {
    "layer1": 4000,
    "layer2": 500,
    "layer3": 100,
    "layer4": 25
  },
  "picks": [
    {
      "ts_code": "600519.SH",
      "name": "贵州茅台",
      "close": 1705.20,
      "pct_chg": 1.25,
      "matched_strategies": ["ma-cross", "low-pe-high-roe"],
      "match_count": 2,
      "ai_score": 85,
      "ai_signal": "BUY",
      "ai_summary": "均线多头排列，ROE 持续高位，估值合理"
    }
  ]
}
```

### 通过定时任务自动执行

配置定时任务后，系统会在每个交易日盘后自动执行完整链路（见[定时任务](#定时任务)）。

### AI 分析说明

- 配置了 `GEMINI_API_KEY` 后，Pipeline Layer 5 会自动调用 Gemini Flash 对候选股票进行 AI 评分
- 未配置 API Key 时，AI 层自动跳过，不影响选股流程
- AI 调用失败时静默降级，返回原始排序结果（`ai_score` 为 `null`）
- AI 评分范围 0-100，信号包括：`STRONG_BUY`、`BUY`、`HOLD`、`SELL`、`STRONG_SELL`

---

## 历史回测

### 提交回测

```bash
curl -X POST http://localhost:8000/api/v1/backtest/run \
  -H "Content-Type: application/json" \
  -d '{
    "strategy_name": "ma-cross",
    "stock_codes": ["600519.SH", "000858.SZ"],
    "start_date": "2024-01-01",
    "end_date": "2025-12-31",
    "initial_capital": 1000000
  }'
```

### 查询回测结果

```bash
curl http://localhost:8000/api/v1/backtest/result/{task_id}
```

返回内容包括：
- **绩效指标**：总收益率、年化收益、最大回撤、夏普比率、胜率、盈亏比等
- **交易明细**：每笔买卖的时间、价格、数量、手续费、盈亏
- **净值曲线**：每日组合净值数据点

### 回测特性

- A 股佣金模型：买入万 2.5，卖出万 2.5 + 千 1 印花税，最低 5 元
- 涨跌停限制：主板 10%、创业板/科创板 20%、ST 股 5%
- 滑点控制：默认千 1
- 等权重分配：资金在多只股票间均匀分配

---

## 定时任务

### 自动调度

启动 API 服务后，APScheduler 会自动运行以下定时任务：

| 任务 | 默认时间 | 说明 |
|------|----------|------|
| 盘后链路 | 周一至周五 15:30 | 日线同步 → 技术指标 → 策略筛选 |
| 股票列表同步 | 周六 08:00 | 更新上市/退市状态 |

### 手动触发

```bash
# 触发完整盘后链路
uv run python -m app.scheduler.cli run-chain --date 2026-02-07

# 触发单个步骤
uv run python -m app.scheduler.cli run-job sync-daily --date 2026-02-07
uv run python -m app.scheduler.cli run-job indicators --date 2026-02-07
uv run python -m app.scheduler.cli run-job pipeline --date 2026-02-07
uv run python -m app.scheduler.cli run-job sync-stocks
```

---

## API 参考

### 策略相关

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/api/v1/strategy/run` | 执行选股策略管道 |
| `GET` | `/api/v1/strategy/list` | 获取可用策略列表 |
| `GET` | `/api/v1/strategy/schema/{name}` | 获取策略参数元数据 |

### 回测相关

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/api/v1/backtest/run` | 提交并执行回测 |
| `GET` | `/api/v1/backtest/result/{task_id}` | 查询回测结果 |

### 健康检查

| 方法 | 路径 | 说明 |
|------|------|------|
| `GET` | `/health` | 服务健康检查 |

启动服务后访问 http://localhost:8000/docs 查看完整的交互式 API 文档（Swagger UI）。

---

## 配置说明

所有配置通过 `.env` 文件管理，环境变量优先级高于 `.env` 文件。

### 核心配置

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `DATABASE_URL` | - | PostgreSQL 连接字符串（必填） |
| `APP_ENV` | `development` | 运行环境 |
| `LOG_LEVEL` | `INFO` | 日志级别 |

### AI 配置

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `GEMINI_API_KEY` | `""` | Gemini API Key（为空则禁用 AI） |
| `GEMINI_MODEL_ID` | `gemini-2.0-flash` | 模型标识符 |
| `GEMINI_MAX_TOKENS` | `4000` | 单次最大输出 token |
| `GEMINI_TIMEOUT` | `30` | 请求超时（秒） |
| `GEMINI_MAX_RETRIES` | `2` | 重试次数 |
| `AI_DAILY_BUDGET_USD` | `1.0` | 每日预算上限 |

### 数据源配置

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `TUSHARE_TOKEN` | （必填） | Tushare Pro API Token |

### 调度器配置

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `SCHEDULER_POST_MARKET_CRON` | `30 15 * * 1-5` | 盘后链路 cron |
| `SCHEDULER_STOCK_SYNC_CRON` | `0 8 * * 6` | 股票列表同步 cron |

完整配置项见 [.env.example](.env.example)。
