# 详细设计 — 量价综合选股策略

> 版本：v1.0
> 日期：2026-02-26
> 状态：PRD（待实施）

## 1. 背景与目标

### 1.1 背景

系统当前已实现 4 种量价相关策略：

| 策略 | 核心逻辑 | 局限性 |
|------|---------|--------|
| 放量突破 (`volume-breakout`) | 价格创新高 + 量比 ≥ 2.0 | 仅覆盖"放量+新高"单一场景 |
| 缩量回调 (`volume-contraction-pullback`) | 上升趋势中缩量回踩 MA20 | 仅关注 MA20 支撑，无回调深度判断 |
| 量价背离 (`volume-price-divergence`) | 价格接近低点但量缩 | 仅覆盖底部背离，无企稳确认 |
| OBV 突破 (`obv-breakthrough`) | OBV 突破 + 价格上涨确认 | 单一指标，缺乏量价形态组合 |

经过对实战量价分析体系的系统梳理（参见 `docs/strategy/` 目录），发现以下量价规律尚未被现有策略覆盖：

- **缩量上涨**（口诀三）：筹码锁定良好的趋势延续信号
- **量缩价稳**（买卖五原则）：抛压耗尽的底部企稳信号
- **首阴反包**（买在分歧）：强势股分歧后多头重新占优
- **地量见底**（量缩到极致）：极端缩量的阶段性底部信号
- **后量超前量**（口诀八）：资金加速流入的趋势加速信号
- **回调半分位**（回档不超 1/2）：多头力量仍强的精确回调判断

### 1.2 目标

新增 6 个量价策略，与已有 4 个互补，形成完整的量价分析策略矩阵（共 10 个）。所有策略均支持参数优化。

### 1.3 量价策略矩阵

```
                    放量                          缩量
            ┌─────────────────┐        ┌─────────────────┐
   上涨     │ 放量突破(已有)    │        │ 缩量上涨(新增)    │
            │ 后量超前量(新增)  │        │                   │
            └─────────────────┘        └─────────────────┘
   下跌     │ 量价背离(已有)    │        │ 地量见底(新增)     │
            │                   │        │ 量缩价稳(新增)     │
            └─────────────────┘        └─────────────────┘
   回调     │ 首阴反包(新增)    │        │ 缩量回调(已有)     │
            │                   │        │ 回调半分位(新增)   │
            └─────────────────┘        └─────────────────┘
   趋势     │ OBV突破(已有)     │
            └─────────────────┘
```

---

## 2. 策略详细定义

### 2.1 缩量上涨 (`shrink-volume-rise`)

**对应知识点：** 量价关系口诀三 — "缩量上涨，还会上涨"

**市场含义：** 股价上涨但成交量持续萎缩，说明持股者惜售、筹码锁定良好，主力正在默默抬升股价，上涨趋势大概率延续。

**信号条件：**

| # | 条件 | 字段 | 默认阈值 |
|---|------|------|---------|
| 1 | 上升趋势 | close > ma20 且 ma5 > ma20 | — |
| 2 | 当日收阳 | close > open | — |
| 3 | 涨幅达标 | pct_chg ≥ min_pct_chg | 0.5% |
| 4 | 成交量萎缩 | vol_ratio < max_vol_ratio | 0.8 |
| 5 | 排除停牌 | vol > 0 | — |

**参数空间：**

| 参数 | 类型 | 默认值 | 范围 | 步长 | 说明 |
|------|------|--------|------|------|------|
| `max_vol_ratio` | float | 0.8 | 0.4 ~ 1.0 | 0.1 | 量比上限，低于此值视为缩量 |
| `min_pct_chg` | float | 0.5 | 0.0 ~ 2.0 | 0.5 | 最小涨幅 %，排除微涨 |

**参数组合数：** 7 × 5 = 35

---

### 2.2 量缩价稳 (`volume-price-stable`)

**对应知识点：** 成交量买卖五原则 — "量缩价稳买入"

**市场含义：** 经过一段下跌或调整后，成交量大幅萎缩但价格不再下跌，横盘企稳，说明抛压耗尽，是底部信号。

**信号条件：**

| # | 条件 | 字段 | 默认阈值 |
|---|------|------|---------|
| 1 | 成交量萎缩 | vol_ratio < max_vol_ratio | 0.5 |
| 2 | 价格企稳 | abs(pct_chg) < max_pct_chg | 2.0% |
| 3 | 经历过调整 | close ≤ ma20 × ma_position | 1.02 |
| 4 | 非跌停 | pct_chg > -9.5 | — |
| 5 | 排除停牌 | vol > 0 | — |

**参数空间：**

| 参数 | 类型 | 默认值 | 范围 | 步长 | 说明 |
|------|------|--------|------|------|------|
| `max_vol_ratio` | float | 0.5 | 0.3 ~ 0.8 | 0.1 | 量比上限 |
| `max_pct_chg` | float | 2.0 | 1.0 ~ 3.0 | 0.5 | 涨跌幅绝对值上限 % |
| `ma_position` | float | 1.02 | 0.98 ~ 1.05 | 0.01 | 价格相对 MA20 的上限倍数 |

**参数组合数：** 6 × 5 × 8 = 240

---

### 2.3 首阴反包 (`first-negative-reversal`)

**对应知识点：** 六条铁律 — "买在分歧，卖在一致"

**市场含义：** 强势上涨后出现第一根阴线（市场分歧），次日阳线反包（多头重新占优），是经典的短线买入模式。强势股一旦有人卖出，会有更多人买入，往往还能继续上涨。

**信号条件：**

| # | 条件 | 字段 | 默认阈值 |
|---|------|------|---------|
| 1 | 上升趋势 | ma5 > ma20 且 ma20 > 0 | — |
| 2 | 前日收阴（近似） | close_prev < open（前日收盘低于今日开盘） | — |
| 3 | 今日阳线 | close > open 且 pct_chg ≥ min_pct_chg | 2.0% |
| 4 | 反包确认 | close > close_prev | — |
| 5 | 量能配合 | vol_ratio ≥ min_vol_ratio | 1.2 |
| 6 | 排除停牌 | vol > 0 | — |

**前置依赖：** 需要 snapshot 扩展 `open_prev`、`pct_chg_prev` 字段。

**参数空间：**

| 参数 | 类型 | 默认值 | 范围 | 步长 | 说明 |
|------|------|--------|------|------|------|
| `min_pct_chg` | float | 2.0 | 1.0 ~ 5.0 | 0.5 | 今日最小涨幅 % |
| `min_vol_ratio` | float | 1.2 | 0.8 ~ 2.5 | 0.1 | 反包最小量比 |

**参数组合数：** 9 × 18 = 162

---

### 2.4 地量见底 (`extreme-shrink-bottom`)

**对应知识点：** 成交量买卖五原则 — "量缩到极致买入"

**市场含义：** 成交量萎缩到极端水平，说明市场交投极度冷清，卖盘已经枯竭，往往是阶段性底部。"地量之后见地价"是 A 股经典规律。

**信号条件：**

| # | 条件 | 字段 | 默认阈值 |
|---|------|------|---------|
| 1 | 极端缩量 | vol_ratio < extreme_ratio | 0.3 |
| 2 | 换手率极低 | turnover_rate < max_turnover | 1.0% |
| 3 | 非一字板 | high > low | — |
| 4 | 排除停牌 | vol > 0 | — |

**参数空间：**

| 参数 | 类型 | 默认值 | 范围 | 步长 | 说明 |
|------|------|--------|------|------|------|
| `extreme_ratio` | float | 0.3 | 0.1 ~ 0.5 | 0.05 | 极端量比阈值 |
| `max_turnover` | float | 1.0 | 0.5 ~ 2.0 | 0.5 | 换手率上限 % |

**参数组合数：** 9 × 4 = 36

---

### 2.5 后量超前量 (`volume-surge-continuation`)

**对应知识点：** 量价关系口诀八 — "后量超前量，后市要跟上"

**市场含义：** 成交量接连创新高代表资金在不断进场，行情短期不会结束，大概率接连上涨。短期均量持续超越长期均量，是量能加速的趋势延续信号。

**与放量突破的区别：** `volume-breakout` 只看单日放量+价格创新高；本策略关注"量能递增趋势"（vol_ma5 > vol_ma10），是更持续的资金流入判断。

**信号条件：**

| # | 条件 | 字段 | 默认阈值 |
|---|------|------|---------|
| 1 | 今日放量 | vol_ratio ≥ surge_ratio | 2.0 |
| 2 | 后量超前量 | vol_ma5 / vol_ma10 ≥ vol_ma_ratio | 1.2 |
| 3 | 价格上涨 | pct_chg ≥ min_pct_chg | 1.0% |
| 4 | 上升趋势 | close > ma20 且 ma20 > 0 | — |
| 5 | 排除停牌 | vol > 0 | — |

**参数空间：**

| 参数 | 类型 | 默认值 | 范围 | 步长 | 说明 |
|------|------|--------|------|------|------|
| `surge_ratio` | float | 2.0 | 1.5 ~ 4.0 | 0.5 | 量比阈值（相对 5 日均量） |
| `vol_ma_ratio` | float | 1.2 | 1.0 ~ 2.0 | 0.1 | vol_ma5/vol_ma10 最小比值 |
| `min_pct_chg` | float | 1.0 | 0.0 ~ 3.0 | 0.5 | 最小涨幅 % |

**参数组合数：** 6 × 11 × 7 = 462

---

### 2.6 回调半分位 (`pullback-half-rule`)

**对应知识点：** 量价选股核心 — "回档不超 1/2"

**市场含义：** 一波上涨后回调，回调幅度不超过涨幅的一半，说明多头力量仍然强劲。配合缩量回调，是高胜率的买入时机。

**与缩量回调的区别：** `volume-contraction-pullback` 只看是否回调到 MA20 附近；本策略关注回调深度与前期涨幅的比例关系（半分位法则），是更精确的回调判断。

**信号条件：**

| # | 条件 | 字段 | 默认阈值 |
|---|------|------|---------|
| 1 | 多头排列 | ma5 > ma20 > ma60 且 ma60 > 0 | — |
| 2 | 当日小幅回调 | -max_pullback_pct < pct_chg < 0 | 3.0% |
| 3 | 未跌破 MA20 | close > ma20 | — |
| 4 | 回调不超半分位 | close > (ma5 + ma20) / 2 | — |
| 5 | 缩量配合 | vol_ratio < max_vol_ratio | 0.8 |
| 6 | 排除停牌 | vol > 0 | — |

**参数空间：**

| 参数 | 类型 | 默认值 | 范围 | 步长 | 说明 |
|------|------|--------|------|------|------|
| `max_vol_ratio` | float | 0.8 | 0.4 ~ 1.2 | 0.1 | 回调时量比上限 |
| `max_pullback_pct` | float | 3.0 | 1.0 ~ 5.0 | 0.5 | 最大回调幅度 % |

**参数组合数：** 9 × 9 = 81

---

## 3. 数据依赖

### 3.1 已有字段（无需修改）

| 字段 | 来源表 | 说明 |
|------|--------|------|
| `close`, `open`, `high`, `low`, `vol`, `amount` | stock_daily | 基础行情 |
| `pct_chg`, `turnover_rate` | stock_daily | 涨跌幅、换手率 |
| `ma5`, `ma10`, `ma20`, `ma60` | technical_daily | 均线 |
| `vol_ma5`, `vol_ma10`, `vol_ratio` | technical_daily | 成交量指标 |
| `close_prev` | snapshot prev_sql | 前日收盘价 |

### 3.2 需扩展字段

| 字段 | 来源 | 用途 | 涉及策略 |
|------|------|------|---------|
| `open_prev` | snapshot prev_sql 新增 | 判断前日阴线 | 首阴反包 |
| `pct_chg_prev` | snapshot prev_sql 新增 | 前日涨跌幅 | 首阴反包 |

**修改位置：** `app/strategy/pipeline.py` → `_build_market_snapshot()` 的 prev_sql。

### 3.3 不依赖扩展字段的策略（可立即实施）

- 缩量上涨、量缩价稳、地量见底、后量超前量、回调半分位（5 个）

### 3.4 依赖扩展字段的策略

- 首阴反包（1 个，依赖 `open_prev`）

---

## 4. 实施计划

### 4.1 优先级

| 优先级 | 任务 | 说明 |
|--------|------|------|
| P0 | 扩展 snapshot SQL | 前置依赖，也修复已有策略的降级问题 |
| P1 | 缩量上涨、量缩价稳、地量见底 | 逻辑简单，字段已可用 |
| P2 | 后量超前量、回调半分位 | 中等复杂度 |
| P3 | 首阴反包 | 依赖 snapshot 扩展 |

### 4.2 涉及文件

| 文件 | 操作 |
|------|------|
| `app/strategy/pipeline.py` | 修改 snapshot SQL |
| `app/strategy/technical/shrink_volume_rise.py` | 新建 |
| `app/strategy/technical/volume_price_stable.py` | 新建 |
| `app/strategy/technical/first_negative_reversal.py` | 新建 |
| `app/strategy/technical/extreme_shrink_bottom.py` | 新建 |
| `app/strategy/technical/volume_surge_continuation.py` | 新建 |
| `app/strategy/technical/pullback_half_rule.py` | 新建 |
| `app/strategy/factory.py` | 注册 6 个策略 |

### 4.3 验收标准

- 策略总数从 28 增至 34（22 技术面 + 12 基本面）
- 所有策略通过 `GET /api/v1/strategy/list` 返回
- 所有策略的 `param_space` 正确定义，支持参数优化
- 单元测试覆盖每个策略的信号生成逻辑

---

## 5. 知识来源

本策略设计基于以下实战量价分析体系（详见 `docs/strategy/` 目录）：

| 文档 | 提取的策略 |
|------|-----------|
| `01-炒股六条铁律.md` | 首阴反包（买在分歧）、均线趋势判断 |
| `03-成交量分析与选股.md` | 量缩价稳、地量见底、回调半分位 |
| `04-量价关系八大口诀.md` | 缩量上涨（口诀3）、后量超前量（口诀8） |
