# 14-ç³»ç»Ÿè®¾è®¡ï¼šV4 é‡ä»·é…åˆç­–ç•¥ç‹¬ç«‹ä¼˜åŒ–ä»»åŠ¡

> **ç‰ˆæœ¬ï¼š** v1.1
> **æ—¥æœŸï¼š** 2026-03-01
> **å…³è”ï¼š** 12-Pipelineç¼“å­˜ä¼˜åŒ–.mdã€v4_planning/02-V4è¯¦ç»†è®¾è®¡-å›æµ‹ä¸å‚æ•°è°ƒä¼˜.md

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 é—®é¢˜

V4 é‡ä»·é…åˆç­–ç•¥ï¼ˆvolume-price-patternï¼‰ä¸å…¶ä»– 34 ä¸ªç­–ç•¥çš„ä¼˜åŒ–æ–¹å¼æ ¹æœ¬ä¸åŒï¼š

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿç­–ç•¥ï¼ˆ34ä¸ªï¼‰ | V4 é‡ä»·é…åˆ |
|--------|-----------------|-------------|
| ä¿¡å·äº§ç”Ÿ | å•æ—¥ filter_batch å³å‡ºç»“æœ | éœ€è¦å¤šæ—¥çŠ¶æ€è¿½è¸ªï¼ˆT0â†’å›è¸©â†’Tkä¼ç¨³ï¼‰ |
| è¯„ä¼°æ–¹å¼ | ç¦»æ•£é‡‡æ ·æ—¥ï¼Œæ¯æ—¥ç‹¬ç«‹è¯„ä¼° | å¿…é¡»è¿ç»­æ—¥å›æ”¾ï¼Œç»´æŠ¤è§‚å¯Ÿæ± çŠ¶æ€ |
| ä¼˜åŒ–å™¨ | MarketOptimizerï¼ˆé‡‡æ ·å›æ”¾ï¼‰ | éœ€è¦ V4 ä¸“ç”¨å›æµ‹å¼•æ“ï¼ˆé€æ—¥æ¨¡æ‹Ÿï¼‰ |
| æ•°æ®ä¾èµ– | Pipeline Layer 1-3 | è§‚å¯Ÿæ±  + å¸ç­¹éªŒè¯ + å‡çº¿æ”¯æ’‘ |

ç°æœ‰ `weekly_market_opt_job` æ— æ³•ç›´æ¥å¤„ç† V4ï¼Œå¼ºè¡Œå¡å…¥ä¼šå¯¼è‡´æ¶æ„æ··ä¹±ã€‚

### 1.2 ç›®æ ‡

ä¸º V4 åˆ›å»ºç‹¬ç«‹çš„å®šæ—¶ä¼˜åŒ–ä»»åŠ¡ï¼Œä¸ç°æœ‰å…¨å¸‚åœºä¼˜åŒ–å¹¶è¡Œè°ƒåº¦ï¼Œå¤ç”¨å·²æœ‰çš„ V4 å›æµ‹å¼•æ“ã€‚

---

## 2. æ•´ä½“æ¶æ„

```
è°ƒåº¦å™¨ (APScheduler)
â”œâ”€â”€ weekly_market_opt_job      â† ç°æœ‰ï¼š34 ä¸ªä¼ ç»Ÿç­–ç•¥ï¼ˆå‘¨å…­ 10:00ï¼‰
â”œâ”€â”€ weekly_v4_opt_job          â† æ–°å¢ï¼šV4 é‡ä»·é…åˆç­–ç•¥ï¼ˆå‘¨å…­ 12:00ï¼‰
â”‚   â”œâ”€â”€ è¯»å–å‚æ•°ç©ºé—´
â”‚   â”œâ”€â”€ è°ƒç”¨ V4 ç½‘æ ¼æœç´¢å¼•æ“ï¼ˆrun_grid_searchï¼‰
â”‚   â”œâ”€â”€ ç»“æœå†™å…¥ v4_backtest_results è¡¨
â”‚   â”œâ”€â”€ æœ€ä½³å‚æ•°è‡ªåŠ¨åº”ç”¨åˆ° strategies è¡¨
â”‚   â””â”€â”€ å‘é€ Telegram é€šçŸ¥
â””â”€â”€ auto_update_job            â† ç°æœ‰ï¼šç›˜åæ•°æ®æ›´æ–°
```

### 2.1 æ ¸å¿ƒåŸåˆ™

- **ç‹¬ç«‹è°ƒåº¦**ï¼šV4 ä¼˜åŒ–ä»»åŠ¡æœ‰è‡ªå·±çš„ cron è¡¨è¾¾å¼ã€å¼€å…³ã€é…ç½®é¡¹
- **å¤ç”¨å¼•æ“**ï¼šç›´æ¥è°ƒç”¨ `app/v4backtest/grid_search.py` çš„ `run_grid_search()`
- **ç»“æœéš”ç¦»**ï¼šV4 ç»“æœå†™å…¥ `v4_backtest_results` è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰ï¼Œä¸æ··å…¥ `market_optimization_tasks`
- **ç»Ÿä¸€é€šçŸ¥**ï¼šå¤ç”¨ç°æœ‰ Telegram é€šçŸ¥æœºåˆ¶

---

## 3. è¯¦ç»†è®¾è®¡

### 3.1 æ–°å¢é…ç½®é¡¹ï¼ˆapp/config.pyï¼‰

```python
# V4 é‡ä»·é…åˆç­–ç•¥ç‹¬ç«‹ä¼˜åŒ–
v4_opt_enabled: bool = True                          # æ˜¯å¦å¯ç”¨
v4_opt_cron: str = "0 12 * * 6"                      # é»˜è®¤å‘¨å…­ 12:00ï¼ˆåœ¨ä¼ ç»Ÿä¼˜åŒ–ä¹‹åï¼‰
v4_opt_lookback_start: str = "2024-07-01"            # å›æµ‹èµ·å§‹æ—¥æœŸ
v4_opt_lookback_end: str = ""                        # å›æµ‹ç»“æŸæ—¥æœŸï¼ˆç©º=æœ€è¿‘äº¤æ˜“æ—¥ï¼‰
v4_opt_max_concurrency: int = 4                      # æœ€å¤§å¹¶å‘åº¦
v4_opt_auto_apply: bool = True                       # è‡ªåŠ¨åº”ç”¨æœ€ä½³å‚æ•°
```

### 3.2 å‚æ•°ç©ºé—´ï¼ˆä¸¤é˜¶æ®µç­–ç•¥ï¼‰

å½“å‰æ³¨å†Œçš„ param_space æœ‰ 8 ä¸ªå‚æ•°ï¼Œ3^8 = 6561 ç»„åˆï¼Œå…¨é‡æœç´¢çº¦éœ€ 30-60 åˆ†é’Ÿã€‚

**é˜¶æ®µä¸€ï¼ˆé»˜è®¤ï¼‰ï¼šæ ¸å¿ƒ 4 å‚æ•°ï¼Œ81 ç»„åˆ**

```python
V4_OPT_PARAM_GRID = {
    "min_t0_pct_chg":       [5.0, 6.0, 7.0],
    "min_washout_days":     [2, 3, 4],
    "max_vol_shrink_ratio": [0.30, 0.40, 0.50],
    "ma_support_tolerance": [0.010, 0.015, 0.020],
}
# å…¶ä½™å‚æ•°ä½¿ç”¨ DEFAULT_PARAMS å›ºå®šå€¼
```

é¢„ä¼°è€—æ—¶ï¼š81 ç»„åˆ Ã— ~40s/ç»„ Ã· 4 å¹¶å‘ â‰ˆ 14 åˆ†é’Ÿ

**é˜¶æ®µäºŒï¼ˆå¯é€‰ï¼‰ï¼šå…¨é‡ 8 å‚æ•°ï¼Œ6561 ç»„åˆ**

é€šè¿‡ API æ‰‹åŠ¨è§¦å‘ï¼Œæˆ–é…ç½® `v4_opt_param_grid` è¦†ç›–ã€‚

### 3.3 æ–°å¢æ–‡ä»¶ï¼š`app/scheduler/v4_opt_job.py`

```python
"""V4 é‡ä»·é…åˆç­–ç•¥ç‹¬ç«‹ä¼˜åŒ–ä»»åŠ¡ã€‚

ä¸ weekly_market_opt_job å¹¶è¡Œè°ƒåº¦ï¼Œä½¿ç”¨ V4 ä¸“ç”¨å›æµ‹å¼•æ“ï¼ˆé€æ—¥æ¨¡æ‹Ÿ + å†…å­˜è§‚å¯Ÿæ± ï¼‰ã€‚
"""

async def weekly_v4_opt_job() -> None:
    """
    æµç¨‹ï¼š
    1. æ£€æŸ¥å¼€å…³ settings.v4_opt_enabled
    2. ç¡®å®šå›æµ‹æ—¥æœŸèŒƒå›´ï¼ˆlookback_start ~ lookback_end æˆ–æœ€è¿‘äº¤æ˜“æ—¥ï¼‰
    3. è°ƒç”¨ run_grid_search() æ‰§è¡Œç½‘æ ¼æœç´¢
    4. ç»“æœå†™å…¥ v4_backtest_results è¡¨ï¼ˆis_grid_search=True, grid_search_id=æ‰¹æ¬¡IDï¼‰
    5. æœ€ä½³å‚æ•°å†™å…¥ strategies.paramsï¼ˆauto_apply=True æ—¶ï¼‰
    6. å‘é€ Telegram é€šçŸ¥ï¼ˆæ‘˜è¦ + Markdown æŠ¥å‘Šï¼‰
    """
```

æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç ï¼š

```python
async def weekly_v4_opt_job() -> None:
    if not settings.v4_opt_enabled:
        return

    # 1. ç¡®å®šæ—¥æœŸèŒƒå›´
    start_date = date.fromisoformat(settings.v4_opt_lookback_start)
    end_date = await _get_latest_trade_date() if not settings.v4_opt_lookback_end \
               else date.fromisoformat(settings.v4_opt_lookback_end)

    # 2. æ‰§è¡Œç½‘æ ¼æœç´¢
    grid_search_id = str(uuid4())
    results = await run_grid_search(
        session_factory=async_session_factory,
        start_date=start_date,
        end_date=end_date,
        param_grid=V4_OPT_PARAM_GRID,
        max_concurrency=settings.v4_opt_max_concurrency,
    )

    # 3. æ‰¹é‡å†™å…¥ v4_backtest_results
    async with async_session_factory() as session:
        for rank, r in enumerate(results, 1):
            await session.execute(INSERT_SQL, {
                "run_id": str(uuid4()),
                "grid_search_id": grid_search_id,
                "rank_in_grid": rank,
                "is_grid_search": True,
                "params": r.params,
                "backtest_start": start_date,
                "backtest_end": end_date,
                # ... metrics å­—æ®µ
            })

        # 4. è‡ªåŠ¨åº”ç”¨æœ€ä½³å‚æ•°
        if settings.v4_opt_auto_apply and results:
            best = results[0]
            merged_params = {**DEFAULT_PARAMS, **best.params}
            await session.execute(
                "UPDATE strategies SET params=:p WHERE name='volume-price-pattern'",
                {"p": json.dumps(merged_params)},
            )

        await session.commit()

    # 5. Telegram é€šçŸ¥
    await _send_v4_opt_report(results, grid_search_id, start_date, end_date)
```

### 3.4 è°ƒåº¦å™¨æ³¨å†Œï¼ˆapp/scheduler/core.pyï¼‰

åœ¨ `register_jobs()` ä¸­æ–°å¢ï¼š

```python
from app.scheduler.v4_opt_job import weekly_v4_opt_job

if settings.v4_opt_enabled:
    v4_cron = settings.v4_opt_cron
    parts = v4_cron.split()
    scheduler.add_job(
        func=weekly_v4_opt_job,
        trigger=CronTrigger(
            minute=parts[0], hour=parts[1], day=parts[2],
            month=parts[3], day_of_week=parts[4],
            timezone="Asia/Shanghai",
        ),
        id="weekly_v4_optimization",
        name="V4é‡ä»·é…åˆç­–ç•¥ä¼˜åŒ–",
        replace_existing=True,
    )
```

### 3.5 API ç«¯ç‚¹ï¼ˆapp/v4backtest/router.py æ‰©å±•ï¼‰

æ–°å¢æ‰‹åŠ¨è§¦å‘ç«¯ç‚¹ï¼š

```python
@router.post("/optimize")
async def run_v4_optimization(req: V4OptRequest):
    """æ‰‹åŠ¨è§¦å‘ V4 å‚æ•°ä¼˜åŒ–ã€‚"""
    # åå°æ‰§è¡Œ weekly_v4_opt_job çš„æ ¸å¿ƒé€»è¾‘
    # æ”¯æŒè‡ªå®šä¹‰ param_gridã€æ—¥æœŸèŒƒå›´
    asyncio.create_task(_run_v4_opt(...))
    return {"grid_search_id": grid_search_id, "status": "running"}

@router.get("/optimize/latest")
async def get_latest_v4_opt():
    """æŸ¥è¯¢æœ€è¿‘ä¸€æ¬¡ V4 ä¼˜åŒ–ç»“æœã€‚"""
    # ä» v4_backtest_results æŸ¥ is_grid_search=True çš„æœ€æ–°æ‰¹æ¬¡
```

### 3.6 Telegram æŠ¥å‘Šæ ¼å¼

```markdown
# ğŸ‰ V4 é‡ä»·é…åˆç­–ç•¥ â€” æ¯å‘¨å‚æ•°ä¼˜åŒ–æŠ¥å‘Š

**å›æµ‹åŒºé—´ï¼š** 2024-07-01 ~ 2026-02-28
**å‚æ•°ç»„åˆï¼š** 81 ç»„ | **è€—æ—¶ï¼š** 14 åˆ†é’Ÿ

## ğŸ† Top 5 å‚æ•°ç»„åˆ

| æ’å | min_t0_pct_chg | min_washout_days | max_vol_shrink | ma_tolerance | èƒœç‡(5d) | ç›ˆäºæ¯” | å¤æ™® | ç»¼åˆå¾—åˆ† |
|------|---------------|-----------------|---------------|-------------|---------|-------|------|---------|
| 1    | 6.0           | 3               | 0.40          | 0.015       | 59.2%   | 1.87  | 2.21 | 0.74   |
| 2    | 6.0           | 3               | 0.30          | 0.015       | 57.8%   | 1.92  | 2.05 | 0.72   |
| ...  |               |                 |               |             |         |       |      |        |

## ğŸ“Š æœ€ä½³å‚æ•°å·²è‡ªåŠ¨åº”ç”¨ âœ…

{merged_params JSON}

## ğŸ“ˆ ä¿¡å·ç»Ÿè®¡
- æ€»ä¿¡å·æ•°ï¼š312 | æœˆå‡ï¼š8.7
- 5æ—¥èƒœç‡ï¼š59.2% | 10æ—¥èƒœç‡ï¼š62.1%
- æœ€å¤§å›æ’¤ï¼š8.2%
```

---

## 4. æ”¹åŠ¨æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `app/config.py` | ä¿®æ”¹ | æ–°å¢ v4_opt_* é…ç½®é¡¹ï¼ˆ6ä¸ªï¼‰ |
| `app/scheduler/v4_opt_job.py` | æ–°å¢ | V4 ç‹¬ç«‹ä¼˜åŒ–ä»»åŠ¡ä¸»ä½“ |
| `app/scheduler/core.py` | ä¿®æ”¹ | register_jobs ä¸­æ³¨å†Œ V4 ä¼˜åŒ–ä»»åŠ¡ |
| `app/v4backtest/router.py` | ä¿®æ”¹ | æ–°å¢ /optimize å’Œ /optimize/latest ç«¯ç‚¹ |
| `app/scheduler/report.py` | ä¿®æ”¹ | æ–°å¢ generate_v4_opt_report() |

### ä¸éœ€è¦æ”¹åŠ¨çš„æ–‡ä»¶

- `app/v4backtest/engine.py` â€” å›æµ‹å¼•æ“å·²å®Œå¤‡ï¼Œç›´æ¥å¤ç”¨
- `app/v4backtest/grid_search.py` â€” ç½‘æ ¼æœç´¢å·²å®Œå¤‡ï¼Œç›´æ¥å¤ç”¨
- `app/v4backtest/evaluator.py` â€” è¯„ä¼°å™¨å·²å®Œå¤‡ï¼Œç›´æ¥å¤ç”¨
- `app/optimization/market_optimizer.py` â€” ä¼ ç»Ÿä¼˜åŒ–å™¨ä¸å—å½±å“
- `app/scheduler/market_opt_job.py` â€” ä¼ ç»Ÿä¼˜åŒ–ä»»åŠ¡ä¸å—å½±å“

---

## 5. æ•°æ®æµ

```
weekly_v4_opt_job
    â”‚
    â”œâ”€â†’ run_grid_search()           [v4backtest/grid_search.py]
    â”‚       â”‚
    â”‚       â”œâ”€â†’ run_backtest()      [v4backtest/engine.py]
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â†’ _fetch_daily_batch()     è¯» stock_daily + technical_daily
    â”‚       â”‚       â”œâ”€â†’ _verify_accumulation()   è¯» stock_dailyï¼ˆå¸ç­¹éªŒè¯ï¼‰
    â”‚       â”‚       â”œâ”€â†’ evaluate_market()         è¯» index_dailyï¼ˆå¤§ç›˜ç¯å¢ƒï¼‰
    â”‚       â”‚       â””â”€â†’ å†…å­˜ _WatchEntry dict    ä¸ç¢° strategy_watchpool è¡¨
    â”‚       â”‚
    â”‚       â”œâ”€â†’ fill_returns()      [v4backtest/grid_search.py]
    â”‚       â”‚       â””â”€â†’ è¯» stock_dailyï¼ˆT+1/3/5/10 æ”¶ç›˜ä»·ï¼‰
    â”‚       â”‚
    â”‚       â””â”€â†’ evaluate_signals()  [v4backtest/evaluator.py]
    â”‚
    â”œâ”€â†’ å†™å…¥ v4_backtest_results è¡¨
    â”œâ”€â†’ æ›´æ–° strategies.paramsï¼ˆauto_applyï¼‰
    â””â”€â†’ Telegram é€šçŸ¥
```

---

## 6. è°ƒåº¦æ—¶åº

```
å‘¨å…­ 10:00  weekly_market_opt_job    ä¼ ç»Ÿ 18 ç­–ç•¥ä¼˜åŒ–ï¼ˆ~17 åˆ†é’Ÿï¼‰
å‘¨å…­ 12:00  weekly_v4_opt_job        V4 é‡ä»·é…åˆä¼˜åŒ–ï¼ˆ~14 åˆ†é’Ÿï¼‰
```

ä¸¤ä¸ªä»»åŠ¡é”™å¼€ 2 å°æ—¶ï¼Œé¿å…æ•°æ®åº“è¿æ¥ç«äº‰ã€‚

---

## 7. æ€§èƒ½é¢„ä¼°

| åœºæ™¯ | ç»„åˆæ•° | å¹¶å‘åº¦ | é¢„ä¼°è€—æ—¶ |
|------|--------|--------|---------|
| é˜¶æ®µä¸€ï¼ˆ4å‚æ•°ï¼‰ | 81 | 4 | ~14 åˆ†é’Ÿ |
| é˜¶æ®µäºŒï¼ˆ8å‚æ•°ï¼‰ | 6561 | 4 | ~60-90 åˆ†é’Ÿ |
| å•æ¬¡å›æµ‹ï¼ˆ1.5å¹´ï¼‰ | 1 | - | ~40 ç§’ |

ç“¶é¢ˆåœ¨äºæ¯ç»„å‚æ•°éœ€è¦é€æ—¥éå† ~375 ä¸ªäº¤æ˜“æ—¥ï¼Œæ¯æ—¥æ‰§è¡Œå…¨å¸‚åœº SQL æŸ¥è¯¢ã€‚
å·²æœ‰çš„å†…å­˜è§‚å¯Ÿæ± è®¾è®¡é¿å…äº†æ•°æ®åº“å†™å…¥å¼€é”€ã€‚

---

## 8. å›æµ‹å¼•æ“æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 8.1 ç°çŠ¶åˆ†æ

å½“å‰å›æµ‹å¼•æ“çš„ç“¶é¢ˆåœ¨äº SQL IOï¼Œè€Œé Python è®¡ç®—ï¼š

| ç“¶é¢ˆ | åŸå›  | å½±å“ |
|------|------|------|
| å…¨å¸‚åœºè¡Œæƒ…é‡å¤æŸ¥è¯¢ | 81 ç»„å‚æ•° Ã— 402 å¤© = 32,562 æ¬¡ç›¸åŒ SQL | å æ€»è€—æ—¶ ~60% |
| T0 äº‹ä»¶é‡å¤è®¡ç®— | å‰ç«¯å‚æ•°ç›¸åŒæ—¶ T0 ç»“æœä¸€è‡´ï¼Œä½†æ¯ç»„éƒ½é‡æ–°ç®— | å æ€»è€—æ—¶ ~15% |
| å¸ç­¹éªŒè¯é‡å¤æŸ¥è¯¢ | åŒä¸€å¤©åŒä¸€åªè‚¡ç¥¨çš„å¸ç­¹éªŒè¯è¢«å¤šæ¬¡æ‰§è¡Œ | å æ€»è€—æ—¶ ~10% |
| æ”¶ç›Šè®¡ç®—é€æ¡æŸ¥è¯¢ | æ¯ä¸ªä¿¡å·å•ç‹¬ SQL æŸ¥åç»­æ”¶ç›˜ä»· | å æ€»è€—æ—¶ ~15% |

è§‚å¯Ÿæ± çŠ¶æ€æœºï¼ˆå†…å­˜ dict éå†ï¼‰ä¸æ˜¯ç“¶é¢ˆï¼Œæ¯æ—¥éå† 10-100 ä¸ª entryï¼Œè€—æ—¶ <1msã€‚

### 8.2 ä¼˜åŒ–æ–¹æ¡ˆï¼šæ•°æ®é¢„åŠ è½½ + T0 é¢„è®¡ç®—

ä¸å¼•å…¥æ–°ä¾èµ–ï¼ˆä¸éœ€è¦ polars/vectorbt/numbaï¼‰ï¼Œåªæ”¹åŠ¨æ•°æ®åŠ è½½å±‚ã€‚

#### ä¼˜åŒ–ä¸€ï¼šå…¨å¸‚åœºè¡Œæƒ…é¢„åŠ è½½åˆ°å†…å­˜

å›æµ‹å¼€å§‹å‰ï¼Œä¸€æ¬¡æ€§æŠŠæ•´ä¸ªå›æµ‹åŒºé—´çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ DataFrameï¼š

```python
# grid_search.py æ–°å¢é¢„åŠ è½½é€»è¾‘
async def _preload_market_data(
    session, start_date, end_date
) -> dict[date, dict[str, dict]]:
    """ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨äº¤æ˜“æ—¥çš„å…¨å¸‚åœºè¡Œæƒ…åˆ°å†…å­˜ã€‚

    æ•°æ®é‡ï¼š402 å¤© Ã— ~5000 è‚¡ Ã— 11 å­—æ®µ â‰ˆ 2200 ä¸‡è¡Œ
    å†…å­˜å ç”¨ï¼šçº¦ 1-2 GB
    åŠ è½½è€—æ—¶ï¼šçº¦ 10-15 ç§’ï¼ˆå•æ¬¡ SQLï¼‰
    """
    rows = await session.execute(text("""
        SELECT sd.trade_date, sd.ts_code, sd.close, sd.open,
               sd.high, sd.low, sd.vol, sd.pct_chg, sd.turnover_rate,
               td.vol_ratio, td.ma10, td.ma20
        FROM stock_daily sd
        JOIN stocks s ON sd.ts_code = s.ts_code AND s.list_status='L'
        LEFT JOIN technical_daily td
            ON sd.ts_code=td.ts_code AND sd.trade_date=td.trade_date
        WHERE sd.trade_date BETWEEN :start AND :end AND sd.vol > 0
        ORDER BY sd.trade_date, sd.ts_code
    """), {"start": start_date, "end": end_date})

    # æŒ‰æ—¥æœŸåˆ†ç»„å­˜å…¥ dict
    market_data: dict[date, dict[str, dict]] = {}
    for row in rows:
        d = row.trade_date
        if d not in market_data:
            market_data[d] = {}
        market_data[d][row.ts_code] = {
            "close": float(row.close), "open": float(row.open),
            "high": float(row.high), "low": float(row.low),
            "vol": int(row.vol), "pct_chg": float(row.pct_chg),
            "turnover_rate": float(row.turnover_rate or 0),
            "vol_ratio": float(row.vol_ratio or 0),
            "ma10": float(row.ma10 or 0), "ma20": float(row.ma20 or 0),
        }
    return market_data
```

æ”¹åŠ¨ `engine.py`ï¼š`_fetch_daily_batch()` æ”¹ä¸ºä»é¢„åŠ è½½æ•°æ®è¯»å–ï¼Œä¸å†æŸ¥ DBã€‚

**æ•ˆæœï¼š** 32,562 æ¬¡å…¨å¸‚åœº SQL â†’ 1 æ¬¡ï¼ŒèŠ‚çœ ~60% è€—æ—¶ã€‚

#### ä¼˜åŒ–äºŒï¼šT0 äº‹ä»¶é¢„è®¡ç®—ä¸ç¼“å­˜

8 ä¸ªå‚æ•°ä¸­ï¼Œåªæœ‰ 3 ä¸ªå½±å“ T0 è¯†åˆ«ï¼š
- `min_t0_pct_chg`ï¼ˆ3 å€¼ï¼‰
- `min_t0_vol_ratio`ï¼ˆ3 å€¼ï¼‰
- `accumulation_days`ï¼ˆ3 å€¼ï¼‰

å…± 27 ç§å‰ç«¯å‚æ•°ç»„åˆï¼Œæ¯ç§ç»„åˆçš„ T0 äº‹ä»¶å®Œå…¨ä¸€è‡´ã€‚

```python
# grid_search.py æ–°å¢ T0 é¢„è®¡ç®—
def _precompute_t0_events(
    market_data: dict[date, dict[str, dict]],
    front_params_combos: list[dict],
) -> dict[tuple, dict[date, list[str]]]:
    """é¢„è®¡ç®—æ‰€æœ‰å‰ç«¯å‚æ•°ç»„åˆçš„ T0 äº‹ä»¶ã€‚

    è¾“å…¥ï¼š27 ç§ (pct_chg, vol_ratio, acc_days) ç»„åˆ
    è¾“å‡ºï¼š{(pct_chg, vol_ratio, acc_days): {date: [ts_codes]}}
    """
    cache = {}
    for fp in front_params_combos:
        key = (fp["min_t0_pct_chg"], fp["min_t0_vol_ratio"],
               fp["accumulation_days"])
        if key in cache:
            continue
        t0_by_date = {}
        for d, stocks in market_data.items():
            codes = [
                code for code, s in stocks.items()
                if s["pct_chg"] >= key[0] and s["vol_ratio"] >= key[1]
            ]
            if codes:
                t0_by_date[d] = codes
        cache[key] = t0_by_date
    return cache
```

æ”¹åŠ¨ `engine.py`ï¼š`run_backtest()` æ¥å—å¯é€‰çš„ `t0_cache` å‚æ•°ï¼Œæœ‰ç¼“å­˜æ—¶è·³è¿‡ T0 æ‰«æã€‚

**æ•ˆæœï¼š** T0 è®¡ç®—ä» 81 æ¬¡é™åˆ° 27 æ¬¡ï¼ˆå®é™…å› ä¸ºå¸ç­¹éªŒè¯ä¹Ÿå¯ç¼“å­˜ï¼Œé™åˆ°æ›´å°‘ï¼‰ã€‚

#### ä¼˜åŒ–ä¸‰ï¼šå¸ç­¹éªŒè¯æ‰¹é‡é¢„è®¡ç®—

å¸ç­¹éªŒè¯ï¼ˆ`_verify_accumulation_batch`ï¼‰åªä¾èµ– `accumulation_days` å’Œ `max_accumulation_range`ã€‚
å¯¹ç›¸åŒçš„ (ts_code, date, accumulation_days) ç»„åˆï¼Œç»“æœæ˜¯ç¡®å®šçš„ã€‚

```python
# å¸ç­¹éªŒè¯ç¼“å­˜
accumulation_cache: dict[tuple[str, date, int], bool] = {}
```

**æ•ˆæœï¼š** å¸ç­¹ SQL ä» ~32,000 æ¬¡é™åˆ° ~400 æ¬¡ï¼ˆæ¯å¤©åªæŸ¥ä¸€æ¬¡ï¼‰ã€‚

#### ä¼˜åŒ–å››ï¼šæ”¶ç›Šç‡æ‰¹é‡é¢„è®¡ç®—

å’Œä¼ ç»Ÿä¼˜åŒ–å™¨çš„ `_warmup_returns` ç±»ä¼¼ï¼Œä¸€æ¬¡æ€§æŸ¥æ‰€æœ‰å¯èƒ½çš„ä¿¡å·æ—¥æ”¶ç›Šï¼š

```python
async def _preload_returns(session, start_date, end_date):
    """é¢„åŠ è½½æ‰€æœ‰è‚¡ç¥¨åœ¨å›æµ‹åŒºé—´å†…çš„ T+1/3/5/10 æ”¶ç›Šç‡ã€‚"""
    # ä¸€æ¬¡ SQL æŸ¥å‡ºæ‰€æœ‰ (date, ts_code) â†’ (c1, c3, c5, c10)
    # å­˜å…¥ dict[(date, ts_code)] â†’ {ret_1d, ret_3d, ret_5d, ret_10d}
```

**æ•ˆæœï¼š** æ”¶ç›Š SQL ä» ~100-300 æ¬¡/ç»„ Ã— 81 ç»„ â†’ 1 æ¬¡æ‰¹é‡æŸ¥è¯¢ã€‚

### 8.3 ä¼˜åŒ–åæ€§èƒ½é¢„ä¼°

| é˜¶æ®µ | ä¼˜åŒ–å‰ SQL æ¬¡æ•° | ä¼˜åŒ–å SQL æ¬¡æ•° | ä¼˜åŒ–å‰è€—æ—¶ | ä¼˜åŒ–åè€—æ—¶ |
|------|---------------|---------------|-----------|-----------|
| æ•°æ®é¢„åŠ è½½ | 0 | 1ï¼ˆå¤§æŸ¥è¯¢ï¼‰ | 0 | ~15s |
| é€æ—¥æ¨¡æ‹Ÿï¼ˆ81ç»„ï¼‰ | ~32,000 | ~400ï¼ˆå¸ç­¹ï¼‰ | ~10min | ~1min |
| æ”¶ç›Šè®¡ç®—ï¼ˆ81ç»„ï¼‰ | ~16,000 | 1ï¼ˆæ‰¹é‡ï¼‰ | ~3min | ~5s |
| T0 é¢„è®¡ç®— | å«åœ¨æ¨¡æ‹Ÿä¸­ | 27 æ¬¡å†…å­˜æ‰«æ | - | ~2s |
| **åˆè®¡** | **~97,000** | **~430** | **~14min** | **~2min** |

6561 ç»„å…¨é‡æœç´¢ï¼šé¢„ä¼°ä» 60-90 åˆ†é’Ÿé™åˆ° 10-15 åˆ†é’Ÿã€‚

### 8.4 æ”¹åŠ¨æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `app/v4backtest/grid_search.py` | æ–°å¢ `_preload_market_data()`ã€`_precompute_t0_events()`ã€`_preload_returns()`ï¼›`run_grid_search()` å¢åŠ é¢„åŠ è½½é˜¶æ®µ |
| `app/v4backtest/engine.py` | `run_backtest()` æ–°å¢å¯é€‰å‚æ•° `market_data`ã€`t0_cache`ï¼›`_fetch_daily_batch()` æ”¯æŒå†…å­˜è¯»å– |
| `app/v4backtest/queries.py` | æ–°å¢æ‰¹é‡æ”¶ç›ŠæŸ¥è¯¢ SQL |

### 8.5 ä¸é‡‡ç”¨çš„æ–¹æ¡ˆåŠåŸå› 

| æ–¹æ¡ˆ | ä¸é‡‡ç”¨åŸå›  |
|------|-----------|
| Polars æ›¿ä»£ Pandas/dict | å¼•å…¥æ–°ä¾èµ–ï¼Œè§‚å¯Ÿæ± çŠ¶æ€æœºç”¨ dict å·²è¶³å¤Ÿå¿«ï¼ˆ<1ms/å¤©ï¼‰ï¼Œæ”¶ç›Šä¸å¤§ |
| Vectorbt | ä¸æ”¯æŒå¤šæ—¥çŠ¶æ€è¿½è¸ªç­–ç•¥ï¼Œéœ€è‡ªå†™ Numba kernelï¼Œå·¥ä½œé‡å¤§ |
| Numba @jit | ç“¶é¢ˆæ˜¯ SQL IO ä¸æ˜¯ Python è®¡ç®—ï¼ŒåŠ é€Ÿå†…å­˜éå†æ— æ„ä¹‰ |
| å®Œå…¨å‘é‡åŒ–è§‚å¯Ÿæ±  | çŠ¶æ€æµè½¬æœ‰æ—¶åºä¾èµ–ï¼ˆä¸­é€”æ­¢æŸ/è¿‡æœŸï¼‰ï¼Œå¸ƒå°”æ©ç æ— æ³•è¡¨è¾¾"ä¸­é€”é€€å‡º"é€»è¾‘ |

### 8.6 åç»­ä¼˜åŒ–æ–¹å‘

1. **é—ä¼ ç®—æ³•**ï¼š6561 ç»„åˆå¤ªå¤šæ—¶ï¼Œç”¨ GA æ›¿ä»£ç½‘æ ¼æœç´¢ï¼Œå‡å°‘è¯„ä¼°æ¬¡æ•°
2. **å¢é‡ä¼˜åŒ–**ï¼šåªå¯¹æœ€è¿‘ N å¤©çš„æ–°æ•°æ®é‡æ–°è¯„ä¼°ï¼Œè€Œéå…¨é‡å›æµ‹
3. **Parquet å¿«ç…§**ï¼šæ¯æ—¥ç›˜åå¯¼å‡º Parquet æ–‡ä»¶ï¼Œå›æµ‹æ—¶ç›´æ¥è¯»æ–‡ä»¶è€Œé SQL
4. **å¤§ç›˜çŠ¶æ€é¢„è®¡ç®—**ï¼š402 å¤©çš„å¤§ç›˜çŠ¶æ€ä¸€æ¬¡æ€§ç®—å®Œï¼Œé¿å…é€æ—¥æŸ¥è¯¢
