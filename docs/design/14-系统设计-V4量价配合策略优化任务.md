# 14-ç³»ç»Ÿè®¾è®¡ï¼šV4 é‡ä»·é…åˆç­–ç•¥ç‹¬ç«‹ä¼˜åŒ–ä»»åŠ¡

> **ç‰ˆæœ¬ï¼š** v1.2
> **æ—¥æœŸï¼š** 2026-03-01
> **å…³è”ï¼š** 12-Pipelineç¼“å­˜ä¼˜åŒ–.mdã€v4_planning/02-V4è¯¦ç»†è®¾è®¡-å›æµ‹ä¸å‚æ•°è°ƒä¼˜.md

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 é—®é¢˜

V4 é‡ä»·é…åˆç­–ç•¥ï¼ˆvolume-price-patternï¼‰ä¸å…¶ä»– 34 ä¸ªç­–ç•¥çš„ä¼˜åŒ–æ–¹å¼æ ¹æœ¬ä¸åŒï¼š

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿç­–ç•¥ï¼ˆ34ä¸ªï¼‰ | V4 é‡ä»·é…åˆ |
|--------|-----------------|-------------|
| ä¿¡å·äº§ç”Ÿ | å•æ—¥ filter_batch å³å‡ºç»“æœ | éœ€è¦å¤šæ—¥çŠ¶æ€è¿½è¸ªï¼ˆT0â†’å›è¸©â†’Tkä¼ç¨³ï¼‰ |
| è¯„ä¼°æ–¹å¼ | ç¦»æ•£é‡‡æ ·æ—¥ï¼Œæ¯æ—¥ç‹¬ç«‹è¯„ä¼° | å¿…é¡»è¿ç»­æ—¥å›æ”¾ï¼Œç»´æŠ¤è§‚å¯Ÿæ± çŠ¶æ€ |
| ä¼˜åŒ–å™¨ | MarketOptimizerï¼ˆé‡‡æ ·å›æ”¾ï¼‰ | éœ€è¦ V4 ä¸“ç”¨å›æµ‹å¼•æ“ï¼ˆé€æ—¥æ¨¡æ‹Ÿï¼‰ |
| æ•°æ®ä¾èµ– | Pipeline Layer 1-3 | è§‚å¯Ÿæ±  + å¸ç­¹éªŒè¯ + å‡çº¿æ”¯æ’‘ |

ç°æœ‰ `weekly_market_opt_job` æ— æ³•ç›´æ¥å¤„ç† V4ï¼Œå¼ºè¡Œå¡å…¥ä¼šå¯¼è‡´æ¶æ„æ··ä¹±ã€‚

### 1.2 ç›®æ ‡

ä¸º V4 åˆ›å»ºç‹¬ç«‹çš„å®šæ—¶ä¼˜åŒ–ä»»åŠ¡ï¼Œä¸ç°æœ‰å…¨å¸‚åœºä¼˜åŒ–å¹¶è¡Œè°ƒåº¦ï¼Œå¤ç”¨å·²æœ‰çš„ V4 å›æµ‹å¼•æ“ã€‚

---

## 2. æ•´ä½“æ¶æ„

```
è°ƒåº¦å™¨ (APScheduler)
â”œâ”€â”€ weekly_market_opt_job      â† ç°æœ‰ï¼š34 ä¸ªä¼ ç»Ÿç­–ç•¥ï¼ˆå‘¨å…­ 10:00ï¼‰
â”œâ”€â”€ weekly_v4_opt_job          â† æ–°å¢ï¼šV4 é‡ä»·é…åˆç­–ç•¥ï¼ˆå‘¨å…­ 12:00ï¼‰
â”‚   â”œâ”€â”€ è¯»å–å‚æ•°ç©ºé—´
â”‚   â”œâ”€â”€ è°ƒç”¨ V4 ç½‘æ ¼æœç´¢å¼•æ“ï¼ˆrun_grid_searchï¼‰
â”‚   â”œâ”€â”€ ç»“æœå†™å…¥ v4_backtest_results è¡¨
â”‚   â”œâ”€â”€ æœ€ä½³å‚æ•°è‡ªåŠ¨åº”ç”¨åˆ° strategies è¡¨
â”‚   â””â”€â”€ å‘é€ Telegram é€šçŸ¥
â””â”€â”€ auto_update_job            â† ç°æœ‰ï¼šç›˜åæ•°æ®æ›´æ–°
```

### 2.1 æ ¸å¿ƒåŸåˆ™

- **ç‹¬ç«‹è°ƒåº¦**ï¼šV4 ä¼˜åŒ–ä»»åŠ¡æœ‰è‡ªå·±çš„ cron è¡¨è¾¾å¼ã€å¼€å…³ã€é…ç½®é¡¹
- **å¤ç”¨å¼•æ“**ï¼šç›´æ¥è°ƒç”¨ `app/v4backtest/grid_search.py` çš„ `run_grid_search()`
- **ç»“æœéš”ç¦»**ï¼šV4 ç»“æœå†™å…¥ `v4_backtest_results` è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰ï¼Œä¸æ··å…¥ `market_optimization_tasks`
- **ç»Ÿä¸€é€šçŸ¥**ï¼šå¤ç”¨ç°æœ‰ Telegram é€šçŸ¥æœºåˆ¶

---

## 3. è¯¦ç»†è®¾è®¡

### 3.1 æ–°å¢é…ç½®é¡¹ï¼ˆapp/config.pyï¼‰

```python
# V4 é‡ä»·é…åˆç­–ç•¥ç‹¬ç«‹ä¼˜åŒ–
v4_opt_enabled: bool = True                          # æ˜¯å¦å¯ç”¨
v4_opt_cron: str = "0 12 * * 6"                      # é»˜è®¤å‘¨å…­ 12:00ï¼ˆåœ¨ä¼ ç»Ÿä¼˜åŒ–ä¹‹åï¼‰
v4_opt_lookback_start: str = "2024-07-01"            # å›æµ‹èµ·å§‹æ—¥æœŸ
v4_opt_lookback_end: str = ""                        # å›æµ‹ç»“æŸæ—¥æœŸï¼ˆç©º=æœ€è¿‘äº¤æ˜“æ—¥ï¼‰
v4_opt_max_concurrency: int = 4                      # æœ€å¤§å¹¶å‘åº¦
v4_opt_auto_apply: bool = True                       # è‡ªåŠ¨åº”ç”¨æœ€ä½³å‚æ•°
```

### 3.2 å‚æ•°ç©ºé—´ï¼ˆä¸¤é˜¶æ®µç­–ç•¥ï¼‰

å½“å‰æ³¨å†Œçš„ param_space æœ‰ 8 ä¸ªå‚æ•°ï¼Œ3^8 = 6561 ç»„åˆï¼Œå…¨é‡æœç´¢çº¦éœ€ 30-60 åˆ†é’Ÿã€‚

**é˜¶æ®µä¸€ï¼ˆé»˜è®¤ï¼‰ï¼šæ ¸å¿ƒ 4 å‚æ•°ï¼Œ81 ç»„åˆ**

```python
V4_OPT_PARAM_GRID = {
    "min_t0_pct_chg":       [5.0, 6.0, 7.0],
    "min_washout_days":     [2, 3, 4],
    "max_vol_shrink_ratio": [0.30, 0.40, 0.50],
    "ma_support_tolerance": [0.010, 0.015, 0.020],
}
# å…¶ä½™å‚æ•°ä½¿ç”¨ DEFAULT_PARAMS å›ºå®šå€¼
```

é¢„ä¼°è€—æ—¶ï¼š81 ç»„åˆ Ã— ~40s/ç»„ Ã· 4 å¹¶å‘ â‰ˆ 14 åˆ†é’Ÿ

**é˜¶æ®µäºŒï¼ˆå¯é€‰ï¼‰ï¼šå…¨é‡ 8 å‚æ•°ï¼Œ6561 ç»„åˆ**

é€šè¿‡ API æ‰‹åŠ¨è§¦å‘ï¼Œæˆ–é…ç½® `v4_opt_param_grid` è¦†ç›–ã€‚

### 3.3 æ–°å¢æ–‡ä»¶ï¼š`app/scheduler/v4_opt_job.py`

```python
"""V4 é‡ä»·é…åˆç­–ç•¥ç‹¬ç«‹ä¼˜åŒ–ä»»åŠ¡ã€‚

ä¸ weekly_market_opt_job å¹¶è¡Œè°ƒåº¦ï¼Œä½¿ç”¨ V4 ä¸“ç”¨å›æµ‹å¼•æ“ï¼ˆé€æ—¥æ¨¡æ‹Ÿ + å†…å­˜è§‚å¯Ÿæ± ï¼‰ã€‚
"""

async def weekly_v4_opt_job() -> None:
    """
    æµç¨‹ï¼š
    1. æ£€æŸ¥å¼€å…³ settings.v4_opt_enabled
    2. ç¡®å®šå›æµ‹æ—¥æœŸèŒƒå›´ï¼ˆlookback_start ~ lookback_end æˆ–æœ€è¿‘äº¤æ˜“æ—¥ï¼‰
    3. è°ƒç”¨ run_grid_search() æ‰§è¡Œç½‘æ ¼æœç´¢
    4. ç»“æœå†™å…¥ v4_backtest_results è¡¨ï¼ˆis_grid_search=True, grid_search_id=æ‰¹æ¬¡IDï¼‰
    5. æœ€ä½³å‚æ•°å†™å…¥ strategies.paramsï¼ˆauto_apply=True æ—¶ï¼‰
    6. å‘é€ Telegram é€šçŸ¥ï¼ˆæ‘˜è¦ + Markdown æŠ¥å‘Šï¼‰
    """
```

æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç ï¼š

```python
async def weekly_v4_opt_job() -> None:
    if not settings.v4_opt_enabled:
        return

    # 1. ç¡®å®šæ—¥æœŸèŒƒå›´
    start_date = date.fromisoformat(settings.v4_opt_lookback_start)
    end_date = await _get_latest_trade_date() if not settings.v4_opt_lookback_end \
               else date.fromisoformat(settings.v4_opt_lookback_end)

    # 2. æ‰§è¡Œç½‘æ ¼æœç´¢
    grid_search_id = str(uuid4())
    results = await run_grid_search(
        session_factory=async_session_factory,
        start_date=start_date,
        end_date=end_date,
        param_grid=V4_OPT_PARAM_GRID,
        max_concurrency=settings.v4_opt_max_concurrency,
    )

    # 3. æ‰¹é‡å†™å…¥ v4_backtest_results
    async with async_session_factory() as session:
        for rank, r in enumerate(results, 1):
            await session.execute(INSERT_SQL, {
                "run_id": str(uuid4()),
                "grid_search_id": grid_search_id,
                "rank_in_grid": rank,
                "is_grid_search": True,
                "params": r.params,
                "backtest_start": start_date,
                "backtest_end": end_date,
                # ... metrics å­—æ®µ
            })

        # 4. è‡ªåŠ¨åº”ç”¨æœ€ä½³å‚æ•°
        if settings.v4_opt_auto_apply and results:
            best = results[0]
            merged_params = {**DEFAULT_PARAMS, **best.params}
            await session.execute(
                "UPDATE strategies SET params=:p WHERE name='volume-price-pattern'",
                {"p": json.dumps(merged_params)},
            )

        await session.commit()

    # 5. Telegram é€šçŸ¥
    await _send_v4_opt_report(results, grid_search_id, start_date, end_date)
```

### 3.4 è°ƒåº¦å™¨æ³¨å†Œï¼ˆapp/scheduler/core.pyï¼‰

åœ¨ `register_jobs()` ä¸­æ–°å¢ï¼š

```python
from app.scheduler.v4_opt_job import weekly_v4_opt_job

if settings.v4_opt_enabled:
    v4_cron = settings.v4_opt_cron
    parts = v4_cron.split()
    scheduler.add_job(
        func=weekly_v4_opt_job,
        trigger=CronTrigger(
            minute=parts[0], hour=parts[1], day=parts[2],
            month=parts[3], day_of_week=parts[4],
            timezone="Asia/Shanghai",
        ),
        id="weekly_v4_optimization",
        name="V4é‡ä»·é…åˆç­–ç•¥ä¼˜åŒ–",
        replace_existing=True,
    )
```

### 3.5 API ç«¯ç‚¹ï¼ˆapp/v4backtest/router.py æ‰©å±•ï¼‰

æ–°å¢æ‰‹åŠ¨è§¦å‘ç«¯ç‚¹ï¼š

```python
@router.post("/optimize")
async def run_v4_optimization(req: V4OptRequest):
    """æ‰‹åŠ¨è§¦å‘ V4 å‚æ•°ä¼˜åŒ–ã€‚"""
    # åå°æ‰§è¡Œ weekly_v4_opt_job çš„æ ¸å¿ƒé€»è¾‘
    # æ”¯æŒè‡ªå®šä¹‰ param_gridã€æ—¥æœŸèŒƒå›´
    asyncio.create_task(_run_v4_opt(...))
    return {"grid_search_id": grid_search_id, "status": "running"}

@router.get("/optimize/latest")
async def get_latest_v4_opt():
    """æŸ¥è¯¢æœ€è¿‘ä¸€æ¬¡ V4 ä¼˜åŒ–ç»“æœã€‚"""
    # ä» v4_backtest_results æŸ¥ is_grid_search=True çš„æœ€æ–°æ‰¹æ¬¡
```

### 3.6 Telegram é€šçŸ¥è®¾è®¡

å¤ç”¨ç°æœ‰ `NotificationManager.send_report()` æœºåˆ¶ï¼ˆæ‘˜è¦æ–‡æœ¬ + Markdown æ–‡ä»¶é™„ä»¶ï¼‰ã€‚

æ–°å¢ `generate_v4_opt_report()` åˆ° `app/scheduler/report.py`ã€‚

**æ‘˜è¦æ–‡æœ¬ï¼ˆTelegram æ¶ˆæ¯ï¼‰ï¼š**
```
ğŸ‰ V4 é‡ä»·é…åˆç­–ç•¥ â€” æ¯å‘¨å‚æ•°ä¼˜åŒ–å®Œæˆ
â± è€—æ—¶ 2åˆ†15ç§’ | å‚æ•°ç»„åˆ 81 ç»„
ğŸ† æœ€ä½³ç»¼åˆå¾—åˆ†: 0.7400
  1. min_t0_pct_chg=6.0, washout=3, shrink=0.40, ma_tol=0.015
ğŸ“Š æœ€ä½³å‚æ•°å·²è‡ªåŠ¨åº”ç”¨ âœ…
```

**Markdown æ–‡ä»¶é™„ä»¶ï¼ˆv4_opt_YYYY-MM-DD.mdï¼‰ï¼š**
```markdown
# ğŸ‰ V4 é‡ä»·é…åˆç­–ç•¥ â€” æ¯å‘¨å‚æ•°ä¼˜åŒ–æŠ¥å‘Š

**å›æµ‹åŒºé—´ï¼š** 2024-07-01 ~ 2026-02-28
**å‚æ•°ç»„åˆï¼š** 81 ç»„ | **è€—æ—¶ï¼š** 2 åˆ† 15 ç§’

## ğŸ† Top 5 å‚æ•°ç»„åˆ

| æ’å | min_t0_pct_chg | min_washout_days | max_vol_shrink | ma_tolerance | èƒœç‡(5d) | ç›ˆäºæ¯” | å¤æ™® | ç»¼åˆå¾—åˆ† |
|------|---------------|-----------------|---------------|-------------|---------|-------|------|---------|
| 1    | 6.0           | 3               | 0.40          | 0.015       | 59.2%   | 1.87  | 2.21 | 0.74   |
| ...  |               |                 |               |             |         |       |      |        |

## ğŸ“Š æœ€ä½³å‚æ•°ï¼ˆå·²è‡ªåŠ¨åº”ç”¨ï¼‰
{å®Œæ•´ merged_params JSON}

## ğŸ“ˆ ä¿¡å·ç»Ÿè®¡
- æ€»ä¿¡å·æ•°ï¼š312 | æœˆå‡ï¼š8.7
- 1d/3d/5d/10d èƒœç‡
- ç›ˆäºæ¯”ã€æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡
```

**é€šçŸ¥è§¦å‘æ—¶æœºï¼š**
1. å®šæ—¶ä»»åŠ¡å®Œæˆæ—¶ï¼ˆ`weekly_v4_opt_job`ï¼‰
2. API æ‰‹åŠ¨è§¦å‘å®Œæˆæ—¶ï¼ˆ`/api/v1/v4backtest/optimize`ï¼‰
3. å¤±è´¥æ—¶ä¹Ÿå‘é€šçŸ¥ï¼ˆåŒ…å«é”™è¯¯ä¿¡æ¯ï¼‰

---

## 4. æ”¹åŠ¨æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `app/config.py` | ä¿®æ”¹ | æ–°å¢ v4_opt_* é…ç½®é¡¹ï¼ˆ6ä¸ªï¼‰ |
| `app/scheduler/v4_opt_job.py` | æ–°å¢ | V4 ç‹¬ç«‹ä¼˜åŒ–ä»»åŠ¡ä¸»ä½“ |
| `app/scheduler/core.py` | ä¿®æ”¹ | register_jobs ä¸­æ³¨å†Œ V4 ä¼˜åŒ–ä»»åŠ¡ |
| `app/v4backtest/router.py` | ä¿®æ”¹ | æ–°å¢ /optimize å’Œ /optimize/latest ç«¯ç‚¹ |
| `app/scheduler/report.py` | ä¿®æ”¹ | æ–°å¢ generate_v4_opt_report() |

### éœ€è¦æ”¹åŠ¨çš„æ–‡ä»¶ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

- `app/v4backtest/engine.py` â€” `run_backtest()` æ–°å¢å¯é€‰ `market_data`/`t0_cache` å‚æ•°ï¼Œæ”¯æŒå†…å­˜æ•°æ®æº
- `app/v4backtest/grid_search.py` â€” æ–°å¢é¢„åŠ è½½é˜¶æ®µï¼ŒT0 é¢„è®¡ç®—ï¼Œæ”¶ç›Šå†…å­˜åŒ–
- `app/v4backtest/evaluator.py` â€” æ— éœ€æ”¹åŠ¨

### ä¸éœ€è¦æ”¹åŠ¨çš„æ–‡ä»¶

- `app/optimization/market_optimizer.py` â€” ä¼ ç»Ÿä¼˜åŒ–å™¨ä¸å—å½±å“
- `app/scheduler/market_opt_job.py` â€” ä¼ ç»Ÿä¼˜åŒ–ä»»åŠ¡ä¸å—å½±å“

---

## 5. æ•°æ®æµï¼ˆä¼˜åŒ–åï¼‰

```
weekly_v4_opt_job
    â”‚
    â”œâ”€â†’ é¢„åŠ è½½é˜¶æ®µï¼ˆ1 æ¬¡ SQLï¼‰
    â”‚       â”œâ”€â†’ _preload_market_data()    å…¨å¸‚åœºè¡Œæƒ… â†’ dict[date, dict[str, dict]]
    â”‚       â”œâ”€â†’ _preload_index_data()     å¤§ç›˜æŒ‡æ•° â†’ dict[date, MarketState]
    â”‚       â”œâ”€â†’ _preload_returns()        å…¨é‡æ”¶ç›Šç‡ â†’ dict[(date, ts_code), float]
    â”‚       â””â”€â†’ _precompute_t0_events()   27 ç§å‰ç«¯å‚æ•° â†’ T0 äº‹ä»¶ç¼“å­˜
    â”‚
    â”œâ”€â†’ run_grid_search()                 [v4backtest/grid_search.py]
    â”‚       â”‚
    â”‚       â”œâ”€â†’ run_backtest()            [v4backtest/engine.py]ï¼ˆé›¶ SQLï¼‰
    â”‚       â”‚       â”œâ”€â†’ ä»å†…å­˜è¯»å–å½“æ—¥è¡Œæƒ…ï¼ˆdict å“ˆå¸ŒæŸ¥æ‰¾ O(1)ï¼‰
    â”‚       â”‚       â”œâ”€â†’ ä» T0 ç¼“å­˜è¯»å–å€™é€‰ï¼ˆå‘½ä¸­ç‡ ~67%ï¼‰
    â”‚       â”‚       â”œâ”€â†’ ä»å†…å­˜éªŒè¯å¸ç­¹ï¼ˆæŒ‰ ts_code äºŒçº§ç´¢å¼•åˆ‡ç‰‡ï¼‰
    â”‚       â”‚       â”œâ”€â†’ ä»å†…å­˜è¯»å–å¤§ç›˜çŠ¶æ€ï¼ˆé¢„è®¡ç®—ç»“æœï¼‰
    â”‚       â”‚       â””â”€â†’ å†…å­˜ _WatchEntry dict çŠ¶æ€æœºï¼ˆä¸å˜ï¼‰
    â”‚       â”‚
    â”‚       â”œâ”€â†’ fill_returns_from_memory() ä»é¢„åŠ è½½æ”¶ç›Šç¼“å­˜è¯»å–ï¼ˆé›¶ SQLï¼‰
    â”‚       â””â”€â†’ evaluate_signals()         [v4backtest/evaluator.py]ï¼ˆçº¯è®¡ç®—ï¼‰
    â”‚
    â”œâ”€â†’ å†™å…¥ v4_backtest_results è¡¨
    â”œâ”€â†’ æ›´æ–° strategies.paramsï¼ˆauto_applyï¼‰
    â””â”€â†’ Telegram é€šçŸ¥
```

---

## 6. è°ƒåº¦æ—¶åº

```
å‘¨å…­ 10:00  weekly_market_opt_job    ä¼ ç»Ÿ 18 ç­–ç•¥ä¼˜åŒ–ï¼ˆ~17 åˆ†é’Ÿï¼‰
å‘¨å…­ 12:00  weekly_v4_opt_job        V4 é‡ä»·é…åˆä¼˜åŒ–ï¼ˆ~14 åˆ†é’Ÿï¼‰
```

ä¸¤ä¸ªä»»åŠ¡é”™å¼€ 2 å°æ—¶ï¼Œé¿å…æ•°æ®åº“è¿æ¥ç«äº‰ã€‚

---

## 7. æ€§èƒ½é¢„ä¼°ï¼ˆä¼˜åŒ–åï¼‰

| åœºæ™¯ | ç»„åˆæ•° | å¹¶å‘åº¦ | SQL æ¬¡æ•° | é¢„ä¼°è€—æ—¶ |
|------|--------|--------|---------|---------|
| é˜¶æ®µä¸€ï¼ˆ4å‚æ•°ï¼‰ | 81 | 4 | 3ï¼ˆé¢„åŠ è½½ï¼‰ | ~2 åˆ†é’Ÿ |
| é˜¶æ®µäºŒï¼ˆ8å‚æ•°ï¼‰ | 6561 | 4 | 3ï¼ˆé¢„åŠ è½½ï¼‰ | ~10-15 åˆ†é’Ÿ |
| å•æ¬¡å›æµ‹ï¼ˆ1.5å¹´ï¼‰ | 1 | - | 3ï¼ˆé¢„åŠ è½½ï¼‰ | ~5 ç§’ |

é¢„åŠ è½½é˜¶æ®µçº¦ 15-20 ç§’ï¼Œä¹‹åå…¨ç¨‹é›¶ SQLï¼Œçº¯å†…å­˜è®¡ç®—ã€‚

---

## 8. å›æµ‹å¼•æ“æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼ˆé›¶ SQL æ¶æ„ï¼‰

### 8.1 è®¾è®¡å“²å­¦

> å°†é‡åº¦ IO è½¬åŒ–ä¸ºå†…å­˜åˆ‡ç‰‡ï¼Œå°†å¤æ‚è®¡ç®—ç¼“å­˜åŒ–ï¼Œä¿ç•™é¢å‘å¯¹è±¡çš„äº‹ä»¶æµè½¬ã€‚

æ ¸å¿ƒåŸåˆ™ï¼š
- æ•°æ®ç»“æ„ä¿æŒ `dict[date, dict[str, dict]]` ä¸å˜ï¼Œä¸ç°æœ‰ engine.py å®Œå…¨å…¼å®¹
- ä¸å¼•å…¥æ–°ä¾èµ–ï¼ˆä¸éœ€è¦ polars/vectorbt/numbaï¼‰
- è§‚å¯Ÿæ± çŠ¶æ€æœºï¼ˆ`_WatchEntry` dictï¼‰ä¿æŒä¸åŠ¨ï¼Œå®ƒä¸æ˜¯ç“¶é¢ˆä¸”é€»è¾‘æ¸…æ™°

### 8.2 ç°çŠ¶ç“¶é¢ˆ

| ç“¶é¢ˆ | åŸå›  | SQL æ¬¡æ•°ï¼ˆ81ç»„ï¼‰ | å æ¯” |
|------|------|-----------------|------|
| å…¨å¸‚åœºè¡Œæƒ…é‡å¤æŸ¥è¯¢ | 81 ç»„ Ã— 402 å¤© = 32,562 æ¬¡ç›¸åŒ SQL | ~32,000 | ~60% |
| T0 äº‹ä»¶é‡å¤è®¡ç®— | å‰ç«¯å‚æ•°ç›¸åŒæ—¶ T0 ç»“æœä¸€è‡´ | å«åœ¨ä¸Šé¢ | ~15% |
| å¸ç­¹éªŒè¯é‡å¤æŸ¥è¯¢ | åŒä¸€å¤©åŒä¸€åªè‚¡ç¥¨è¢«å¤šæ¬¡éªŒè¯ | ~32,000 | ~10% |
| æ”¶ç›Šè®¡ç®—é€æ¡æŸ¥è¯¢ | æ¯ä¸ªä¿¡å·å•ç‹¬ SQL | ~16,000 | ~15% |
| **åˆè®¡** | | **~97,000** | |

è§‚å¯Ÿæ± çŠ¶æ€æœºï¼ˆå†…å­˜ dict éå† 10-100 ä¸ª entryï¼‰è€—æ—¶ <1ms/å¤©ï¼Œä¸æ˜¯ç“¶é¢ˆã€‚

### 8.3 ä¼˜åŒ–æ–¹æ¡ˆï¼šå››å±‚é¢„åŠ è½½ï¼Œå®ç°é›¶ SQL å›æµ‹

#### ä¼˜åŒ–ä¸€ï¼šå…¨å¸‚åœºè¡Œæƒ…é¢„åŠ è½½

å›æµ‹å¼€å§‹å‰ï¼Œ1 æ¬¡ SQL åŠ è½½å…¨éƒ¨äº¤æ˜“æ—¥æ•°æ®åˆ°å†…å­˜ï¼š

```python
async def _preload_market_data(
    session, start_date, end_date
) -> dict[date, dict[str, dict]]:
    """ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨äº¤æ˜“æ—¥çš„å…¨å¸‚åœºè¡Œæƒ…åˆ°å†…å­˜ã€‚

    æ•°æ®é‡ï¼š402 å¤© Ã— ~5000 è‚¡ Ã— 11 å­—æ®µ â‰ˆ 200 ä¸‡è¡Œ
    å†…å­˜å ç”¨ï¼šçº¦ 1-2 GB
    åŠ è½½è€—æ—¶ï¼šçº¦ 10-15 ç§’ï¼ˆå•æ¬¡ SQLï¼‰
    è¿”å›ç»“æ„ï¼šdict[date, dict[str, dict]] â€” ä¸ engine.py å®Œå…¨å…¼å®¹
    """
    rows = await session.execute(text("""
        SELECT sd.trade_date, sd.ts_code, sd.close, sd.open,
               sd.high, sd.low, sd.vol, sd.pct_chg, sd.turnover_rate,
               td.vol_ratio, td.ma10, td.ma20
        FROM stock_daily sd
        JOIN stocks s ON sd.ts_code = s.ts_code AND s.list_status='L'
        LEFT JOIN technical_daily td
            ON sd.ts_code=td.ts_code AND sd.trade_date=td.trade_date
        WHERE sd.trade_date BETWEEN :start AND :end AND sd.vol > 0
        ORDER BY sd.trade_date, sd.ts_code
    """), {"start": start_date, "end": end_date})

    market_data: dict[date, dict[str, dict]] = {}
    for row in rows:
        d = row.trade_date
        if d not in market_data:
            market_data[d] = {}
        market_data[d][row.ts_code] = {
            "close": float(row.close), "open": float(row.open),
            "high": float(row.high), "low": float(row.low),
            "vol": int(row.vol), "pct_chg": float(row.pct_chg),
            "turnover_rate": float(row.turnover_rate or 0),
            "vol_ratio": float(row.vol_ratio or 0),
            "ma10": float(row.ma10 or 0), "ma20": float(row.ma20 or 0),
        }
    return market_data
```

engine.py æ”¹åŠ¨ï¼š`run_backtest()` æ–°å¢å¯é€‰ `market_data` å‚æ•°ï¼Œæœ‰å€¼æ—¶ `_fetch_daily_batch` ç›´æ¥è¿”å› `market_data[date]`ã€‚

**æ•ˆæœï¼š** 32,562 æ¬¡ SQL â†’ 0 æ¬¡ã€‚

#### ä¼˜åŒ–äºŒï¼šT0 äº‹ä»¶é¢„è®¡ç®—ä¸ç¼“å­˜

8 ä¸ªå‚æ•°ä¸­åªæœ‰ 3 ä¸ªå½±å“ T0 è¯†åˆ«ï¼Œå…± 27 ç§å‰ç«¯å‚æ•°ç»„åˆï¼š

```python
def _precompute_t0_events(
    market_data: dict[date, dict[str, dict]],
    front_params_combos: list[dict],
) -> dict[tuple, dict[date, list[str]]]:
    """é¢„è®¡ç®—æ‰€æœ‰å‰ç«¯å‚æ•°ç»„åˆçš„ T0 äº‹ä»¶ã€‚

    ç¼“å­˜ key ç”¨ tupleï¼ˆåŸç”Ÿå“ˆå¸Œï¼Œæ¯” JSON+MD5 å¿« 100 å€ï¼‰ï¼š
    (min_t0_pct_chg, min_t0_vol_ratio, accumulation_days)
    """
    cache = {}
    for fp in front_params_combos:
        key = (fp["min_t0_pct_chg"], fp["min_t0_vol_ratio"],
               fp["accumulation_days"])
        if key in cache:
            continue
        t0_by_date = {}
        for d, stocks in market_data.items():
            codes = [
                code for code, s in stocks.items()
                if s["pct_chg"] >= key[0] and s["vol_ratio"] >= key[1]
            ]
            if codes:
                t0_by_date[d] = codes
        cache[key] = t0_by_date
    return cache
```

**æ•ˆæœï¼š** T0 æ‰«æä» 81 æ¬¡é™åˆ° 27 æ¬¡ï¼Œå‘½ä¸­ç‡ ~67%ã€‚

#### ä¼˜åŒ–ä¸‰ï¼šå¸ç­¹éªŒè¯å†…å­˜åŒ–

å…¨å¸‚åœºè¡Œæƒ…å·²åœ¨å†…å­˜ä¸­ï¼Œå¸ç­¹éªŒè¯å¯ä»¥ç›´æ¥ä»å†…å­˜åˆ‡ç‰‡è®¡ç®—ï¼š

```python
def _verify_accumulation_from_memory(
    market_data: dict[date, dict[str, dict]],
    trade_dates: list[date],
    codes: list[str],
    target_date: date,
    params: dict,
) -> set[str]:
    """ä»å†…å­˜æ•°æ®éªŒè¯å¸ç­¹æ¡ä»¶ï¼Œæ›¿ä»£åŸæ¥çš„ SQL æŸ¥è¯¢ã€‚

    é€»è¾‘ï¼šæŸ¥ç›®æ ‡æ—¥æœŸå‰ accumulation_days å¤©å†…ï¼Œ
    è¯¥è‚¡ç¥¨çš„ (max(high) - min(low)) / min(low) <= max_range
    """
    acc_days = params.get("accumulation_days", 60)
    max_range = params.get("max_accumulation_range", 0.20)

    # æ‰¾åˆ° target_date åœ¨ trade_dates ä¸­çš„ä½ç½®
    idx = trade_dates.index(target_date)
    start_idx = max(0, idx - acc_days)
    lookback_dates = trade_dates[start_idx:idx]  # ä¸å«å½“å¤©

    valid = set()
    for code in codes:
        highs, lows = [], []
        for d in lookback_dates:
            s = market_data.get(d, {}).get(code)
            if s:
                highs.append(s["high"])
                lows.append(s["low"])
        if not lows:
            continue
        min_low = min(lows)
        if min_low <= 0:
            continue
        amplitude = (max(highs) - min_low) / min_low
        if amplitude <= max_range:
            valid.add(code)
    return valid
```

**æ•ˆæœï¼š** ~32,000 æ¬¡å¸ç­¹ SQL â†’ 0 æ¬¡ï¼Œçº¯å†…å­˜è®¡ç®—ã€‚

#### ä¼˜åŒ–å››ï¼šæ”¶ç›Šç‡å†…å­˜åŒ–

å…¨å¸‚åœºè¡Œæƒ…å·²åœ¨å†…å­˜ä¸­ï¼Œæ”¶ç›Šè®¡ç®—ç›´æ¥ä»å†…å­˜å‘ååˆ‡ç‰‡ï¼š

```python
def _fill_returns_from_memory(
    signals: list[BacktestSignal],
    market_data: dict[date, dict[str, dict]],
    trade_dates: list[date],
) -> None:
    """ä»å†…å­˜æ•°æ®è®¡ç®—ä¿¡å·åç»­æ”¶ç›Šï¼Œæ›¿ä»£é€æ¡ SQL æŸ¥è¯¢ã€‚"""
    for sig in signals:
        try:
            idx = trade_dates.index(sig.signal_date)
        except ValueError:
            continue
        ep = sig.entry_price
        if ep <= 0:
            continue
        future = trade_dates[idx + 1:]  # ä¿¡å·æ—¥ä¹‹åçš„äº¤æ˜“æ—¥
        for offset, attr in [(1, "ret_1d"), (3, "ret_3d"),
                             (5, "ret_5d"), (10, "ret_10d")]:
            if offset <= len(future):
                d = future[offset - 1]
                s = market_data.get(d, {}).get(sig.ts_code)
                if s and s["close"] > 0:
                    setattr(sig, attr, s["close"] / ep - 1)
```

**æ•ˆæœï¼š** ~16,000 æ¬¡æ”¶ç›Š SQL â†’ 0 æ¬¡ã€‚

#### ä¼˜åŒ–äº”ï¼šå¤§ç›˜çŠ¶æ€é¢„è®¡ç®—

402 å¤©çš„å¤§ç›˜çŠ¶æ€ä¸€æ¬¡æ€§ç®—å®Œï¼Œé¿å…é€æ—¥æŸ¥è¯¢ï¼š

```python
async def _preload_market_states(
    session, trade_dates, index_code="000300.SH"
) -> dict[date, str]:
    """é¢„è®¡ç®—æ‰€æœ‰äº¤æ˜“æ—¥çš„å¤§ç›˜çŠ¶æ€ã€‚1 æ¬¡ SQLã€‚"""
    states = {}
    for d in trade_dates:
        state = await evaluate_market(session, d, index_code)
        states[d] = state.value
    return states
```

engine.py æ”¹åŠ¨ï¼š`run_backtest()` æ–°å¢å¯é€‰ `market_states` å‚æ•°ã€‚

**æ•ˆæœï¼š** 402 æ¬¡å¤§ç›˜ SQL â†’ 1 æ¬¡æ‰¹é‡æŸ¥è¯¢ã€‚

### 8.4 ä¼˜åŒ–åæ€§èƒ½é¢„ä¼°

| é˜¶æ®µ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|------|--------|--------|------|
| æ•°æ®é¢„åŠ è½½ | 0 | ~15s | 1 æ¬¡å¤§ SQL + å†…å­˜æ„å»º |
| å¤§ç›˜é¢„è®¡ç®— | 402 æ¬¡ SQL | ~3s | 1 æ¬¡æ‰¹é‡æŸ¥è¯¢ |
| T0 é¢„è®¡ç®— | å«åœ¨æ¨¡æ‹Ÿä¸­ | ~2s | 27 æ¬¡å†…å­˜æ‰«æ |
| é€æ—¥æ¨¡æ‹Ÿï¼ˆ81ç»„ï¼‰ | ~32,000 æ¬¡ SQL, ~10min | ~1min | çº¯å†…å­˜ï¼Œé›¶ SQL |
| æ”¶ç›Šè®¡ç®—ï¼ˆ81ç»„ï¼‰ | ~16,000 æ¬¡ SQL, ~3min | ~2s | çº¯å†…å­˜åˆ‡ç‰‡ |
| **åˆè®¡** | **~97,000 æ¬¡ SQL, ~14min** | **3 æ¬¡ SQL, ~2min** | **æé€Ÿ 7 å€** |

6561 ç»„å…¨é‡æœç´¢ï¼šé¢„ä¼°ä» 60-90 åˆ†é’Ÿé™åˆ° 10-15 åˆ†é’Ÿã€‚

### 8.5 æ”¹åŠ¨æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `app/v4backtest/grid_search.py` | æ–°å¢é¢„åŠ è½½å‡½æ•°ï¼›`run_grid_search()` å¢åŠ é¢„åŠ è½½é˜¶æ®µï¼›`fill_returns` æ”¹ä¸ºå†…å­˜ç‰ˆæœ¬ |
| `app/v4backtest/engine.py` | `run_backtest()` æ–°å¢å¯é€‰å‚æ•° `market_data`ã€`t0_cache`ã€`market_states`ï¼›å†…éƒ¨å‡½æ•°æ”¯æŒå†…å­˜æ•°æ®æº |

### 8.6 ä¸é‡‡ç”¨çš„æ–¹æ¡ˆåŠåŸå› 

| æ–¹æ¡ˆ | ä¸é‡‡ç”¨åŸå›  |
|------|-----------|
| Pandas DataFrame åšæ•°æ®å®¹å™¨ | engine.py å…¨ç¨‹ç”¨ dictï¼Œæ”¹ DataFrame éœ€è¦æ”¹æ‰€æœ‰æ•°æ®è®¿é—®æ–¹å¼ï¼Œæ”¹åŠ¨é¢å¤§ï¼Œæ€§èƒ½å·®è· <5% |
| Polars æ›¿ä»£ | å¼•å…¥æ–°ä¾èµ–ï¼Œè§‚å¯Ÿæ± çŠ¶æ€æœºç”¨ dict å·²è¶³å¤Ÿå¿«ï¼ˆ<1ms/å¤©ï¼‰ |
| Vectorbt | ä¸æ”¯æŒå¤šæ—¥çŠ¶æ€è¿½è¸ªç­–ç•¥ï¼Œéœ€è‡ªå†™ Numba kernelï¼Œå·¥ä½œé‡å¤§ |
| Numba @jit | ç“¶é¢ˆæ˜¯ SQL IO ä¸æ˜¯ Python è®¡ç®—ï¼ŒåŠ é€Ÿå†…å­˜éå†æ— æ„ä¹‰ |
| å®Œå…¨å‘é‡åŒ–è§‚å¯Ÿæ±  | çŠ¶æ€æµè½¬æœ‰æ—¶åºä¾èµ–ï¼ˆä¸­é€”æ­¢æŸ/è¿‡æœŸï¼‰ï¼Œå¸ƒå°”æ©ç æ— æ³•è¡¨è¾¾"ä¸­é€”é€€å‡º"é€»è¾‘ |
| JSON+MD5 åšç¼“å­˜ key | tuple åŸç”Ÿå“ˆå¸Œæ›´å¿«æ›´ç®€æ´ |

### 8.7 åç»­ä¼˜åŒ–æ–¹å‘

1. **é—ä¼ ç®—æ³•**ï¼š6561 ç»„åˆå¤ªå¤šæ—¶ï¼Œç”¨ GA æ›¿ä»£ç½‘æ ¼æœç´¢ï¼Œå‡å°‘è¯„ä¼°æ¬¡æ•°
2. **å¢é‡ä¼˜åŒ–**ï¼šåªå¯¹æœ€è¿‘ N å¤©çš„æ–°æ•°æ®é‡æ–°è¯„ä¼°ï¼Œè€Œéå…¨é‡å›æµ‹
3. **Parquet å¿«ç…§**ï¼šæ¯æ—¥ç›˜åå¯¼å‡º Parquet æ–‡ä»¶ï¼Œå›æµ‹æ—¶ç›´æ¥è¯»æ–‡ä»¶è€Œé SQLï¼ˆè¿›ä¸€æ­¥å‡å°‘é¢„åŠ è½½æ—¶é—´ï¼‰
4. **å¹¶è¡Œé¢„åŠ è½½**ï¼šå¤§ç›˜çŠ¶æ€ã€è¡Œæƒ…æ•°æ®ã€æ”¶ç›Šç‡ä¸‰ä¸ªé¢„åŠ è½½ä»»åŠ¡å¹¶å‘æ‰§è¡Œ
