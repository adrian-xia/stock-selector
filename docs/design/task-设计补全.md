# A股智能选股系统 - 设计文档补全任务清单

> **版本：** v1.0
> **日期：** 2026-02-07
> **目标：** 补全所有设计缺口，统一文档格式，确保每份文档可直接指导 Coding
> **前置依赖：** 00-概要设计-v2.md（已完成）

---

## 一、文档格式统一规范

> **所有新增和修订的文档必须严格遵守以下格式，确保一致性。**

### 1.1 文件命名规则

```
{序号}-{类型}-{模块名}.md

示例：
00-概要设计-v2.md
01-详细设计-数据采集.md
05-详细设计-参数优化.md
10-系统设计-定时任务调度.md
11-系统设计-缓存策略.md
```

### 1.2 文档头部模板（每份文档必须包含）

```markdown
# {文档标题}

> **版本：** v1.0
> **日期：** YYYY-MM-DD
> **关联任务：** Task X.X
> **状态：** Draft / Review / Final
> **前置依赖：** 列出本文档依赖的其他文档编号

---
```

### 1.3 每份详细设计文档必须包含的章节

| 章节 | 必须 | 说明 |
|---|---|---|
| 1. 模块概述 | 是 | 职责、核心挑战、与其他模块的关系 |
| 2. 类图/架构图 | 是 | Mermaid 格式，包含类名、方法签名、依赖关系 |
| 3. 数据库表设计 | 视情况 | 完整 DDL（含字段类型、约束、索引），附字段说明表 |
| 4. 接口定义 | 是 | Python 内部 API 签名 + HTTP API 契约（Request/Response JSON） |
| 5. 核心流程/状态机 | 是 | Mermaid sequenceDiagram 或 stateDiagram |
| 6. 边界条件与异常处理 | 是 | 列表形式，每种异常场景 + 处理方式 |
| 7. 配置项清单 | 是 | 所有可配置参数、默认值、取值范围 |
| 8. 与其他模块的接口契约 | 是 | 本模块对外暴露什么、依赖什么 |

### 1.4 代码示例规范

- 所有伪代码使用 **Python 3.10+ 语法**
- 函数签名必须包含 **类型注解**
- 关键逻辑必须有 **行内注释**
- 涉及数据库操作必须给出 **完整 SQL**（不用 `...` 省略）

### 1.5 图表规范

- 架构图、类图、时序图、状态机统一使用 **Mermaid** 语法
- 数据流图可使用 ASCII Art（如漏斗图）
- 表格使用标准 Markdown 表格，列对齐

---

## 二、任务总览

### 任务分类

| 类别 | 说明 |
|---|---|
| **A - 新增文档** | 概要设计中定义但尚无详细设计的模块 |
| **B - 修订文档** | 已有详细设计但存在缺陷/不一致需要修订 |
| **C - 系统级补充** | 跨模块的系统级设计（不属于任何单一模块） |

### 任务优先级

| 优先级 | 含义 | 时间要求 |
|---|---|---|
| **P0** | Phase 1 开发前必须完成 | 立即 |
| **P1** | Phase 2 开发前必须完成 | Phase 1 期间完成 |
| **P2** | Phase 3+ 开发前完成即可 | Phase 2 期间完成 |

### 任务完成状态总表

> 状态说明：⬜ 未开始 | 🔵 进行中 | ✅ 已完成 | ⏸️ 阻塞中

| 任务编号 | 类别 | 文档/内容 | 优先级 | 状态 | 负责人 | 开始日期 | 完成日期 | 备注 |
|---|---|---|---|---|---|---|---|---|
| **A1** | 新增 | `05-详细设计-参数优化.md` | P1 | ⏸️ V2 | - | - | - | V1 不实现 |
| **A2** | 新增 | `06-详细设计-新闻舆情监控.md` | P1 | ⏸️ V2 | - | - | - | V1 不实现 |
| **A3** | 新增 | `07-详细设计-实时监控与告警.md` | P1 | ⏸️ V2 | - | - | - | V1 不实现 |
| **A4** | 新增 | `08-详细设计-高手跟投监控.md` | P2 | ⏸️ V2 | - | - | - | V1 不实现 |
| **A5** | 新增 | `09-详细设计-用户与权限.md` | P2 | ❌ 删除 | - | - | - | 单人不需要 |
| **B1** | 修订 | `01-详细设计-数据采集.md` | P0 | ✅ 已完成 | - | 2026-02-07 | 2026-02-07 | 新增章节 8-12 |
| **B2** | 修订 | `02-详细设计-策略引擎.md` | P0 | ✅ 已完成 | - | 2026-02-07 | 2026-02-07 | 新增章节 6-12 |
| **B3** | 修订 | `03-详细设计-AI与回测.md` | P0 | ✅ 已完成 | - | 2026-02-07 | 2026-02-07 | 新增章节 0,1.4,14-18 |
| **B4** | 修订 | `04-详细设计-前端与交互.md` | P1 | ✅ 已完成 | - | 2026-02-07 | 2026-02-07 | 新增章节 4-11，V1 简化 |
| **C1** | 系统级 | `10-系统设计-定时任务调度.md` | P0 | ✅ 已完成 | - | 2026-02-07 | 2026-02-07 | 含 11 个章节 |
| **C2** | 系统级 | `11-系统设计-缓存策略.md` | P0 | ✅ 已完成 | - | 2026-02-07 | 2026-02-07 | V1 简化版，含 8 个章节 |
| **C3** | 系统级 | `12-系统设计-安全设计.md` | P1 | ❌ 删除 | - | - | - | 单人不需要 |
| **C4** | 系统级 | `13-系统设计-测试策略.md` | P1 | ✅ 已完成 | - | 2026-02-07 | 2026-02-07 | V1 简化版，含 6 个章节 |
| **C5** | 系统级 | `14-系统设计-数据库迁移与运维.md` | P0 | ⏸️ V2 | - | - | - | V1 手动管理 schema |

**进度统计：** 7 / 14 完成（50%）| 5 推迟至 V2 | 2 删除

---

## 三、A 类任务 - 新增文档

### Task A1：新增 `05-详细设计-参数优化.md`

**优先级：P1** | **状态：⬜ 未开始** | **关联概要设计：** 模块 5

**当前问题：**
概要设计仅一段话描述（网格搜索、Walk Forward Analysis），无法指导编码。

**文档必须包含：**

1. **参数空间定义规范**
   - 每种策略的可调参数清单（参数名、类型、取值范围、步长、默认值）
   - 示例：MA 金叉策略 → `fast_period: int, range(3, 20, 1), default=5`
   - 参数组合爆炸的预估公式与上限控制

2. **优化算法详细设计**
   - **网格搜索（Grid Search）：** 遍历逻辑、并行化方案（多进程 vs asyncio）、结果存储结构
   - **随机搜索（Random Search）：** 采样策略、样本量计算
   - **Walk Forward Analysis：**
     - 滚动窗口划分规则（训练集:验证集 = 3:1）
     - 窗口滑动步长
     - 参数稳定性评分算法（同一参数在不同窗口的表现方差）
   - 每种算法的适用场景判断规则

3. **过拟合检测机制**
   - 训练集 vs 测试集收益差异阈值（如差异 > 30% 判定为过拟合）
   - 参数敏感性分析（微调参数 ±10%，收益变化是否剧烈）
   - 最小样本量要求（回测交易次数 > 30 笔才有统计意义）

4. **数据库表设计**
   - `optimization_task` 表：任务 ID、策略 ID、参数空间 JSON、状态、创建时间
   - `optimization_result` 表：任务 ID、参数组合 JSON、年化收益、最大回撤、夏普比率、交易次数

5. **接口定义**
   - `POST /api/v1/optimize/run` — 提交优化任务
   - `GET /api/v1/optimize/result/{task_id}` — 获取优化结果
   - 内部 Python API：`async def run_optimization(strategy_id, param_space, method) -> OptResult`

---

### Task A2：新增 `06-详细设计-新闻舆情监控.md`

**优先级：P1** | **状态：⬜ 未开始** | **关联概要设计：** 模块 8

**当前问题：**
概要设计有数据源列表和 NLP 流程概述，但爬虫架构、反爬策略、数据存储、聚合算法均未展开。

**文档必须包含：**

1. **爬虫架构设计**
   - 类图：`BaseSpider` 基类 → `CailianSpider`（财联社）、`EastMoneySpider`（东财公告）、`TaogubaSpider`（淘股吧）、`XueqiuSpider`（雪球）
   - 每个爬虫的目标 URL、请求频率（遵守 Robots 协议）、解析规则
   - 反爬应对：User-Agent 轮换、请求间隔（3-5s）、代理池（可选）、Cookie 管理
   - 爬虫失败重试策略（指数退避，最多 3 次）

2. **数据存储设计**
   - `news_raw` 表：原始采集数据（标题、来源、URL、采集时间、原始 HTML 摘要）
   - `news_sentiment` 表：AI 分析结果（新闻 ID、关联股票代码、情感分 -100~+100、事件类型、影响周期、分析模型、分析时间）
   - `stock_sentiment_daily` 表：个股每日舆情聚合指数
   - **不存储正文全文**（合规要求）

3. **NLP 情感分析 Pipeline**
   - 清洗规则：去 HTML 标签、去广告关键词、去重（标题相似度 > 90% 判定重复）
   - 分类规则：事件类型枚举（业绩、并购、减持、政策、处罚、回购、增持、其他）
   - AI 打分 Prompt 模板（输入格式、输出 JSON Schema）
   - 批量处理策略：攒够 10 条新闻一次性发给 Gemini（节省 API 调用次数）

4. **舆情指数聚合算法**
   - 公式：`DailySentiment = Σ(score_i × weight_i × decay_i)`
   - `weight_i`：按新闻来源权重（公告 > 财联社 > 研报 > 论坛）
   - `decay_i`：时间衰减因子（24h 内权重 1.0，48h 内 0.5，72h 内 0.2）
   - 异常值处理：单条新闻 score 绝对值 > 80 需人工确认标记

5. **定时任务**
   - 财联社快讯：每 10 分钟采集一次（盘中）
   - 东财公告：每日 20:00 批量采集
   - 淘股吧/雪球：每日 21:00 采集热门帖
   - AI 分析：每批新闻采集后立即触发

6. **合规性设计**
   - Robots.txt 检查逻辑
   - 请求频率限制的配置化
   - 数据保留策略（原始数据保留 30 天，分析结果永久保留）

---

### Task A3：新增 `07-详细设计-实时监控与告警.md`

**优先级：P1** | **状态：⬜ 未开始** | **关联概要设计：** 模块 10

**当前问题：**
概要设计有防抖动伪代码，但 WebSocket 架构、告警规则引擎、通知渠道集成缺少完整设计。

**文档必须包含：**

1. **实时行情数据流架构**
   ```
   AKShare WebSocket → Redis Pub/Sub → 行情处理 Worker → 指标实时计算
                                      ↓
                              WebSocket Server → 前端推送
                                      ↓
                              告警规则引擎 → 通知分发
   ```
   - Redis Pub/Sub Channel 设计：`market:realtime:{ts_code}`
   - 行情数据结构定义（JSON Schema）
   - 前端 WebSocket 订阅/取消订阅协议

2. **告警规则引擎**
   - 规则数据结构：
     ```python
     class AlertRule:
         rule_id: str
         rule_type: str          # price_break / strategy_signal / news_urgent
         target_codes: List[str] # 监控的股票列表
         condition: Dict         # 触发条件 JSON
         priority: int           # 1-4
         cooldown_seconds: int   # 冷却时间
         channels: List[str]     # 通知渠道 ["telegram", "web", "email"]
     ```
   - 内置规则类型清单（价格突破、策略信号、舆情预警、涨跌停预警）
   - 用户自定义规则的 DSL 设计（如 `price > 100 AND vol > vol_ma5 * 2`）

3. **防抖动状态机**（细化概要设计中的伪代码）
   - 完整状态图（Mermaid stateDiagram）
   - 冷却期配置表（每种告警类型的默认冷却时间）
   - 状态持续确认逻辑（N 根 K 线确认）
   - 优先级队列的实现方案（Redis Sorted Set）

4. **通知渠道集成**
   - Telegram Bot：Bot Token 配置、消息格式模板、群组/私聊选择
   - Web 弹窗：WebSocket 推送 + 前端 Notification API
   - 邮件：盘后日报模板、SMTP 配置
   - 每种渠道的失败重试策略

5. **数据库表设计**
   - `alert_rules` 表：用户配置的告警规则
   - `alert_history` 表：已触发的告警记录（用于审计和防抖动判断）
   - `alert_cooldown_state` 表（或 Redis Key）：当前冷却状态

6. **性能约束**
   - 盘中监控股票上限：50 只（自选股池）
   - 行情处理延迟目标：< 500ms（从数据到达到告警发出）
   - WebSocket 并发连接数设计

---

### Task A4：新增 `08-详细设计-高手跟投监控.md`

**优先级：P2** | **状态：⬜ 未开始** | **关联概要设计：** 模块 9

**当前问题：**
概要设计有监控对象和"逻辑还原"概念，但数据采集方式、AI 分析流程、信号生成规则均未设计。

**文档必须包含：**

1. **数据源接入设计**
   - 淘股吧百万实盘：数据获取方式（页面解析 vs API）、更新频率、字段定义
   - 雪球组合：组合调仓数据获取、历史持仓快照
   - 龙虎榜席位：AKShare 龙虎榜接口 → 席位识别（知名游资席位映射表）
   - 公募基金重仓：季报披露后批量获取

2. **"逻辑还原" AI 分析流程**
   - 输入：高手买入记录 + 当日新闻 + 板块热点 + 技术形态
   - Prompt 模板设计
   - 输出：逻辑分类（题材博弈 / 业绩驱动 / 技术突破 / 无法判断）
   - 置信度评分

3. **跟投信号生成规则**
   - 信号触发条件（AI 理解逻辑 + 置信度 > 70%）
   - 信号过滤条件（排除已涨停、排除流动性差的）
   - 信号有效期（T+0 当日有效 / T+1 次日有效）

4. **数据库表设计**
   - `expert_profiles` 表：高手档案（来源、ID、风格标签、历史胜率）
   - `expert_trades` 表：高手交易记录
   - `follow_signals` 表：生成的跟投信号

---

### Task A5：新增 `09-详细设计-用户与权限.md`

**优先级：P2** | **状态：⬜ 未开始** | **关联概要设计：** 模块 11

**当前问题：**
概要设计仅三行描述（JWT、隔离、权限），无法指导编码。

**文档必须包含：**

1. **认证流程**
   - JWT 签发流程（登录 → 生成 Access Token + Refresh Token）
   - Token 刷新机制（Access Token 过期时间 30min，Refresh Token 7 天）
   - Token 吊销方案（Redis 黑名单）
   - 密码存储（bcrypt 哈希 + salt）

2. **权限模型**
   - RBAC 角色定义：Admin / User / ReadOnly
   - 权限矩阵表（角色 × 资源 × 操作）
   - API 鉴权中间件设计（FastAPI Depends）

3. **数据隔离**
   - 用户数据隔离方案（所有业务表增加 `user_id` 字段 + 查询自动过滤）
   - 自选股、策略配置、回测记录的隔离

4. **数据库表设计**
   - `users` 表：用户 ID、用户名、密码哈希、角色、创建时间、最后登录
   - `user_settings` 表：用户个性化配置（默认数据源、AI 模型偏好、通知渠道）
   - `user_watchlist` 表：自选股列表

5. **API 接口**
   - `POST /api/v1/auth/login` — 登录
   - `POST /api/v1/auth/refresh` — 刷新 Token
   - `GET /api/v1/user/profile` — 获取用户信息
   - `PUT /api/v1/user/settings` — 更新设置

---

## 四、B 类任务 - 修订已有文档

### Task B1：修订 `01-详细设计-数据采集.md`

**优先级：P0** | **状态：⬜ 未开始**

**需要修订的内容：**

1. **补充：首次全量导入 vs 日常增量更新**
   - 首次全量导入流程（可能需要数天，需要断点续传机制）
   - 增量更新流程（每日只同步当天数据）
   - 历史数据补全策略（BaoStock 分钟线只有最近一年的限制，如何补全更早数据）

2. **补充：数据质量监控报告**
   - 每日数据同步完成后，生成质量报告
   - 报告内容：同步股票数、缺失股票列表、异常值数量、数据源使用情况
   - 报告存储表 `data_quality_report` 的 DDL

3. **补充：标准层完整 DDL**
   - 当前只有 raw 层的表结构，标准层 `stock_daily` 的完整 DDL 在概要设计中
   - 需要在本文档中也包含完整的标准层 DDL（保持单一信息源）

4. **补充：配置项清单**
   - 每个数据源的配置项（Token、QPS 限制、超时时间、重试次数）
   - 定时任务的 cron 表达式
   - 数据完整性校验的阈值参数

---

### Task B2：修订 `02-详细设计-策略引擎.md`

**优先级：P0** | **状态：⬜ 未开始**

**需要修订的内容：**

1. **修复：`BaseStrategy.run()` 接口签名不一致**
   - 类图中返回 `Series[bool]`（批量向量化），接口定义中返回 `bool`（逐只）
   - **决策：** 统一为两层接口
     ```python
     class BaseStrategy(ABC):
         # 批量筛选（Layer 2 向量化初筛使用）
         async def filter_batch(self, df: DataFrame) -> Series[bool]: ...
         # 单只精筛（Layer 4 逐只精筛使用）
         async def check_single(self, ts_code: str, date: date) -> bool: ...
     ```
   - 明确哪些策略实现 `filter_batch`（简单指标类），哪些实现 `check_single`（复杂形态类）

2. **补充：策略组合逻辑的数据结构**
   - 前端文档提到支持 AND/OR 组合，但策略引擎中没有对应设计
   - 需要定义：
     ```python
     class StrategyGroup:
         operator: str  # "AND" / "OR"
         strategies: List[Union[BaseStrategy, StrategyGroup]]  # 支持嵌套
     ```
   - 组合执行逻辑的伪代码

3. **补充：策略注册与发现机制**
   - `StrategyFactory.register()` 是手动注册还是自动扫描？
   - 建议：使用 Python 装饰器自动注册
     ```python
     @register_strategy(name="ma_cross", category="technical")
     class MACrossStrategy(TechnicalStrategy): ...
     ```
   - 策略元数据定义（名称、分类、参数 Schema、描述、作者、版本）

4. **补充：策略版本管理**
   - 用户修改策略参数后，回测结果如何关联到当时的参数快照
   - `strategy_versions` 表设计

5. **补充：Pipeline 层级与概要设计对齐**
   - 当前概要设计第 4 层是"事件驱动筛选"，策略引擎第 4 层是"策略精筛"
   - 需要统一为一致的 5 层定义，并在两份文档中保持同步

6. **补充：配置项清单**
   - Pipeline 每层的阈值参数（可配置化）
   - 并发执行的最大协程数
   - 内存管理的数据窗口大小

---

### Task B3：修订 `03-详细设计-AI与回测.md`

**优先级：P0** | **状态：⬜ 未开始**

**需要修订的内容：**

1. **补充：AI 模型降级与容错**
   - 参照数据采集模块的故障切换状态机，设计 AI 模型的降级链路
   - Claude 超时/限流 → 降级到 DeepSeek 做逻辑校验
   - Gemini 不可用 → 降级到 DeepSeek 做新闻分析
   - 所有模型不可用 → 跳过 AI 层，仅输出量化筛选结果 + 标记"未经 AI 验证"

2. **补充：Prompt 版本管理**
   - `prompt_templates` 表设计（模板 ID、模型、场景、版本号、模板内容、生效时间）
   - Prompt A/B 测试机制（同一批股票用两个版本的 Prompt 分析，对比结果差异）

3. **补充：回测结果存储**
   - `backtest_tasks` 表：任务 ID、策略 ID、参数快照 JSON、回测区间、初始资金、状态、创建时间
   - `backtest_results` 表：任务 ID、年化收益率、最大回撤、夏普比率、胜率、盈亏比、总交易次数
   - `backtest_trades` 表：任务 ID、股票代码、买入日期、买入价、卖出日期、卖出价、收益率
   - `backtest_equity_curve` 表：任务 ID、日期、净值（用于绘制收益曲线）

4. **补充：涨跌停限制实现方案**
   - Backtrader 默认不处理涨跌停，需要自定义 `Broker` 或 `Sizer`
   - 实现逻辑：
     ```python
     # 在 next() 中检查
     if order.isbuy() and data.close[0] >= data.close[-1] * 1.1:
         # 涨停，无法买入，取消订单
         self.cancel(order)
     if order.issell() and data.close[0] <= data.close[-1] * 0.9:
         # 跌停，无法卖出，取消订单
         self.cancel(order)
     ```
   - 科创板/创业板 20% 涨跌停的特殊处理
   - ST 股 5% 涨跌停的特殊处理

5. **补充：多股票组合回测**
   - 仓位分配策略（等权重 / 按评分加权 / 按波动率倒数加权）
   - 调仓频率（每日 / 每周 / 每月）
   - 最大持仓数量限制
   - 组合回测的 Backtrader 实现方案（多 Data Feed + 自定义 Sizer）

6. **补充：复权计算统一方案**
   - 当前 01-数据采集说"回测时动态计算"，03-回测说"传入复权后价格"
   - **统一决策：** 在数据加载层（`load_data` 函数）做前复权，Backtrader 接收复权后价格
   - 复权因子更新时的历史数据重算策略

7. **补充：AI 模型版本抽象**
   - 不硬编码 "Claude 3.5 Sonnet"，改为配置化
   - `ai_model_config` 表：模型别名、Provider、Model ID、API Endpoint、Token 价格

---

### Task B4：修订 `04-详细设计-前端与交互.md`

**优先级：P1** | **状态：⬜ 未开始**

**需要修订的内容：**

1. **补充：路由设计**
   ```
   /                          → 重定向到 /workbench
   /workbench                 → 智能选股工作台
   /backtest                  → 回测任务列表
   /backtest/:taskId          → 回测结果详情
   /backtest/new              → 新建回测任务
   /monitor                   → 实时监控看板
   /monitor/alerts            → 告警历史
   /news                      → 新闻舆情仪表盘
   /settings                  → 用户设置
   /login                     → 登录页
   ```

2. **补充：状态管理设计**
   - Zustand Store 结构定义：
     - `useStrategyStore`：当前策略配置、筛选结果、运行状态
     - `useBacktestStore`：回测任务列表、当前查看的回测结果
     - `useMarketStore`：实时行情数据、WebSocket 连接状态
     - `useAuthStore`：用户信息、Token
   - React Query 缓存策略（staleTime、cacheTime 配置）

3. **补充：完整 API 契约**
   - 策略 CRUD：
     - `GET /api/v1/strategy/list` — 获取已保存策略列表
     - `POST /api/v1/strategy/save` — 保存策略配置
     - `DELETE /api/v1/strategy/{id}` — 删除策略
   - 回测：
     - `POST /api/v1/backtest/run` — 提交回测任务
     - `GET /api/v1/backtest/list` — 回测任务列表
     - `GET /api/v1/backtest/result/{taskId}` — 回测结果
     - `GET /api/v1/backtest/equity/{taskId}` — 收益曲线数据
   - 数据查询：
     - `GET /api/v1/data/kline/{tsCode}` — K 线数据
     - `GET /api/v1/data/realtime/{tsCode}` — 实时行情
   - 自选股：
     - `GET /api/v1/watchlist` — 自选股列表
     - `POST /api/v1/watchlist/add` — 添加自选
     - `DELETE /api/v1/watchlist/{tsCode}` — 删除自选
   - 每个接口必须包含完整的 Request/Response JSON 示例

4. **补充：错误处理 UI 设计**
   - API 请求失败：Toast 提示 + 重试按钮
   - WebSocket 断连：顶部 Banner 提示"连接已断开，正在重连..."，自动重连（指数退避）
   - 任务超时：进度条停滞 > 5 分钟，显示"任务可能异常"提示
   - 统一错误码定义（与后端对齐）

5. **补充：AI 流式输出 UI**
   - 确认采用 SSE（Server-Sent Events）实现打字机效果
   - 前端 `EventSource` 接入方案
   - 流式渲染组件设计

---

## 五、C 类任务 - 系统级补充文档

### Task C1：新增 `10-系统设计-定时任务调度.md`

**优先级：P0** | **状态：⬜ 未开始**

**当前问题：**
各模块各自提到定时任务，但没有一份全局的任务编排文档，存在时间冲突和依赖遗漏风险。

**文档必须包含：**

1. **每日任务调度总表**

   | 时间 | 任务名 | 模块 | 依赖 | 预计耗时 | 失败策略 |
   |---|---|---|---|---|---|
   | 15:05 | 实时行情停止采集 | 模块 10 | 无 | - | - |
   | 15:30 | AKShare 日线同步 | 模块 1 | 无 | 10min | 重试 3 次 |
   | 16:00 | BaoStock 日线同步 | 模块 1 | 无 | 20min | 切换 AKShare |
   | 16:30 | ETL 清洗 | 模块 1 | 日线同步完成 | 15min | 告警 |
   | 17:00 | 技术指标预计算 | 模块 2 | ETL 完成 | 20min | 告警 |
   | 17:30 | 策略管道执行 | 模块 3 | 指标计算完成 | 20min | 告警 |
   | 18:00 | AI 分析（Top 30） | 模块 7 | 策略管道完成 | 10min | 跳过 AI |
   | 18:30 | 生成每日选股报告 | 模块 10 | AI 分析完成 | 5min | 发送无 AI 版本 |
   | 20:00 | 东财公告采集 | 模块 8 | 无 | 15min | 次日补采 |
   | 21:00 | 舆情采集 | 模块 8 | 无 | 10min | 次日补采 |
   | 每周六 20:00 | 财务数据同步 | 模块 1 | 无 | 60min | 次周补同步 |

2. **任务依赖链路图**（Mermaid DAG）

3. **APScheduler 配置方案**
   - Job Store：使用 PostgreSQL 持久化（防止重启丢失）
   - Executor：ThreadPoolExecutor（IO 密集型任务）
   - 任务锁：防止同一任务重复执行（Redis 分布式锁）

4. **失败处理与告警**
   - 每个任务的最大重试次数和重试间隔
   - 任务链中某环节失败后，下游任务的处理策略（等待 / 跳过 / 使用昨日数据）
   - 失败告警通知（Telegram / 邮件）

5. **手动触发机制**
   - API 接口：`POST /api/v1/admin/task/trigger/{task_name}` — 手动触发任意任务
   - 补数据场景：指定日期重跑某个任务

---

### Task C2：新增 `11-系统设计-缓存策略.md`

**优先级：P0** | **状态：⬜ 未开始**

**当前问题：**
概要设计提到 Redis，但没有定义缓存什么、怎么缓存、怎么失效。

**文档必须包含：**

1. **Redis 数据结构设计**

   | Key 模式 | 数据结构 | 内容 | TTL | 写入时机 |
   |---|---|---|---|---|
   | `tech:{ts_code}:latest` | Hash | 最新技术指标 | 24h | 技术指标预计算后 |
   | `market:realtime:{ts_code}` | String(JSON) | 实时行情快照 | 10s | 行情推送时 |
   | `pipeline:result:{date}` | List(JSON) | 当日选股结果 | 48h | 策略管道完成后 |
   | `task:lock:{task_name}` | String | 分布式锁 | 自动释放 | 任务开始时 |
   | `session:{user_id}` | String | JWT 黑名单 | 与 Token 同 | 用户登出时 |
   | `alert:cooldown:{code}:{type}` | String | 告警冷却标记 | 按类型配置 | 告警发出后 |
   | `ws:subscribers:{channel}` | Set | WebSocket 订阅者 | 无 | 用户订阅时 |

2. **缓存与 DB 一致性策略**
   - 写入策略：Cache-Aside（先写 DB，再删缓存）
   - 读取策略：先读 Redis，Miss 则读 DB 并回填
   - 定时刷新：技术指标缓存每日 17:00 全量刷新

3. **Redis 部署配置**
   - 内存上限：512MB（足够覆盖 5000 只股票的指标缓存）
   - 淘汰策略：`allkeys-lru`
   - 持久化：AOF（appendonly yes）

---

### Task C3：新增 `12-系统设计-安全设计.md`

**优先级：P1** | **状态：⬜ 未开始**

**文档必须包含：**

1. **API 安全**
   - CORS 配置（允许的 Origin 列表）
   - Rate Limiting（每用户每分钟 60 次请求，使用 Redis 计数器）
   - 请求体大小限制（防止恶意大 payload）
   - HTTPS 强制（Nginx 配置 SSL）

2. **敏感信息管理**
   - API Key（Tushare Token、AI API Key）存储方案：环境变量 + `.env` 文件，不入库不入 Git
   - 数据库密码：Docker Compose 环境变量注入
   - JWT Secret：随机生成，环境变量存储

3. **输入验证**
   - Pydantic Model 强制校验所有 API 输入
   - SQL 注入防护：全部使用 SQLAlchemy ORM 或参数化查询，禁止字符串拼接 SQL
   - XSS 防护：前端 React 默认转义 + CSP Header

4. **审计日志**
   - 记录所有敏感操作（登录、策略修改、回测提交、AI 调用）
   - `audit_log` 表设计

---

### Task C4：新增 `13-系统设计-测试策略.md`

**优先级：P1** | **状态：⬜ 未开始**

**文档必须包含：**

1. **测试分层**

   | 层级 | 范围 | 工具 | 覆盖率要求 |
   |---|---|---|---|
   | 单元测试 | 策略逻辑、ETL 函数、工具函数 | pytest + pytest-asyncio | > 80% |
   | 集成测试 | 数据采集→ETL→策略执行 端到端 | pytest + testcontainers | 核心链路 100% |
   | API 测试 | HTTP 接口契约验证 | pytest + httpx | 所有接口 |
   | 回测验证 | 已知数据集的策略结果验证 | 自定义 | 每种策略至少 1 个 |

2. **Mock 策略**
   - 数据源 Mock：预录制 BaoStock/AKShare 的返回数据，存为 JSON fixture
   - AI 模型 Mock：预设固定的 AI 返回结果
   - Redis Mock：使用 fakeredis

3. **策略逻辑测试方法**
   - 构造已知结果的历史数据（如手动构造一个"金叉"场景）
   - 验证策略输出是否符合预期
   - 边界测试：停牌日、除权日、数据不足、全为 NULL

4. **CI 集成**
   - GitHub Actions 配置
   - 每次 PR 自动运行单元测试 + API 测试
   - 每周自动运行集成测试

---

### Task C5：新增 `14-系统设计-数据库迁移与运维.md`

**优先级：P0** | **状态：⬜ 未开始**

**文档必须包含：**

1. **Alembic 迁移方案**
   - 初始化配置（`alembic init`）
   - 迁移脚本命名规范：`{序号}_{描述}.py`
   - 自动生成 vs 手动编写的选择标准
   - 回滚策略

2. **备份与恢复**
   - 备份频率：每日凌晨 2:00 全量备份（pg_dump）
   - 备份保留策略：最近 7 天每日备份 + 最近 4 周每周备份
   - 恢复演练频率：每月一次
   - RTO 目标：< 1 小时
   - RPO 目标：< 24 小时

3. **系统自身监控**
   - 监控指标清单：
     - PostgreSQL：连接数、慢查询、表大小、死锁
     - Redis：内存使用、命中率、连接数
     - FastAPI：请求延迟 P99、错误率、QPS
     - Celery Worker：队列深度、任务成功率、Worker 存活
   - 监控工具选型：Prometheus + Grafana（或轻量替代方案）
   - 告警阈值配置

4. **日志规范**
   - 统一日志格式：`{timestamp} | {level} | {module} | {message} | {extra_json}`
   - 日志级别使用规范：
     - ERROR：需要人工介入的异常
     - WARNING：可自动恢复的异常（如数据源切换）
     - INFO：关键业务节点（任务开始/完成）
     - DEBUG：详细调试信息（仅开发环境）
   - 日志收集：Docker 日志 → Loki → Grafana（或文件轮转 + logrotate）

---

## 六、任务执行顺序与依赖关系

```
Phase 0 补全设计（按以下顺序执行）：

  ┌─ P0 任务（Phase 1 开发前必须完成）─────────────────────────┐
  │                                                              │
  │  Task C1 (定时任务调度)  ←── 所有模块的定时任务汇总于此      │
  │       ↓                                                      │
  │  Task B1 (修订-数据采集) ──→ Task B2 (修订-策略引擎)         │
  │       ↓                           ↓                          │
  │  Task C2 (缓存策略)         Task B3 (修订-AI与回测)          │
  │       ↓                           ↓                          │
  │  Task C5 (数据库迁移与运维)  ←── 所有表设计确定后             │
  │                                                              │
  └──────────────────────────────────────────────────────────────┘

  ┌─ P1 任务（Phase 1 期间完成）────────────────────────────────┐
  │                                                              │
  │  Task A1 (参数优化)     Task A2 (新闻舆情)                   │
  │  Task A3 (实时监控)     Task B4 (修订-前端)                  │
  │  Task C3 (安全设计)     Task C4 (测试策略)                   │
  │                                                              │
  └──────────────────────────────────────────────────────────────┘

  ┌─ P2 任务（Phase 2 期间完成）────────────────────────────────┐
  │                                                              │
  │  Task A4 (高手跟投)     Task A5 (用户与权限)                 │
  │                                                              │
  └──────────────────────────────────────────────────────────────┘
```

---

## 七、验收标准

每份文档完成后，需通过以下 Checklist：

- [ ] 文档头部信息完整（版本、日期、关联任务、状态、前置依赖）
- [ ] 包含所有必须章节（模块概述、类图、表设计、接口定义、流程图、异常处理、配置项）
- [ ] 所有类图/时序图/状态机使用 Mermaid 语法且可正确渲染
- [ ] 所有数据库表给出完整 DDL（含字段类型、约束、索引、注释）
- [ ] 所有 Python 接口有完整类型注解
- [ ] 所有 HTTP API 有 Request/Response JSON 示例
- [ ] 与其他文档无矛盾（特别是接口签名、Pipeline 层级、复权方案）
- [ ] 边界条件和异常场景有明确处理方案
- [ ] 配置项有默认值和取值范围说明
- [ ] 可直接作为 Coding 的输入，开发者无需再猜测任何设计意图
