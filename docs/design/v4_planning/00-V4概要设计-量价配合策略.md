# V4 概要设计：量价配合策略（放量突破 + 缩量回踩）

> **版本：** v1.1
> **日期：** 2026-02-27
> **优先级：** P0（最高优先级）
> **状态：** Draft
> **原始需求：** Adrian 提供的"龙回头/老鸭头"形态量化方案

---

## 1. 策略概述

### 1.1 核心逻辑

捕捉主力资金完成建仓后的"洗盘企稳"买点。策略分四个阶段：

1. **吸筹阶段** — 小阴小阳窄幅震荡，成交量低迷
2. **抢筹阶段（T0）** — 巨量阳线突破，主力点火拉升
3. **洗盘阶段（T1~Tk）** — 缩量回落，价格不破 T0 开盘价
4. **企稳买点（Tk）** — 极度缩量 + 均线支撑 + K线收敛 → 触发选股

### 1.2 与现有系统的关系

本策略是现有 34 个策略之外的**第 35 个策略**，但与其他策略有本质区别：

| 维度 | 现有策略 | 量价配合策略 |
|------|---------|-------------|
| 时间跨度 | 单日快照判断 | 多日状态追踪（T0 → Tk，跨 3~8 个交易日） |
| 数据依赖 | 当日 + 前日指标 | 需要回溯 60 日的完整 K 线序列（约3个月，覆盖主力吸筹周期） |
| 筛选维度 | 个股独立判断 | 需联动大盘指数 + 行业板块 |
| 触发方式 | 每日全量扫描 | 事件驱动：先发现 T0，再持续追踪至 Tk |

### 1.3 设计目标

- 完全融入现有 Pipeline 架构（BaseStrategy 继承体系）
- 新增"观察池"机制，支持多日状态追踪
- 引入大盘环境过滤和行业共振加分
- 不影响现有 34 个策略的运行

---

## 2. 三维模型设计

采用"自上而下"的分层过滤架构：

```
┌─────────────────────────────────────────┐
│  第一维：大盘环境过滤 (Market Filter)     │  ← 决定"能不能做"
│  沪深300/万得全A 均线位置 + MACD 状态     │
├─────────────────────────────────────────┤
│  第二维：行业板块共振 (Sector Alpha)      │  ← 决定"去哪里做"
│  板块动量排名 + 相对强度 + 集群放量检测    │
├─────────────────────────────────────────┤
│  第三维：个股量价形态 (Technical Setup)    │  ← 决定"买什么、何时买"
│  T0 识别 → 观察池追踪 → Tk 企稳触发      │
└─────────────────────────────────────────┘
```

---

## 3. 系统架构变更

### 3.1 新增模块

```
app/strategy/
├── technical/
│   └── volume_price_pattern.py      # 量价配合策略主体
├── watchpool/
│   ├── __init__.py
│   ├── manager.py                   # 观察池管理器
│   └── models.py                    # 观察池数据模型
└── filters/
    ├── __init__.py
    ├── market_filter.py             # 大盘环境过滤器
    └── sector_filter.py             # 行业板块共振过滤器

app/backtest/
├── __init__.py
├── engine.py                        # 回测引擎（逐日模拟）
├── evaluator.py                     # 评估指标计算
├── grid_search.py                   # 参数网格搜索
├── models.py                        # 数据模型
├── queries.py                       # SQL 查询语句
└── router.py                        # FastAPI 路由
```

### 3.2 新增数据库表

```sql
-- 观察池：追踪 T0 事件及后续状态
CREATE TABLE strategy_watchpool (
    id SERIAL PRIMARY KEY,
    ts_code VARCHAR(16) NOT NULL,
    strategy_name VARCHAR(64) NOT NULL DEFAULT 'volume-price-pattern',
    t0_date DATE NOT NULL,                    -- T0 放量突破日
    t0_close NUMERIC(20,4),                   -- T0 收盘价
    t0_open NUMERIC(20,4),                    -- T0 开盘价（止损参考）
    t0_low NUMERIC(20,4),                     -- T0 最低价（硬止损线）
    t0_volume BIGINT,                         -- T0 成交量
    t0_pct_chg NUMERIC(10,4),                 -- T0 涨幅
    status VARCHAR(16) NOT NULL DEFAULT 'watching',  -- watching/triggered/expired/stopped
    washout_days INT DEFAULT 0,               -- 已回踩天数
    min_washout_vol BIGINT,                   -- 回踩期间最小成交量
    min_washout_low NUMERIC(20,4),            -- 回踩期间最低价
    sector_score NUMERIC(10,4),               -- 行业共振得分
    market_score NUMERIC(10,4),               -- 大盘环境得分
    triggered_date DATE,                      -- 触发选股的日期
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(ts_code, t0_date, strategy_name)
);

CREATE INDEX idx_watchpool_status ON strategy_watchpool(status);
CREATE INDEX idx_watchpool_date ON strategy_watchpool(t0_date);

-- 回测结果：存储每次回测/网格搜索的参数与评估指标
CREATE TABLE backtest_results (
    id SERIAL PRIMARY KEY,
    run_id UUID NOT NULL DEFAULT gen_random_uuid(),
    strategy_name VARCHAR(64) NOT NULL DEFAULT 'volume-price-pattern',
    params JSONB NOT NULL,                    -- 本次回测使用的参数
    backtest_start DATE NOT NULL,
    backtest_end DATE NOT NULL,
    total_signals INT,
    signals_per_month NUMERIC(8,2),
    win_rate_1d NUMERIC(6,4),
    win_rate_3d NUMERIC(6,4),
    win_rate_5d NUMERIC(6,4),
    win_rate_10d NUMERIC(6,4),
    avg_ret_5d NUMERIC(8,4),
    profit_loss_ratio NUMERIC(8,4),
    max_drawdown NUMERIC(8,4),
    sharpe_ratio NUMERIC(8,4),
    composite_score NUMERIC(8,4),
    signals JSONB,                            -- 信号明细
    is_grid_search BOOLEAN DEFAULT FALSE,
    grid_search_id UUID,
    rank_in_grid INT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_backtest_run_id ON backtest_results(run_id);
CREATE INDEX idx_backtest_grid_id ON backtest_results(grid_search_id);
CREATE INDEX idx_backtest_score ON backtest_results(composite_score DESC);
```

### 3.3 Pipeline 集成方式

量价配合策略在 Pipeline 中的执行分两步：

```
盘后链路执行流程：
  Step 1-4: 数据同步（不变）
  Step 5: 策略执行
    ├── Layer1: SQL 粗筛（不变）
    ├── Layer2: 技术面策略（现有 22 个 + 量价配合策略）
    │   └── volume-price-pattern 策略内部：
    │       ├── (a) 大盘环境检查 → 决定是否执行
    │       ├── (b) 扫描新 T0 事件 → 写入观察池
    │       ├── (c) 更新观察池状态（回踩天数、缩量程度）
    │       ├── (d) 检测 Tk 企稳信号 → 输出选股结果
    │       └── (e) 过期/止损清理
    ├── Layer3: 基本面策略（不变）
    └── Layer4: 加权排序（不变）
```

---

## 4. 实施范围

### V4-1：量价配合策略核心（P0）
- 个股四阶段形态识别
- 观察池管理（新增表 + CRUD）
- 融入现有 Pipeline

### V4-2：大盘环境过滤（P0）
- 沪深300 均线位置判断
- MACD 零轴/金叉状态
- 三档仓位控制（全仓/半仓/空仓）

### V4-3：行业板块共振（P1）
- 板块动量排名（5日/10日涨幅）
- 相对强度 RS 计算
- 集群放量检测（同板块多股同时 T0）

### V4-4：交易计划增强（P1）
- 基于 T0 最低价的硬止损
- 移动止盈（MA10 跟随）
- 时间止损（5日未突破则退出）

### V4-5：回测验证（P2）
- 历史数据回测框架：从 `stock_daily` + `technical_daily` 取历史数据，按日期逐日模拟 Pipeline 执行
- 模拟观察池完整生命周期（T0 → 回踩 → 触发/过期/止损），大盘环境和行业共振同步纳入回测
- 对每个买入信号计算后续 1d/3d/5d/10d 实际收益
- 支持指定回测时间范围（如最近6个月、1年）
- 胜率、盈亏比、夏普比率、最大回撤等多维度评估
- 回测结果存入 `backtest_results` 表，API 接口：POST /backtest/run、GET /backtest/results

### V4-6：参数调优（P2）
- 关键参数网格搜索：accumulation_days、min_t0_pct_chg、min_t0_vol_ratio、min/max_washout_days、max_vol_shrink_ratio、max_tk_amplitude、ma_support_tolerance
- 使用 `itertools.product` 生成参数组合，asyncio 并发执行（默认并发度 8）
- 综合得分排名（胜率 × 0.4 + 盈亏比 × 0.3 + 夏普比率 × 0.3）
- 自动推荐最优参数组合
- API 接口：POST /backtest/grid-search
- 新增模块：`app/backtest/`

---

## 5. 与现有功能的兼容性

| 现有功能 | 影响 | 说明 |
|---------|------|------|
| 34 个现有策略 | 无影响 | 新策略独立注册，不修改现有策略代码 |
| Pipeline 四层筛选 | 兼容 | 量价配合策略作为 Layer2 技术策略参与 |
| 加权排序 | 兼容 | 新策略的 weighted_score 参与统一排序 |
| 交易计划生成 | 增强 | 新增基于 T0 的止损/止盈逻辑 |
| Telegram 通知 | 无影响 | 选股结果统一进入通知流程 |
| AI 分析 | 无影响 | 选股结果统一进入 AI 分析流程 |
| 命中率统计 | 无影响 | 新策略的 picks 统一进入回填流程 |
