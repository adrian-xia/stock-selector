# V4 详细设计：风控、交易计划与实施计划

> **版本：** v1.0
> **日期：** 2026-02-27
> **关联：** 01-V4详细设计-量价配合策略.md

---

## 6. 风控体系

### 6.1 三重止损机制

```
┌──────────────────────────────────────────────┐
│  硬止损（价格）                                │
│  收盘价 < T0 最低价 → 无条件止损               │
│  逻辑：主力成本线被击穿，洗盘变出货             │
├──────────────────────────────────────────────┤
│  软止损（均线）                                │
│  收盘价 < MA10 → 移动止盈/止损                 │
│  逻辑：短期趋势转弱                            │
├──────────────────────────────────────────────┤
│  时间止损                                     │
│  买入后 5 个交易日未放量突破 → 保本退出          │
│  逻辑：主力放弃拉升，资金效率优先               │
└──────────────────────────────────────────────┘
```

### 6.2 风控参数

```python
RISK_PARAMS = {
    "hard_stop_ref": "t0_low",        # 硬止损参考价：T0 最低价
    "trailing_stop_ma": 10,           # 移动止盈跟踪均线
    "time_stop_days": 5,              # 时间止损天数
    "max_drawdown_pct": 8.0,          # 最大回撤止损 8%
    "take_profit_first": 15.0,        # 第一止盈位 15%（减半仓）
}
```

### 6.3 与现有交易计划的集成

现有 `TradePlanGenerator` 的 `_build_plan` 函数生成交易计划。量价配合策略需要增强：

```python
# 在 trade_plan.py 的 _build_plan 中增加分支
def _build_plan(ts_code, plan_date, valid_date, strategy_name, indicators):
    if strategy_name == "volume-price-pattern":
        # 从观察池获取 T0 数据
        watchpool_item = get_watchpool_item(ts_code)
        return {
            "ts_code": ts_code,
            "plan_date": plan_date,
            "valid_date": valid_date,
            "direction": "buy",
            "trigger_type": "stabilization",       # 新触发类型
            "trigger_condition": (
                f"缩量回踩企稳：T0日期{watchpool_item.t0_date}，"
                f"回踩{watchpool_item.washout_days}天，"
                f"量缩至T0的{vol_ratio:.0%}"
            ),
            "trigger_price": float(indicators.get("close", 0)),
            "stop_loss": float(watchpool_item.t0_low),     # T0 最低价
            "take_profit": float(indicators["close"]) * 1.15,  # 15% 止盈
            "risk_reward_ratio": calculate_rr(
                entry=indicators["close"],
                stop=watchpool_item.t0_low,
                target=indicators["close"] * 1.15,
            ),
            "source_strategy": "volume-price-pattern",
            "confidence": watchpool_item.sector_score,
        }
    # ... 现有逻辑不变
```

---

## 7. 观察池生命周期

### 7.1 状态流转

```
                    ┌─────────┐
    T0 放量突破 ──→ │ watching │
                    └────┬────┘
                         │
              ┌──────────┼──────────┐
              │          │          │
              ▼          ▼          ▼
        ┌──────────┐ ┌────────┐ ┌─────────┐
        │ triggered │ │expired │ │ stopped │
        │ (企稳买入)│ │(超时)  │ │(破位)   │
        └──────────┘ └────────┘ └─────────┘
```

### 7.2 每日处理流程

```python
async def daily_watchpool_maintenance(session, target_date: date):
    """每日观察池维护（在盘后链路中执行）。"""

    # 1. 扫描新 T0 → 加入观察池（status=watching）
    # 2. 遍历所有 watching 记录：
    #    - 价格破位 → status=stopped
    #    - 超过 max_washout_days → status=expired
    #    - 满足企稳条件 → status=triggered，写入 strategy_picks
    #    - 否则 → washout_days += 1，更新统计
    # 3. 清理 30 天前的非 watching 记录（归档）
```

### 7.3 容量控制

- 观察池最大 200 条 watching 记录
- 超出时按 T0 日期最早的优先淘汰
- triggered/expired/stopped 记录保留 30 天后归档

---

## 8. 数据库变更汇总

### 8.1 新增表

```sql
-- 1. 观察池表（见概要设计第 3.2 节）
CREATE TABLE strategy_watchpool (...);

-- 2. 大盘环境日志（可选，用于回测分析）
CREATE TABLE market_environment_log (
    id SERIAL PRIMARY KEY,
    trade_date DATE NOT NULL,
    index_code VARCHAR(16) NOT NULL,
    state VARCHAR(16) NOT NULL,       -- bullish/neutral/bearish
    close NUMERIC(20,4),
    ma20 NUMERIC(20,4),
    ma60 NUMERIC(20,4),
    macd NUMERIC(20,4),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(trade_date, index_code)
);
```

### 8.2 现有表变更

```sql
-- strategies 表：新增一条策略记录
INSERT INTO strategies (name, category, description, params, is_enabled)
VALUES (
    'volume-price-pattern',
    'technical',
    '量价配合（龙回头）：放量突破后缩量回踩企稳',
    '{}',
    true
);
```

---

## 9. 实施计划

### 9.1 开发阶段

| 阶段 | 任务 | 预估工时 | 依赖 |
|------|------|---------|------|
| V4-1a | 创建 `strategy_watchpool` 表 + ORM 模型 | 0.5h | 无 |
| V4-1b | 实现观察池 Manager（CRUD + 状态流转） | 2h | V4-1a |
| V4-1c | 实现 `VolumePricePatternStrategy` 主体 | 3h | V4-1b |
| V4-1d | 注册策略到 Factory + Pipeline 集成测试 | 1h | V4-1c |
| V4-2a | 实现 `MarketFilter`（大盘环境过滤） | 1.5h | 无 |
| V4-2b | 集成到策略主体 + 测试 | 0.5h | V4-1c, V4-2a |
| V4-3a | 实现 `SectorFilter`（行业共振） | 2h | 无 |
| V4-3b | 集成到策略主体 + 测试 | 0.5h | V4-1c, V4-3a |
| V4-4 | 交易计划增强（止损/止盈逻辑） | 1.5h | V4-1c |
| V4-5 | 历史数据回测验证 | 3h | V4-1~4 全部 |

**总预估：约 15.5 小时**

### 9.2 测试策略

1. **单元测试**
   - 四阶段识别算法的边界条件
   - 观察池状态流转正确性
   - 大盘过滤三档判定

2. **集成测试**
   - 在测试库上跑完整盘后链路
   - 验证新策略与现有 34 个策略共存
   - 验证 Telegram 通知包含新策略结果

3. **回测验证**
   - 选取 2024-2025 年历史数据
   - 统计策略胜率、平均收益、最大回撤
   - 与现有策略的命中率对比

### 9.3 上线检查清单

- [ ] `strategy_watchpool` 表已创建
- [ ] `strategies` 表已插入新策略记录
- [ ] `VolumePricePatternStrategy` 已注册到 Factory
- [ ] 大盘过滤器数据源验证（index_technical_daily 有 MA20/MA60/MACD）
- [ ] 行业共振数据源验证（concept_daily 有近期数据）
- [ ] 盘后链路完整运行通过
- [ ] Telegram 通知正常显示新策略选股
- [ ] 观察池容量控制验证

---

## 10. 策略调优建议

### 10.1 关键参数敏感度

| 参数 | 偏松 | 推荐值 | 偏紧 | 影响 |
|------|------|--------|------|------|
| min_t0_pct_chg | 5% | 6% | 7% | 松→更多 T0，但含噪；紧→更少但更纯 |
| min_t0_vol_ratio | 2.0 | 2.5 | 3.0 | 松→量能要求低；紧→只抓真正的巨量 |
| max_washout_days | 10 | 8 | 5 | 松→等待更久；紧→快速决策 |
| max_vol_shrink_ratio | 0.50 | 0.40 | 0.30 | 松→缩量要求低；紧→要求极度缩量 |
| max_tk_amplitude | 4% | 3% | 2% | 松→允许较大波动；紧→要求极度收敛 |

### 10.2 与现有策略的协同

量价配合策略选出的股票，如果同时被以下现有策略命中，可信度更高：

- `volume-breakout`（放量突破）— T0 阶段重叠
- `ma-long-arrange`（均线多头排列）— 趋势确认
- `obv-breakthrough`（OBV 突破）— 量能确认
- `financial-safety`（财务安全）— 基本面兜底

建议在加权排序中，对多策略共振的股票给予额外加分。

---

## 11. 未来扩展方向

1. **分钟级增强**：如果未来接入分钟级数据，可在 T0 日内识别"尾盘放量"模式
2. **机器学习辅助**：用历史 T0→Tk 的成功/失败样本训练分类器，优化参数
3. **实时监控**：盘中实时扫描 T0 事件，提前加入观察池
4. **多周期嵌套**：日线 + 周线双重确认，提高胜率
