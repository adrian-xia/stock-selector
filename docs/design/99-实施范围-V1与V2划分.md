# A股智能选股系统 - 实施范围划分（V1 / V2）

> **版本：** v2.0
> **日期：** 2026-02-16
> **背景：** 本系统为单机部署、单人使用。设计文档按企业级标准编写，但实施时需分阶段裁剪，避免过度工程化。
> **重大变更：** V1 已完成 Tushare 迁移，数据源从 BaoStock/AKShare 切换为 Tushare Pro，新增 raw 原始数据层。

---

## 划分原则

| 标记 | 含义 | 判断标准 |
|:---|:---|:---|
| **V1 必须** | 第一版必须实现 | 没有它系统跑不起来，或核心功能缺失 |
| **V1 简化** | 第一版需要，但用简化方案 | 功能需要，但设计文档中的方案过重，用轻量替代 |
| **V2 再加** | 第二版再考虑 | 锦上添花、容错增强、运维便利，不影响核心功能 |
| **删除** | 单人场景永远不需要 | 多用户/多租户专属功能 |

---

## 一、00-概要设计-v2

| 章节 | 范围 | 说明 |
|:---|:---|:---|
| §1 系统概述 | V1 必须 | — |
| §2.1 总体架构图 | V1 简化 | 去掉 Nginx 网关层，FastAPI 直接对外 |
| §2.2 核心模块划分 | V1 简化 | 模块 11（用户与权限）标记删除 |
| §3 模块1-数据采集 | V1 必须 | — |
| §3 模块2-技术指标 | V1 必须 | — |
| §3 模块3-策略引擎 | V1 必须 | — |
| §3 模块4-回测引擎 | V1 必须 | — |
| §3 模块5-参数优化 | V2 再加 | — |
| §3 模块6-可视化 | V1 必须 | — |
| §3 模块7-AI分析 | ❌ V2 再加 | **V1 未实施**：盘后链路不包含 AI 分析，V2 再接入 Gemini 模型 |
| §3 模块8-新闻舆情 | V2 再加 | — |
| §3 模块9-高手跟投 | V2 再加 | — |
| §3 模块10-实时监控 | V2 再加 | V1 只做盘后批处理 |
| §3 模块11-用户权限 | 删除 | 单人不需要 |
| §4 数据模型 | V1 必须 | 去掉 `user_id` 相关字段 |
| §5 API 设计 | V1 简化 | 去掉 `/api/v1/user` 和 `/api/v1/monitor` |
| §6 部署架构 | V1 简化 | 去掉 Docker Compose / Nginx / Gunicorn / ELK |

---

## 二、01-详细设计-数据采集

| 章节 | 范围 | V1 实施方案 |
|:---|:---|:---|
| §1 模块概述 | ✅ V1 已实施 | **Tushare Pro 单一数据源** |
| §2 类图设计 | ✅ V1 已实施 | **TushareClient + TokenBucket 限流** |
| §3 数据库表设计与 ETL | ✅ V1 已实施（P0+P1） | **新增 raw 原始数据层**：16 张 raw_tushare_* 表（P0 6张 + P1 10张），两阶段 ETL（API → raw → 业务表）|
| §3.1 P0 核心原始表 | ✅ V1 已实施 | raw_tushare_stock_basic, raw_tushare_trade_cal, raw_tushare_daily, raw_tushare_adj_factor, raw_tushare_daily_basic, raw_tushare_stk_limit |
| §3.2 P1 财务原始表 | ✅ V1 已实施 | raw_tushare_fina_indicator, raw_tushare_income, raw_tushare_balancesheet, raw_tushare_cashflow, raw_tushare_dividend, raw_tushare_forecast, raw_tushare_express, raw_tushare_fina_audit, raw_tushare_fina_mainbz, raw_tushare_disclosure_date |
| §3.3 P2-P5 扩展原始表 | V2 再加 | 资金流向、指数、板块、扩展数据（共 40+ 张表）|
| §4 频率限流 | ✅ V1 已实施 | **TokenBucket 令牌桶限流**，避免超过 Tushare QPS 限制 |
| §5 数据同步流程 | ✅ V1 已实施 | **每日盘后链路**：sync_raw_daily → etl_daily → compute_indicators → refresh_cache |
| §6 接口定义 | ✅ V1 已实施 | DataManager 提供 sync_stock_list, sync_trade_calendar, sync_raw_daily, etl_daily, sync_raw_fina, etl_fina 方法 |
| §7 异常处理规范 | V1 简化 | 保留基础重试（3 次），去掉自动补偿和修复 |
| §8 全量导入 vs 增量更新 | ✅ V1 已实施 | **已实现累积进度模型**：`stock_sync_progress` 表追踪每只股票的 `data_date`/`indicator_date`，启动时自动恢复未完成同步，按 365 天/批分批处理，支持退市智能过滤、失败自动重试（每日 20:00）、完整性门控（完成率 >= 95% 才执行策略）、Redis 分布式锁防并发 |
| §8.3 交易日历自动更新 | ✅ V1 已实施 | **已实现交易日历自动更新**：每日盘后链路第一步自动更新未来 90 天数据，周末任务兜底，使用 UPSERT 逻辑 |
| §9 数据质量监控报告 | V2 再加 | V1 用日志输出同步结果摘要 |
| §10 标准层完整 DDL | ✅ V1 已实施 | Alembic 迁移脚本管理 |
| §11 配置项清单 | V1 简化 | 写 `.env` 文件，不入数据库 |
| §12 接口契约 | ✅ V1 已实施 | — |

**V1 已实施的表：**
- **P0 原始表（6 张）：** raw_tushare_stock_basic, raw_tushare_trade_cal, raw_tushare_daily, raw_tushare_adj_factor, raw_tushare_daily_basic, raw_tushare_stk_limit
- **P1 财务原始表（10 张）：** raw_tushare_fina_indicator, raw_tushare_income, raw_tushare_balancesheet, raw_tushare_cashflow, raw_tushare_dividend, raw_tushare_forecast, raw_tushare_express, raw_tushare_fina_audit, raw_tushare_fina_mainbz, raw_tushare_disclosure_date

**V1 删除的表：** `raw_baostock_daily`, `raw_akshare_daily`（已切换到 Tushare）

**V2 待实施的表：** P2 资金流向（8 张）、P3 指数（16 张）、P4 板块（8 张）、P5 扩展数据（10+ 张）

---

## 三、02-详细设计-策略引擎

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §1 模块概述 | V1 必须 | — |
| §2 策略类架构 | V1 简化 | **扁平化继承**：所有策略直接继承 `BaseStrategy`，去掉 7 个中间抽象子类 |
| §3 典型策略伪代码 | V1 必须 | V1 先实现 10-15 种核心策略，不是全部 79 种 |
| §4 策略执行管道 | V1 必须 | — |
| §5 性能优化 | V1 简化 | 保留向量化计算，去掉内存管理和数据窗口优化 |
| §6 双模式接口 | V1 简化 | **统一用 `filter_batch` 单模式**，去掉 `check_single` |
| §7 策略组合逻辑 | V1 简化 | 只支持 AND 组合，不支持嵌套 OR |
| §8 策略注册与发现 | V1 简化 | **手动注册**（字典映射），去掉装饰器自动扫描 |
| §9 策略版本管理 | V2 再加 | V1 用 Git 管理策略代码变更 |
| §10 Pipeline 层级统一 | V1 必须 | — |
| §11 配置项清单 | V1 简化 | 硬编码合理默认值，仅暴露 5-6 个关键参数 |
| §12 接口契约 | V1 必须 | — |

**V1 删除的表：** `strategy_versions`

---

## 四、03-详细设计-AI与回测

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §0 模块概述 | V1 必须 | — |
| §1 AI 智能分析架构 | ❌ V2 再加 | **V1 未实施 AI 分析**：盘后链路只到策略管道为止，不包含 AI 分析步骤；V2 再接入 Gemini 模型 |
| §1.4 AI 模块类图 | V2 再加 | 去掉 `TokenBucket` 类，预算用配置文件控制 |
| §2 回测系统设计 | ✅ V1 已实施 | — |
| §3 防未来函数 Checklist | V1 必须 | — |
| §4 成本估算 | V1 必须 | — |
| §5 AI 模型降级与容错 | V2 再加 | V1 调用失败 → 跳过 AI → 日志提示 |
| §6 Prompt 版本管理 | V2 再加 | V1 Prompt 写在代码/YAML 中，Git 管版本 |
| §7 回测结果存储 | V1 简化 | 保留 `backtest_tasks` + `backtest_results`，**合并 trades 和 equity_curve 为 JSONB 字段** |
| §8 涨跌停限制 | V1 必须 | — |
| §9 多股票组合回测 | V1 简化 | V1 只实现等权重分配，去掉评分加权和风险平价 |
| §10 复权计算统一方案 | V1 必须 | — |
| §11 AI 模型版本抽象 | V2 再加 | V1 模型配置写 `.env`，不入数据库 |
| §12 配置项清单 | V1 简化 | 保留核心配置，写 `.env` |
| §13 接口契约 | V1 必须 | — |
| §14 Token 桶与成本控制 | V2 再加 | V1 靠漏斗筛选控制调用量，不做精细限流 |
| §15 AI HTTP API | V1 简化 | 只保留 `POST /backtest/run` 和 `GET /backtest/result`，去掉 AI health/usage API |
| §16 回测任务执行流程 | V1 简化 | **去掉 Redis 队列和 Worker**，同步执行回测 |
| §17 边界条件与异常处理 | V1 简化 | 保留 B1-B8（回测核心异常），去掉 A 类（AI 降级相关） |
| §18 回测系统状态机 | V1 简化 | 只保留 pending → running → completed/failed |

**V1 删除的表：** `prompt_templates`, `prompt_ab_tests`, `prompt_ab_test_results`, `ai_degradation_log`, `ai_model_config`, `ai_usage_log`

**V1 简化的表：**
- `backtest_tasks`：去掉 `version_id` 字段
- `backtest_results`：保留核心 15 个指标，去掉 `downside_volatility`, `information_ratio`, `max_drawdown_days` 等
- `backtest_trades`：合并为 `backtest_results.trades_json` (JSONB)
- `backtest_equity_curve`：合并为 `backtest_results.equity_curve_json` (JSONB)

---

## 五、04-详细设计-前端与交互

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §1 核心页面交互 | V1 简化 | V1 只做：选股工作台 + 回测结果页，去掉实时监控看板和新闻仪表盘 |
| §2 前后端交互状态机 | V1 简化 | **去掉 WebSocket 推送**，前端轮询回测状态 |
| §3 API 接口契约 | V1 简化 | 只保留策略执行、回测提交/查询、K线查询 |
| §4 UI 组件库 | V1 必须 | — |
| §5 待确认细节 | V1 必须 | — |

---

## 六、10-系统设计-定时任务调度

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §1 模块概述 | V1 必须 | — |
| §2 架构图 | ✅ V1 已实施 | 使用 Redis 存储任务状态（避免重复执行），无需传统分布式锁 |
| §3 每日任务调度总表 | ✅ V1 已实施 | **已实现智能数据自动更新系统**：交易日历更新 → 交易日校验 → 数据嗅探 → 日线同步（含ETL清洗） → 技术指标 → 缓存刷新 → 策略管道；**不包含 AI 分析**（V2 再加） |
| §3.4.1 智能数据自动更新系统 | ✅ V1 已实施 | **已实现数据嗅探和智能重试**：检查 5-10 只样本股票，数据未就绪时每 15 分钟嗅探一次，18:00 超时告警；使用 Redis 管理任务状态 |
| §4 任务依赖 DAG | V1 简化 | 简化为线性链路 |
| §5 数据库表设计 | V2 再加 | V1 用日志文件记录执行结果 |
| §6 APScheduler 配置 | V1 简化 | 用 SQLite 做 Job Store（不依赖 PG），去掉分布式锁 |
| §7 核心流程 | V1 必须 | — |
| §8 失败处理与告警 | V1 简化 | 失败写日志 + 打印到终端，去掉 Telegram/邮件通知 |
| §9 手动触发机制 | V1 简化 | 命令行脚本触发，不做 HTTP API |
| §10 配置项清单 | V1 简化 | 写配置文件 |
| §11 接口契约 | V1 简化 | 去掉 4 个管理 API |

**V1 删除的表：** `task_execution_log`

---

## 七、task-设计补全（待完成任务调整）

| 任务 | 原优先级 | 调整 |
|:---|:---|:---|
| A1 参数优化 | P1 | → **V2 再加** |
| A2 新闻舆情监控 | P1 | → **V2 再加** |
| A3 实时监控与告警 | P1 | → **V2 再加** |
| A4 高手跟投监控 | P2 | → **V2 再加** |
| A5 用户与权限 | P2 | → **删除** |
| B4 修订前端 | P1 | → **V1 简化**（只补路由和核心 API） |
| C1 定时任务调度 | P0 ✅ | 已完成，实施时按 V1 简化 |
| C2 缓存策略 | P0 | → **V1 简化**（只缓存技术指标，去掉复杂的一致性策略） |
| C3 安全设计 | P1 | → **删除**（单人无需 CORS/Rate Limit/审计） |
| C4 测试策略 | P1 | → **V1 简化**（只写核心策略的单元测试，去掉 CI） |
| C5 数据库迁移与运维 | P0 | → **V2 再加**（V1 手动管理 schema） |

---

## 八、V1 数据库表总览

V1 只需要以下 **12 张表**（原设计 ~25 张）：

| 表名 | 来源模块 | 说明 |
|:---|:---|:---|
| `trade_calendar` | 数据采集 | 交易日历 |
| `stocks` | 数据采集 | 股票基础信息 |
| `stock_daily` | 数据采集 | 日线行情（含复权因子） |
| `stock_min` | 数据采集 | 分钟线行情 |
| `finance_indicator` | 数据采集 | 关键财务指标 |
| `technical_daily` | 策略引擎 | 每日技术指标缓存 |
| `money_flow` | 数据采集 | 个股资金流向 |
| `dragon_tiger` | 数据采集 | 龙虎榜明细 |
| `strategies` | 策略引擎 | 策略配置 |
| `data_source_configs` | 数据采集 | 数据源配置 |
| `backtest_tasks` | 回测 | 回测任务 |
| `backtest_results` | 回测 | 回测结果（含 trades_json + equity_curve_json） |

---

## 九、V1 技术栈精简

| 组件 | 原设计 | V1 方案 |
|:---|:---|:---|
| Web 服务 | Nginx → Gunicorn → FastAPI | **FastAPI (uvicorn)** 直接运行 |
| 数据库 | PostgreSQL + TimescaleDB | **PostgreSQL** 普通表 |
| 缓存 | Redis（缓存 + 队列 + 锁 + Pub/Sub） | ✅ **Redis**（缓存技术指标 + 任务状态管理） |
| 任务队列 | Redis + Celery/Worker | **APScheduler** 进程内调度 |
| AI 模型 | Claude + Gemini + DeepSeek 三模型 | **Gemini Flash** 单模型 |
| 日志 | ELK / Loki | **文件日志** + logrotate |
| 监控 | Prometheus + Grafana | **无**（日志即监控） |
| 部署 | Docker Compose + Nginx | ✅ **直接运行**（uv + systemd/launchd 服务管理） |
| 认证 | JWT + RBAC | **无**（或固定 API Key） |
