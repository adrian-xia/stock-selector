# A股智能选股系统 - 实施范围划分（V1 / V2）

> **版本：** v2.2
> **日期：** 2026-02-17
> **背景：** 本系统为单机部署、单人使用。设计文档按企业级标准编写，但实施时需分阶段裁剪，避免过度工程化。
> **重大变更：** V1 已完成 Tushare 迁移（P0+P1+P2），数据源从 BaoStock/AKShare 切换为 Tushare Pro，新增 raw 原始数据层（26 张表），实现按日期批量获取全市场数据、令牌桶限流、智能数据自动更新、断点续传等核心功能。

---

## 划分原则

| 标记 | 含义 | 判断标准 |
|:---|:---|:---|
| **V1 必须** | 第一版必须实现 | 没有它系统跑不起来，或核心功能缺失 |
| **V1 简化** | 第一版需要，但用简化方案 | 功能需要，但设计文档中的方案过重，用轻量替代 |
| **V2 再加** | 第二版再考虑 | 锦上添花、容错增强、运维便利，不影响核心功能 |
| **删除** | 单人场景永远不需要 | 多用户/多租户专属功能 |

---

## 一、00-概要设计-v2

| 章节 | 范围 | 说明 |
|:---|:---|:---|
| §1 系统概述 | V1 必须 | — |
| §2.1 总体架构图 | V1 简化 | 去掉 Nginx 网关层，FastAPI 直接对外 |
| §2.2 核心模块划分 | V1 简化 | 模块 11（用户与权限）标记删除 |
| §3 模块1-数据采集 | V1 必须 | — |
| §3 模块2-技术指标 | V1 必须 | — |
| §3 模块3-策略引擎 | V1 必须 | — |
| §3 模块4-回测引擎 | V1 必须 | — |
| §3 模块5-参数优化 | ✅ V2 已实施 | 单股回测优化（网格搜索+遗传算法）+ **全市场选股回放优化**（MarketOptimizer，每周 cron 自动执行，评分公式偏命中率） |
| §3 模块6-可视化 | V1 必须 | — |
| §3 模块7-AI分析 | ❌ V2 再加 | **V1 未实施**：盘后链路不包含 AI 分析，V2 再接入 Gemini 模型 |
| §3 模块8-新闻舆情 | ✅ V2 已实施 | 东方财富/新浪7x24快讯/同花顺采集 + Gemini 情感分析 + 盘后链路步骤 3.9 + 前端新闻仪表盘 |
| §3 模块9-高手跟投 | V2 再加 | — |
| §3 模块10-实时监控 | ✅ V2 已实施 | WebSocket 实时行情推送 + 告警规则引擎 + 多渠道通知（企业微信/Telegram）+ 前端监控看板 |
| §3 模块11-用户权限 | 删除 | 单人不需要 |
| §4 数据模型 | V1 必须 | 去掉 `user_id` 相关字段 |
| §5 API 设计 | V1 简化 | 去掉 `/api/v1/user` 和 `/api/v1/monitor` |
| §6 部署架构 | V1 简化 | 去掉 Docker Compose / Nginx / Gunicorn / ELK |

---

## 二、01-详细设计-数据采集

| 章节 | 范围 | V1 实施方案 |
|:---|:---|:---|
| §1 模块概述 | ✅ V1 已实施 | **Tushare Pro 单一数据源** |
| §2 类图设计 | ✅ V1 已实施 | **TushareClient + TokenBucket 限流** |
| §3 数据库表设计与 ETL | ✅ V1 已实施（P0+P1+P2+P3+P4+P5 建表） | **新增 raw 原始数据层**：90 张 raw_tushare_* 表（P0 6张 + P1 10张 + P2 10张 + P3 18张 + P4 8张 + P5 48张），两阶段 ETL（API → raw → 业务表）；**P0+P1+P2+P3+P4 完整实施**（含 ETL 和数据同步），**P5 仅建表**（V2 再实施 ETL 和数据同步）|
| §3.1 P0 核心原始表 | ✅ V1 已实施 | raw_tushare_stock_basic, raw_tushare_trade_cal, raw_tushare_daily, raw_tushare_adj_factor, raw_tushare_daily_basic, raw_tushare_stk_limit |
| §3.2 P1 财务原始表 | ✅ V1 已实施 | raw_tushare_fina_indicator, raw_tushare_income, raw_tushare_balancesheet, raw_tushare_cashflow, raw_tushare_dividend, raw_tushare_forecast, raw_tushare_express, raw_tushare_fina_audit, raw_tushare_fina_mainbz, raw_tushare_disclosure_date |
| §3.3 P2 资金流向原始表 | ✅ V1 已实施 | **已建表**：10 张 raw_tushare_* 表（moneyflow, moneyflow_dc, moneyflow_ths, moneyflow_hsgt, moneyflow_ind_ths, moneyflow_cnt_ths, moneyflow_ind_dc, moneyflow_mkt_dc, top_list, top_inst）+ ORM 模型 + fetch 方法；**已实施 ETL**：transform_tushare_moneyflow、transform_tushare_top_list 清洗函数 + DataManager sync_raw_moneyflow/sync_raw_top_list/etl_moneyflow 方法 + 盘后链路集成 |
| §3.4 P3 指数数据原始表 | ✅ V1 已实施 | **已建表**：18 张 raw_tushare_* 表（index_basic, index_daily, index_weekly, index_monthly, index_dailybasic, index_weight, index_member_all, index_classify, sw_daily, ci_index_member, ci_daily, index_factor_pro, tdx_index, tdx_daily, tdx_member, index_global, daily_info, sz_daily_info）+ ORM 模型 + fetch 方法；**已实施 ETL**：6 个 transform 清洗函数 + DataManager sync_raw_index_daily/sync_raw_index_weight/sync_raw_index_technical/etl_index 方法 + 静态数据同步（sync_raw_index_basic/sync_raw_industry_classify/sync_raw_industry_member/etl_index_static）+ 盘后链路集成 |
| §3.5 P4 板块数据原始表 | ✅ V1 已实施 | **已建表**：8 张 raw_tushare_* 表（ths_index, ths_daily, ths_member, dc_index, dc_member, dc_hot_new, tdx_index, tdx_member）+ ORM 模型 + fetch 方法；**已实施 ETL**：3 个 transform 清洗函数 + DataManager sync_concept_index/daily/member + update_concept_indicators 方法 + 盘后链路集成 |
| §3.6 P5 扩展数据原始表 | ✅ V1 已实施 | **已建表**：48 张 raw_tushare_* 表（涵盖股本、停复牌、两融、大宗交易、股东、质押、回购、涨跌停、龙虎榜、热榜、港股通、筹码分布等）+ ORM 模型 + fetch 方法；**已实施核心 ETL**：2 个 transform 清洗函数（suspend_d、limit_list_d）+ 2 张业务表（suspend_info、limit_list_daily）+ 约 48 个 DataManager sync_raw 方法（日频/周频/月频/静态/季度，含 28 张补充表）+ etl_suspend/etl_limit_list + sync_p5_core 聚合方法（按频率分组集成全部 48 张表）+ 盘后链路步骤 3.8 集成 |
| §3.7 数据校验测试 | V2 再加 | **所有数据校验测试（P0/P1/P2/P3/P4/P5）均在 V2 实施**，因为需要实际数据才能验证 |
| §4 频率限流 | ✅ V1 已实施 | **TokenBucket 令牌桶限流**，避免超过 Tushare QPS 限制 |
| §5 数据同步流程 | ✅ V1 已实施 | **每日盘后链路**：sync_raw_daily → etl_daily → compute_indicators → refresh_cache |
| §6 接口定义 | ✅ V1 已实施 | DataManager 提供 sync_stock_list, sync_trade_calendar, sync_raw_daily, etl_daily, sync_raw_fina, etl_fina 方法 |
| §7 异常处理规范 | V1 简化 | 保留基础重试（3 次），去掉自动补偿和修复 |
| §8 全量导入 vs 增量更新 | ✅ V1 已实施 | **已实现累积进度模型**：`stock_sync_progress` 表追踪每只股票的 `data_date`/`indicator_date`，启动时自动恢复未完成同步，按 365 天/批分批处理，支持退市智能过滤、失败自动重试（每日 20:00）、完整性门控（完成率 >= 95% 才执行策略）、Redis 分布式锁防并发 |
| §8.3 交易日历自动更新 | ✅ V1 已实施 | **已实现交易日历自动更新**：每日盘后链路第一步自动更新未来 90 天数据，周末任务兜底，使用 UPSERT 逻辑 |
| §9 数据质量监控报告 | V2 再加 | V1 用日志输出同步结果摘要 |
| §10 标准层完整 DDL | ✅ V1 已实施 | Alembic 迁移脚本管理 |
| §11 配置项清单 | V1 简化 | 写 `.env` 文件，不入数据库 |
| §12 接口契约 | ✅ V1 已实施 | — |

**V1 已实施的表：**
- **P0 原始表（6 张）：** raw_tushare_stock_basic, raw_tushare_trade_cal, raw_tushare_daily, raw_tushare_adj_factor, raw_tushare_daily_basic, raw_tushare_stk_limit
- **P1 财务原始表（10 张）：** raw_tushare_fina_indicator, raw_tushare_income, raw_tushare_balancesheet, raw_tushare_cashflow, raw_tushare_dividend, raw_tushare_forecast, raw_tushare_express, raw_tushare_fina_audit, raw_tushare_fina_mainbz, raw_tushare_disclosure_date
- **P2 资金流向原始表（10 张，仅建表）：** raw_tushare_moneyflow, raw_tushare_moneyflow_dc, raw_tushare_moneyflow_ths, raw_tushare_moneyflow_hsgt, raw_tushare_moneyflow_ind_ths, raw_tushare_moneyflow_cnt_ths, raw_tushare_moneyflow_ind_dc, raw_tushare_moneyflow_mkt_dc, raw_tushare_top_list, raw_tushare_top_inst
- **P3 指数原始表（18 张，仅建表）：** raw_tushare_index_basic, raw_tushare_index_daily, raw_tushare_index_weekly, raw_tushare_index_monthly, raw_tushare_index_dailybasic, raw_tushare_index_weight, raw_tushare_index_member_all, raw_tushare_index_classify, raw_tushare_sw_daily, raw_tushare_ci_index_member, raw_tushare_ci_daily, raw_tushare_index_factor_pro, raw_tushare_tdx_index, raw_tushare_tdx_daily, raw_tushare_tdx_member, raw_tushare_index_global, raw_tushare_daily_info, raw_tushare_sz_daily_info
- **P4 板块原始表（8 张，仅建表）：** raw_tushare_ths_index, raw_tushare_ths_daily, raw_tushare_ths_member, raw_tushare_dc_index, raw_tushare_dc_member, raw_tushare_dc_hot_new, raw_tushare_tdx_index（复用P3）, raw_tushare_tdx_member（复用P3）
- **P5 扩展原始表（48 张，仅建表）：** 涵盖股本、停复牌、两融、大宗交易、股东、质押、回购、涨跌停、龙虎榜、热榜、港股通、筹码分布等扩展数据
- **P5 核心业务表（2 张）：** suspend_info（停复牌信息）、limit_list_daily（涨跌停统计）
- **合计：90 张 raw_tushare_* 表**（P0+P1+P2+P3+P4+P5 核心完整实施含 ETL 和数据同步，P5 剩余 28 张补充表待 Change 11 实施）

**V1 删除的表：** `raw_baostock_daily`, `raw_akshare_daily`（已切换到 Tushare）

**V2 待实施：** P5 剩余 28 张补充表数据同步和 ETL（Change 11）、所有数据校验测试

---

## 三、02-详细设计-策略引擎

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §1 模块概述 | V1 必须 | — |
| §2 策略类架构 | V1 简化 | **扁平化继承**：所有策略直接继承 `BaseStrategy`，去掉 7 个中间抽象子类 |
| §3 典型策略伪代码 | ✅ V1 已实施 | V1 已实现 28 种核心策略（16 技术面 + 12 基本面），技术面覆盖趋势跟踪、震荡指标、量价分析三大类，基本面覆盖估值、盈利、安全、综合评分四大类 |
| §4 策略执行管道 | ✅ V1 已实施 | **盘后链路策略注册制**：pipeline_step 从 strategies 表读取 is_enabled=True 的策略执行，支持自定义参数覆盖；新策略默认禁用，需用户在策略配置页面手动启用 |
| §5 性能优化 | V1 简化 | 保留向量化计算，去掉内存管理和数据窗口优化 |
| §6 双模式接口 | V1 简化 | **统一用 `filter_batch` 单模式**，去掉 `check_single` |
| §7 策略组合逻辑 | V1 简化 | 只支持 AND 组合，不支持嵌套 OR |
| §8 策略注册与发现 | V1 简化 | **手动注册**（字典映射），去掉装饰器自动扫描 |
| §9 策略版本管理 | V2 再加 | V1 用 Git 管理策略代码变更 |
| §10 Pipeline 层级统一 | V1 必须 | — |
| §11 配置项清单 | V1 简化 | 硬编码合理默认值，仅暴露 5-6 个关键参数 |
| §12 接口契约 | V1 必须 | — |

**V1 删除的表：** `strategy_versions`

---

## 四、03-详细设计-AI与回测

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §0 模块概述 | V1 必须 | — |
| §1 AI 智能分析架构 | ❌ V2 再加 | **V1 未实施 AI 分析**：盘后链路只到策略管道为止，不包含 AI 分析步骤；V2 再接入 Gemini 模型 |
| §1.4 AI 模块类图 | V2 再加 | 去掉 `TokenBucket` 类，预算用配置文件控制 |
| §2 回测系统设计 | ✅ V1 已实施 | — |
| §3 防未来函数 Checklist | V1 必须 | — |
| §4 成本估算 | V1 必须 | — |
| §5 AI 模型降级与容错 | V2 再加 | V1 调用失败 → 跳过 AI → 日志提示 |
| §6 Prompt 版本管理 | V2 再加 | V1 Prompt 写在代码/YAML 中，Git 管版本 |
| §7 回测结果存储 | V1 简化 | 保留 `backtest_tasks` + `backtest_results`，**合并 trades 和 equity_curve 为 JSONB 字段** |
| §8 涨跌停限制 | V1 必须 | — |
| §9 多股票组合回测 | V1 简化 | V1 只实现等权重分配，去掉评分加权和风险平价 |
| §10 复权计算统一方案 | V1 必须 | — |
| §11 AI 模型版本抽象 | V2 再加 | V1 模型配置写 `.env`，不入数据库 |
| §12 配置项清单 | V1 简化 | 保留核心配置，写 `.env` |
| §13 接口契约 | V1 必须 | — |
| §14 Token 桶与成本控制 | V2 再加 | V1 靠漏斗筛选控制调用量，不做精细限流 |
| §15 AI HTTP API | V1 简化 | 只保留 `POST /backtest/run` 和 `GET /backtest/result`，去掉 AI health/usage API |
| §16 回测任务执行流程 | V1 简化 | **去掉 Redis 队列和 Worker**，同步执行回测 |
| §17 边界条件与异常处理 | V1 简化 | 保留 B1-B8（回测核心异常），去掉 A 类（AI 降级相关） |
| §18 回测系统状态机 | V1 简化 | 只保留 pending → running → completed/failed |

**V1 删除的表：** `prompt_templates`, `prompt_ab_tests`, `prompt_ab_test_results`, `ai_degradation_log`, `ai_model_config`, `ai_usage_log`

**V1 简化的表：**
- `backtest_tasks`：去掉 `version_id` 字段
- `backtest_results`：保留核心 15 个指标，去掉 `downside_volatility`, `information_ratio`, `max_drawdown_days` 等
- `backtest_trades`：合并为 `backtest_results.trades_json` (JSONB)
- `backtest_equity_curve`：合并为 `backtest_results.equity_curve_json` (JSONB)

---

## 五、04-详细设计-前端与交互

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §1 核心页面交互 | V1 简化 | V1 只做：选股工作台 + 回测结果页，去掉实时监控看板和新闻仪表盘 |
| §2 前后端交互状态机 | V1 简化 | **去掉 WebSocket 推送**，前端轮询回测状态 |
| §3 API 接口契约 | V1 简化 | 只保留策略执行、回测提交/查询、K线查询 |
| §4 UI 组件库 | V1 必须 | — |
| §5 待确认细节 | V1 必须 | — |

---

## 六、10-系统设计-定时任务调度

| 章节 | 范围 | V1 简化方案 |
|:---|:---|:---|
| §1 模块概述 | V1 必须 | — |
| §2 架构图 | ✅ V1 已实施 | 使用 Redis 存储任务状态（避免重复执行），无需传统分布式锁 |
| §3 每日任务调度总表 | ✅ V1 已实施 | **已实现智能数据自动更新系统**：交易日历更新 → 交易日校验 → 数据嗅探 → 日线同步（含ETL清洗） → 技术指标 → 缓存刷新 → 策略管道（注册制，仅执行用户启用的策略）；**不包含 AI 分析**（V2 再加） |
| §3.4.1 智能数据自动更新系统 | ✅ V1 已实施 | **已实现数据嗅探和智能重试**：检查 5-10 只样本股票，数据未就绪时每 15 分钟嗅探一次，18:00 超时告警；使用 Redis 管理任务状态 |
| §4 任务依赖 DAG | V1 简化 | 简化为线性链路 |
| §5 数据库表设计 | V2 再加 | V1 用日志文件记录执行结果 |
| §6 APScheduler 配置 | V1 简化 | 用 SQLite 做 Job Store（不依赖 PG），去掉分布式锁 |
| §7 核心流程 | V1 必须 | — |
| §8 失败处理与告警 | V1 简化 | 失败写日志 + 打印到终端，去掉 Telegram/邮件通知 |
| §9 手动触发机制 | V1 简化 | 命令行脚本触发，不做 HTTP API |
| §10 配置项清单 | V1 简化 | 写配置文件 |
| §11 接口契约 | V1 简化 | 去掉 4 个管理 API |

**V1 删除的表：** `task_execution_log`

---

## 七、task-设计补全（待完成任务调整）

| 任务 | 原优先级 | 调整 |
|:---|:---|:---|
| A1 参数优化 | P1 | → **V2 已实施**：网格搜索 + 遗传算法 + **全市场选股回放优化**（MarketOptimizer + 每周 cron），优化任务管理，前端参数优化页面（含全市场优化 UI） |
| A2 新闻舆情监控 | P1 | → **V2 已实施**：3 数据源采集 + Gemini 情感分析 + API + 前端新闻仪表盘 |
| A3 实时监控与告警 | P1 | → **V2 再加** |
| A4 高手跟投监控 | P2 | → **V2 再加** |
| A5 用户与权限 | P2 | → **删除** |
| B4 修订前端 | P1 | → **V1 简化**（只补路由和核心 API） |
| C1 定时任务调度 | P0 ✅ | 已完成，实施时按 V1 简化 |
| C2 缓存策略 | P0 | → **V1 简化**（只缓存技术指标，去掉复杂的一致性策略） |
| C3 安全设计 | P1 | → **删除**（单人无需 CORS/Rate Limit/审计） |
| C4 测试策略 | P1 | → **V1 简化**（只写核心策略的单元测试，去掉 CI） |
| C5 数据库迁移与运维 | P0 | → **V2 再加**（V1 手动管理 schema） |

---

## 八、V1 数据库表总览

V1 只需要以下 **12 张表**（原设计 ~25 张）：

| 表名 | 来源模块 | 说明 |
|:---|:---|:---|
| `trade_calendar` | 数据采集 | 交易日历 |
| `stocks` | 数据采集 | 股票基础信息 |
| `stock_daily` | 数据采集 | 日线行情（含复权因子） |
| `stock_min` | 数据采集 | 分钟线行情 |
| `finance_indicator` | 数据采集 | 关键财务指标 |
| `technical_daily` | 策略引擎 | 每日技术指标缓存 |
| `money_flow` | 数据采集 | 个股资金流向 |
| `dragon_tiger` | 数据采集 | 龙虎榜明细 |
| `strategies` | 策略引擎 | 策略配置 |
| `data_source_configs` | 数据采集 | 数据源配置 |
| `backtest_tasks` | 回测 | 回测任务 |
| `backtest_results` | 回测 | 回测结果（含 trades_json + equity_curve_json） |

---

## 九、V1 技术栈精简

| 组件 | 原设计 | V1 方案 |
|:---|:---|:---|
| Web 服务 | Nginx → Gunicorn → FastAPI | **FastAPI (uvicorn)** 直接运行 |
| 数据库 | PostgreSQL + TimescaleDB | **PostgreSQL** 普通表 |
| 缓存 | Redis（缓存 + 队列 + 锁 + Pub/Sub） | ✅ **Redis**（缓存技术指标 + 任务状态管理） |
| 任务队列 | Redis + Celery/Worker | **APScheduler** 进程内调度 |
| AI 模型 | Claude + Gemini + DeepSeek 三模型 | **Gemini Flash** 单模型 |
| 日志 | ELK / Loki | **文件日志** + logrotate |
| 监控 | Prometheus + Grafana | **无**（日志即监控） |
| 部署 | Docker Compose + Nginx | ✅ **直接运行**（uv + systemd/launchd 服务管理） |
| 认证 | JWT + RBAC | **无**（或固定 API Key） |

---

## 十、Tushare 迁移实施总结（V1 已完成）

### 10.1 迁移概述

**迁移时间：** 2026-02-15 至 2026-02-17

**迁移目标：** 从 BaoStock/AKShare 多数据源架构切换到 Tushare Pro 单一数据源，引入 raw 原始数据层，实现更稳定、更高效的数据采集系统。

**迁移范围：** P0 基础行情 + P1 财务数据 + P2 资金流向 + P3 指数数据 + P4 板块数据 + P5 扩展数据（全量同步已实施）

### 10.2 核心架构变更

#### 10.2.1 数据源统一

**变更前：**
- 多数据源：BaoStock（日线）+ AKShare（实时）+ Tushare（财务）
- 逐股票遍历获取数据（5000+ 只股票 × 3 次 login/logout）
- 数据格式不统一，需要复杂的标准化逻辑

**变更后：**
- 单一数据源：Tushare Pro API
- 按日期批量获取全市场数据（单次 API 调用获取所有股票）
- 统一的数据格式（TS 代码 `600519.SH`）

**性能提升：**
- 日线同步：从 2-3 小时降低到 5-10 分钟（提升 12-36 倍）
- API 调用次数：从 5000+ 次降低到 3-6 次（每日 daily + adj_factor + daily_basic）

#### 10.2.2 引入 raw 原始数据层

**设计理念：**
- 解耦数据获取和数据清洗
- 保留 API 原始格式，支持数据回溯和审计
- 两阶段 ETL：API → raw 表 → 业务表

**实施成果：**
- 新增 90 张 raw_tushare_* 表（P0 6张 + P1 10张 + P2 10张 + P3 18张 + P4 8张 + P5 48张）
- 每张 raw 表包含 `fetched_at` 时间戳，记录数据拉取时间
- 日期字段保持 `VARCHAR(8)` 的 YYYYMMDD 格式
- 数值字段使用 `NUMERIC`，保留原始精度

**表结构示例：**
```sql
CREATE TABLE raw_tushare_daily (
    ts_code         VARCHAR(16)     NOT NULL,
    trade_date      VARCHAR(8)      NOT NULL,
    open            NUMERIC(12,4),
    high            NUMERIC(12,4),
    low             NUMERIC(12,4),
    close           NUMERIC(12,4),
    pre_close       NUMERIC(12,4),
    change          NUMERIC(12,4),
    pct_chg         NUMERIC(10,4),
    vol             NUMERIC(20,4),
    amount          NUMERIC(20,4),  -- 千元
    fetched_at      TIMESTAMP       NOT NULL DEFAULT NOW(),
    PRIMARY KEY (ts_code, trade_date)
);
```

#### 10.2.3 令牌桶限流

**实现：**
```python
class TokenBucket:
    def __init__(self, rate_per_minute: int):
        self._rate = rate_per_minute / 60.0  # 每秒补充令牌数
        self._tokens = float(rate_per_minute)  # 初始满桶

    async def acquire(self):
        """获取一个令牌，令牌不足时等待"""
        if self._tokens < 1.0:
            wait_time = (1.0 - self._tokens) / self._rate
            await asyncio.sleep(wait_time)
        self._tokens -= 1.0
```

**配置：**
- 默认 400 QPS（每分钟 400 次请求）
- 积分 >= 2000 可设为 500 QPS
- 通过 `TUSHARE_QPS_LIMIT` 环境变量配置

#### 10.2.4 VIP 接口批量获取

**财务数据优化：**
- 使用 VIP 接口按季度批量获取全部公司数据
- 接口：`fina_indicator_vip`, `income_vip`, `balancesheet_vip`, `cashflow_vip`, `forecast_vip`, `express_vip`, `fina_mainbz_vip`
- 参数：`period="20231231"` 获取 2023 年年报数据
- 降级策略：VIP 接口失败时自动降级到标准接口逐股票获取

**实现示例：**
```python
async def fetch_raw_fina_indicator(self, period: str) -> list[dict]:
    """按季度获取全市场财务指标（VIP 接口）。"""
    try:
        df = await self._call("fina_indicator_vip", period=period)
        return df.to_dict("records")
    except Exception as e:
        logger.warning(f"VIP 接口失败，降级到标准接口: {e}")
        # 降级逻辑：逐股票获取
        ...
```

### 10.3 数据同步流程变更

#### 10.3.1 盘后链路

**变更前：**
```
逐股票同步日线 → 计算技术指标 → 刷新缓存 → 策略筛选
```

**变更后：**
```
交易日历更新 → 交易日校验 → 数据嗅探 →
sync_raw_daily（按日期获取全市场原始数据） →
etl_daily（ETL 清洗到业务表） →
compute_indicators（计算技术指标） →
refresh_cache（刷新 Redis 缓存） →
策略管道（注册制：仅执行 strategies 表中 is_enabled=True 的策略，支持自定义参数）
```

**关键改进：**
1. **交易日历自动更新**：每日盘后链路第一步自动更新未来 90 天交易日历数据
2. **数据嗅探机制**：检查 5-10 只样本股票，数据未就绪时每 15 分钟嗅探一次，18:00 超时告警
3. **按日期批量获取**：单次 API 调用获取全市场数据，避免逐股票遍历
4. **两阶段 ETL**：先写入 raw 表，再从 raw 表 JOIN 清洗到业务表

#### 10.3.2 断点续传机制

**实现：**
- `stock_sync_progress` 表追踪每只股票的 `data_date`/`indicator_date`
- `raw_sync_progress` 表追踪原始数据拉取进度（按表+同步键）
- 启动时自动恢复未完成同步
- 按 365 天/批分批处理数据和指标
- 退市智能过滤（`status=delisted`）
- 失败自动重试（每日 20:00）
- 完整性门控（完成率 >= 95% 才执行策略）
- Redis 分布式锁防并发

**表结构：**
```sql
CREATE TABLE stock_sync_progress (
    ts_code         VARCHAR(16)     PRIMARY KEY,
    status          VARCHAR(16)     NOT NULL DEFAULT 'idle',
    data_date       DATE            NOT NULL DEFAULT '1900-01-01',
    indicator_date  DATE            NOT NULL DEFAULT '1900-01-01',
    retry_count     INTEGER         DEFAULT 0,
    error_message   TEXT,
    created_at      TIMESTAMP       NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP       NOT NULL DEFAULT NOW()
);

CREATE TABLE raw_sync_progress (
    table_name      VARCHAR(64)     NOT NULL,
    sync_key        VARCHAR(32)     NOT NULL,
    status          VARCHAR(16)     NOT NULL DEFAULT 'pending',
    record_count    INTEGER         DEFAULT 0,
    synced_at       TIMESTAMP,
    retry_count     INTEGER         DEFAULT 0,
    error_message   TEXT,
    created_at      TIMESTAMP       NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP       NOT NULL DEFAULT NOW(),
    PRIMARY KEY (table_name, sync_key)
);
```

### 10.4 数据初始化向导

**实现：**
- 交互式引导首次数据初始化（`scripts/init_data.py`）
- 支持 1年/3年/自定义范围选项
- 自动执行完整流程：股票列表 → 交易日历 → P0 日线 → P1 财务 → P2 资金 → P3 指数 → P4 板块 → P5 扩展 → 技术指标
- 实时显示进度和统计信息

**CLI 全量初始化命令（`init-tushare`）：**
- 9 步全量同步，支持按优先级跳过：`--skip-fina`（P1）、`--skip-p2`（P2）、`--skip-index`（P3）、`--skip-concept`（P4）、`--skip-p5`（P5）

**使用方式：**
```bash
# 交互式向导（推荐）
uv run python -m scripts.init_data

# CLI 全量初始化（支持跳过选项）
uv run python -m app.data.cli init-tushare --start 2024-01-01 --end 2026-02-25
uv run python -m app.data.cli init-tushare --skip-p2 --skip-p5
```

### 10.5 配置项变更

**新增配置：**
```bash
# Tushare Pro API
TUSHARE_TOKEN=your_token_here
TUSHARE_RETRY_COUNT=3
TUSHARE_RETRY_INTERVAL=1.0
TUSHARE_QPS_LIMIT=400

# 数据完整性检查
DATA_INTEGRITY_CHECK_ENABLED=true
DATA_INTEGRITY_CHECK_DAYS=30
DATA_INTEGRITY_THRESHOLD=0.95
SKIP_INTEGRITY_CHECK=false

# 自动数据更新
AUTO_UPDATE_ENABLED=true
AUTO_UPDATE_TRIGGER_TIME=15:30
AUTO_UPDATE_PROBE_INTERVAL=15
AUTO_UPDATE_PROBE_TIMEOUT=18:00
```

**删除配置：**
```bash
# BaoStock（已移除）
BAOSTOCK_RETRY_COUNT
BAOSTOCK_RETRY_INTERVAL

# AKShare（已移除）
AKSHARE_RETRY_COUNT
AKSHARE_RETRY_INTERVAL
```

### 10.6 代码模块变更

**新增文件：**
- `app/data/tushare.py` - TushareClient（令牌桶限流 + asyncio.to_thread 异步包装）
- `app/data/probe.py` - 数据嗅探（检测数据是否就绪）
- `app/models/raw.py` - 90 张 raw_tushare_* 表 ORM 模型（P0-P5 全量实施）
- `scripts/init_data.py` - 数据初始化向导（P0-P5 全量同步）

**删除文件：**
- `app/data/baostock.py` - BaoStockClient（已移除）
- `app/data/akshare.py` - AKShareClient（已移除）
- `app/data/pool.py` - 数据源池（已移除）

**修改文件：**
- `app/data/manager.py` - 改用 TushareClient，新增 sync_raw_daily/etl_daily 方法
- `app/data/etl.py` - 新增 transform_tushare_* 清洗函数，移除 clean_baostock_*/clean_akshare_* 函数
- `app/data/batch.py` - 重写为按日期批量模式
- `app/scheduler/jobs.py` - 适配按日期同步模式
- `app/config.py` - 新增 Tushare 配置项，移除 BaoStock/AKShare 配置

### 10.7 数据库迁移

**Alembic 迁移脚本：**
1. `f4daf202054a_add_p1_financial_raw_tushare_tables.py` - P1 财务原始表（10 张）
2. `67b6a3dd7ed3_add_p2_moneyflow_raw_tushare_tables.py` - P2 资金流向原始表（10 张）
3. 其他 P0 原始表迁移脚本

**迁移命令：**
```bash
# 升级到最新版本
uv run alembic upgrade head

# 查看当前版本
uv run alembic current

# 查看迁移历史
uv run alembic history
```

### 10.8 测试覆盖

**单元测试：**
- `tests/unit/test_tushare_client.py` - TushareClient 单元测试
- `tests/unit/test_etl.py` - ETL 清洗函数测试
- `tests/unit/test_token_bucket.py` - 令牌桶限流测试

**集成测试：**
- `tests/integration/test_post_market_incremental_update.py` - 盘后链路增量更新集成测试
- `tests/integration/test_p0_data_validation.py` - P0 核心数据校验测试（V2 再实施）
- `tests/integration/test_p1_data_validation.py` - P1 财务数据校验测试（V2 再实施）

**测试覆盖率：**
- 单元测试：354 个测试用例通过
- 集成测试：盘后链路端到端测试通过
- 功能测试：数据初始化向导、优雅关闭、自动数据更新测试通过

### 10.9 性能对比

| 指标 | 迁移前（BaoStock） | 迁移后（Tushare） | 提升 |
|:---|:---|:---|:---|
| 日线同步时间 | 2-3 小时 | 5-10 分钟 | 12-36 倍 |
| API 调用次数 | 5000+ 次 | 3-6 次 | 减少 99% |
| 数据完整性 | 85-90% | 95-98% | 提升 10% |
| 断点续传 | 不支持 | 支持 | ✅ |
| 数据溯源 | 不支持 | 支持（fetched_at） | ✅ |
| 财务数据 | 不支持 | 支持（VIP 接口） | ✅ |

### 10.10 已知问题和限制

**P2 资金流向数据：**
- ✅ V1 已完整实施（建表 + ORM 模型 + ETL 清洗 + 数据同步 + 盘后链路集成）
- ETL 函数：transform_tushare_moneyflow、transform_tushare_top_list
- DataManager 方法：sync_raw_moneyflow、sync_raw_top_list、etl_moneyflow
- 盘后链路：已集成到 run_post_market_chain，失败不阻断后续步骤

**数据校验测试：**
- ⚠️ 所有数据校验测试（P0/P1/P2）均在 V2 实施
- 原因：需要实际数据才能验证，V1 优先完成功能实现
- 替代方案：V1 使用手动验证和集成测试

**分钟线数据：**
- ⚠️ V1 不包含分钟线数据采集
- 原因：Tushare 分钟线接口需要更高积分，V1 优先日线数据
- 影响：分钟级策略和回测暂时无法使用

### 10.11 V2 待实施功能

**P3 指数数据同步：** ✅ 已完成
- ETL 清洗函数：6 个 transform 函数（index_basic, index_daily, index_weight, industry_classify, industry_member, index_technical）
- DataManager 方法：sync_raw_index_daily/weight/technical + etl_index（日常同步）、sync_raw_index_basic/industry_classify/industry_member + etl_index_static（静态数据）
- 盘后链路集成：步骤 3.6，失败不阻断后续链路
- 核心指数列表：10 个主流指数（上证综指、深证成指、创业板指、沪深300、中证500、中证1000 等）

**P4 板块数据同步：** ✅ 已完成
- ETL 清洗函数：3 个 transform 函数（concept_index、concept_daily、concept_member）
- DataManager 方法：sync_concept_index/daily/member + update_concept_indicators
- 业务表：concept_index、concept_daily、concept_member、concept_technical_daily
- 盘后链路集成：步骤 3.7，同步同花顺板块日线行情 + 计算技术指标，失败不阻断后续链路

**P5 扩展数据同步（全部已实施）：**
- 业务表：suspend_info（停复牌信息）、limit_list_daily（涨跌停统计）
- ETL 清洗函数：transform_tushare_suspend_d、transform_tushare_limit_list_d
- DataManager 方法：约 48 个 sync_raw 方法（日频 13+15 张 + 周频/月频 + 静态/季度 + 28 张补充表）+ etl_suspend/etl_limit_list + sync_p5_core 聚合方法
- 盘后链路集成：步骤 3.8，按频率分组调度（日频/周频/月频/静态/季度），失败不阻断后续链路
- 补充表同步：28 张补充表已全部接入 sync_p5_core（日频 15 张 + 月频 1 张 + 静态 12 张）

**数据校验测试：**
- P0 核心数据校验（6 个测试用例）
- P1 财务数据校验（5 个测试用例）
- P2 资金流向数据校验（5 个测试用例）
- P3 指数数据校验（6 个测试用例）
- P4 板块数据校验（6 个测试用例）
- P5 扩展数据校验（6 个测试用例）
- 综合数据校验（8 个测试用例）

**性能优化：** ✅ V2 已实施（Change 13）
- 使用 PostgreSQL COPY 协议替代 INSERT（速度提升 10 倍）— 临时表 + COPY + UPSERT 三步法，自动降级到 INSERT
- 全量导入前删除索引，导入后重建（速度提升 3-5 倍）— with_index_management 上下文管理器
- TimescaleDB 超表和压缩（节省 90% 空间）— 可选依赖，stock_daily/technical_daily 转超表，30 天自动压缩
- raw 表复合索引优化（P0-P3 核心表补充 ts_code+trade_date 复合索引）
- 连接池调优（pool_size 10, max_overflow 20）

**监控与日志增强：** ✅ V2 已实施（Change 14）
- 结构化日志：JSON 格式（生产环境）/ 文本格式（开发环境），日志轮转（50MB×5 + 错误日志 20MB×10）
- API 性能中间件：请求响应时间记录，慢请求告警（可配置阈值）
- 深度健康检查：`/health` 端点检测数据库、Redis、Tushare 可用性，返回组件级状态
- 任务执行日志：task_execution_log 表持久化调度任务执行历史，TaskLogger 自动记录，查询 API

### 10.12 迁移总结

**成功要素：**
1. ✅ 单一数据源简化了架构，提升了稳定性
2. ✅ raw 层解耦了数据获取和清洗，支持数据回溯
3. ✅ 按日期批量获取大幅提升了性能
4. ✅ 令牌桶限流避免了 API 限流问题
5. ✅ 断点续传机制保证了数据完整性
6. ✅ 数据初始化向导降低了使用门槛（P0-P5 全量同步 + CLI init-tushare 9 步）

**经验教训：**
1. 分阶段实施（P0 → P1 → P2）降低了风险
2. 保留 raw 层为后续优化留下了空间
3. 完善的测试覆盖保证了迁移质量
4. 详细的文档更新确保了知识传承

**后续计划：**
- V2 Phase 1：实施 P5 剩余 28 张补充表数据同步和 ETL（Change 11）
- V2 Phase 2：补全所有数据校验测试（P0-P5）
- V2 Phase 3：性能优化（COPY 协议、TimescaleDB）
