## Why

当前数据完整性检查存在严重缺陷：只检查交易日是否有任何数据，不检查每只股票的数据完整性；启动时不更新股票列表，导致新上市股票数据永久缺失；没有考虑股票的上市和退市日期。实际数据显示，最近交易日缺失 442 只股票数据（覆盖率仅 94%），419 只新上市股票从未有历史数据。这导致选股策略基于不完整数据运行，影响系统可靠性。

## What Changes

- 启动时先更新股票列表，确保使用最新的股票基本信息（包括新上市和退市股票）
- 增强数据完整性检查，从"检查日期是否存在"改为"逐只股票检查数据完整性"
- 考虑股票的上市日期和退市日期，只检查和补齐应该有数据的股票
- 每日增量同步前更新股票列表，确保新上市股票当天就被同步
- 新增新上市股票历史数据补齐功能，自动补齐最近上市股票的历史数据
- 批量同步失败股票自动重试机制，降低因网络抖动导致的数据缺失
- 智能过滤不应该有数据的股票（未上市、已退市、已停止更新的指数）

## Capabilities

### New Capabilities
- `stock-data-completeness-check`: 逐只股票检查数据完整性，考虑上市和退市日期
- `new-stock-history-backfill`: 新上市股票历史数据自动补齐
- `smart-stock-filtering`: 智能判断股票是否应该有数据（上市/退市/停止更新）
- `batch-sync-retry`: 批量同步失败股票自动重试机制

### Modified Capabilities
- `data-integrity-check`: 从"检查日期存在性"改为"检查数据完整性"，增加启动时更新股票列表
- `daily-sync`: 增加同步前更新股票列表，智能过滤不应该有数据的股票

## Impact

**受影响的代码**：
- `app/scheduler/core.py`: 启动时数据完整性检查逻辑
- `app/scheduler/jobs.py`: 盘后链路日线同步步骤
- `app/data/manager.py`: `detect_missing_dates` 方法需重构为 `detect_incomplete_dates`
- `app/data/batch.py`: 批量同步增加重试机制

**受影响的 API**：
- 无直接 API 变更，但数据完整性提升会改善所有依赖 stock_daily 数据的 API 响应质量

**受影响的依赖**：
- 无新增外部依赖

**受影响的系统**：
- 启动时间会增加（需要更新股票列表 + 更精确的完整性检查）
- 每日盘后链路时间会略微增加（需要更新股票列表）
- 数据库查询负载会增加（逐只股票检查）

**配置变更**：
- 新增配置项：`NEW_STOCK_HISTORY_BACKFILL_DAYS`（新股历史数据回溯天数，默认 30）
- 新增配置项：`BATCH_SYNC_MAX_RETRIES`（批量同步最大重试次数，默认 2）
- 新增配置项：`DATA_COMPLETENESS_THRESHOLD`（数据完整性阈值，默认 0.95）

**数据库变更**：
- 无表结构变更
- 查询模式变更：从 `SELECT DISTINCT trade_date` 改为逐日统计每只股票数据

**性能影响**：
- 启动时完整性检查：从 1-2 分钟增加到 2-5 分钟（取决于 `DATA_INTEGRITY_CHECK_DAYS`）
- 每日盘后链路：增加 10-30 秒（更新股票列表）
- 数据库查询：增加逐只股票统计查询，但通过索引优化可控制在可接受范围

**向后兼容性**：
- 完全向后兼容，无 breaking changes
- 现有配置项保持不变，新增配置项有合理默认值
- 可通过 `DATA_INTEGRITY_CHECK_ENABLED=false` 回退到旧逻辑
