## Context

当前系统的盘后链路（`run_post_market_chain()`）包含以下步骤：
1. 交易日校验
2. 日线数据同步
3. 技术指标计算
4. 缓存刷新
5. 策略管道执行

交易日历数据仅在周末任务（`sync_stock_list_job()`）中更新，导致以下问题：
- 系统在判断交易日时可能使用过期的交易日历数据
- 无法及时获取交易所公布的最新休市安排
- 依赖周末任务作为唯一的交易日历更新来源，缺乏冗余

BaoStock API 的 `query_trade_dates()` 接口支持查询未来 90 天的交易日历数据，`app/data/manager.py` 中的 `sync_trade_calendar()` 方法已实现相关逻辑（包括 UPSERT 和未来覆盖检查）。

## Goals / Non-Goals

**Goals:**
- 在每日盘后链路中添加交易日历更新步骤，确保交易日历数据保持最新
- 交易日历更新失败不阻断后续步骤（非关键步骤）
- 添加性能日志记录交易日历更新耗时
- 保留周末任务中的交易日历更新作为兜底机制

**Non-Goals:**
- 不修改 `sync_trade_calendar()` 的实现逻辑（已在 `app/data/manager.py` 中优化）
- 不修改交易日历的数据模型或存储方式
- 不添加交易日历更新的重试机制（依赖 BaoStock 客户端的重试逻辑）

## Decisions

### 决策 1：交易日历更新作为盘后链路的第一步

**选择：** 在交易日校验之前更新交易日历

**理由：**
- 确保交易日校验使用最新的交易日历数据
- 即使交易日历更新失败，也不影响后续步骤（因为数据库中已有历史数据）
- 逻辑顺序清晰：先更新元数据，再使用元数据

**备选方案：**
- 在交易日校验之后更新：会导致当日的交易日校验使用旧数据
- 作为独立的定时任务：增加调度复杂度，且无法保证在盘后链路之前执行

### 决策 2：交易日历更新失败不阻断后续步骤

**选择：** 交易日历更新失败时记录警告日志并继续执行

**理由：**
- 交易日历更新不是关键步骤，数据库中已有历史数据可用
- 避免因交易日历更新失败导致整个盘后链路中断
- 周末任务会作为兜底机制更新交易日历

**备选方案：**
- 更新失败时中断链路：过于严格，影响系统可用性
- 更新失败时重试：增加复杂度，且 BaoStock 客户端已有重试逻辑

### 决策 3：保留周末任务中的交易日历更新

**选择：** 不移除周末任务中的交易日历更新步骤

**理由：**
- 作为兜底机制，确保即使每日更新失败也能在周末补齐
- 周末任务的执行时间较为宽裕，可以处理更大的数据量
- 使用 UPSERT 逻辑，不会产生重复数据

**备选方案：**
- 移除周末任务中的更新：失去兜底机制，降低系统健壮性

### 决策 4：复用现有的 `sync_trade_calendar()` 方法

**选择：** 直接调用 `app/data/manager.py` 中已实现的 `sync_trade_calendar()` 方法

**理由：**
- 该方法已实现完整的逻辑（UPSERT、未来覆盖检查、性能日志）
- 避免代码重复
- 保持一致的错误处理和日志格式

**备选方案：**
- 实现新的轻量级更新方法：增加维护成本，且现有方法已足够高效

## Risks / Trade-offs

### 风险 1：每日盘后链路执行时间增加

**风险：** 交易日历更新会增加约 1-2 秒的执行时间

**缓解措施：**
- 交易日历更新是轻量级操作（查询和更新少量记录）
- 使用 UPSERT 避免重复插入
- 添加性能日志监控实际耗时

### 风险 2：BaoStock API 不稳定导致更新失败

**风险：** BaoStock API 可能不可用或返回错误数据

**缓解措施：**
- 交易日历更新失败不阻断后续步骤
- BaoStock 客户端已实现重试逻辑
- 周末任务作为兜底机制
- 数据库中已有历史数据可用

### 风险 3：未来交易日历数据不准确

**风险：** BaoStock 提供的未来交易日历可能与实际不符（如临时调整休市安排）

**缓解措施：**
- 每日更新确保数据及时刷新
- 系统在判断交易日时会查询数据库，使用最新数据
- 添加日志记录未来覆盖天数，便于监控

### Trade-off：每日更新 vs 按需更新

**选择：** 每日更新

**Trade-off：**
- 优点：数据始终保持最新，逻辑简单
- 缺点：即使交易日历未变化也会执行更新（但使用 UPSERT，性能影响可忽略）

## Migration Plan

### 部署步骤

1. **代码变更：**
   - 修改 `app/scheduler/jobs.py` 中的 `run_post_market_chain()` 函数
   - 提交 `app/data/manager.py` 和 `app/data/etl.py` 的已有修改

2. **测试验证：**
   - 单元测试：验证交易日历更新步骤的执行逻辑
   - 集成测试：验证盘后链路的完整流程
   - 手动测试：观察日志输出和数据库更新

3. **部署：**
   - 无需数据库迁移（表结构未变化）
   - 无需配置变更
   - 直接部署代码即可

### 回滚策略

如果交易日历更新导致问题：
1. 回滚代码到上一版本
2. 交易日历数据不会丢失（使用 UPSERT，不会删除数据）
3. 周末任务会继续更新交易日历

### 监控指标

- 交易日历更新耗时（通过性能日志）
- 交易日历更新成功率（通过日志统计）
- 未来交易日历覆盖天数（通过日志记录）

## Open Questions

无待解决的问题。所有技术决策已明确，实现路径清晰。
